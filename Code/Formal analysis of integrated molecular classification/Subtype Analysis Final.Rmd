---
title: "Subtype Analysis"
author: "Daniel Skubleny"
date: "20/07/2021"
output: html_document
---


#Compile final dataset
```{r}
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/ACRG_complete.csv'
ACRG_complete<-read.csv(urlfile)
ACRG_complete = ACRG_complete[,-1]

urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/TME_probability.csv'
TME_probability<-read.csv(urlfile)
TME_probability = TME_probability[,-1]
TME_probability = dplyr::select(TME_probability, c("patient_id", "TME_subtype","TME_subtype_cal", "High", "Low","High_cal", "Low_cal"))

urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/TCGA_probability.csv'
TCGA_probability<-read.csv(urlfile)
TCGA_probability = TCGA_probability[,-1]

complete_subtype = merge(TCGA_probability,TME_probability, by.x="patient_id" )
complete_subtype = merge(complete_subtype,ACRG_complete, by.x="patient_id")

complete_subtype$TCGA_subtype = as.factor(complete_subtype$TCGA_subtype)
complete_subtype$TME_subtype = as.factor(complete_subtype$TME_subtype)
complete_subtype$TME_subtype_cal = as.factor(complete_subtype$TME_subtype_cal)
complete_subtype$ebv_ish = as.factor(complete_subtype$ebv_ish)
complete_subtype$stage = as.factor(complete_subtype$stage)
complete_subtype$grade = as.factor(complete_subtype$grade)
complete_subtype$race = as.factor(complete_subtype$race)
complete_subtype$lauren_class = as.factor(complete_subtype$lauren_class)
complete_subtype$signet_ring = as.factor(complete_subtype$signet_ring)
complete_subtype$tumour_location = as.factor(complete_subtype$tumour_location)
complete_subtype$chemotherapy = as.factor(complete_subtype$chemotherapy)
complete_subtype$radiation = as.factor(complete_subtype$radiation)
complete_subtype$country = as.factor(complete_subtype$country)


complete_subtype[complete_subtype == "[Discrepancy]"] <- NA
complete_subtype[complete_subtype == "[Not Available]"] <- NA

complete_subtype$lauren_class <- str_replace_all(complete_subtype$lauren_class, c("diffuse" = "Diffuse", "intestinal" = "Intestinal", "intestine" = "Intestinal", "mixed" = "Mixed", "unknown" = "NA", "indeterminate" = "NA", "①diffuse/ ②diffuse/ ③intestinal" = "Other"))

complete_subtype$lauren_class <- ifelse(grepl("Intestinal", complete_subtype$lauren_class, ignore.case = T), "Intestinal", ifelse(grepl("Diffuse", complete_subtype$lauren_class, ignore.case = T), "Diffuse", ifelse(grepl("NA", complete_subtype$lauren_class, ignore.case = T), "NA", ifelse(grepl("Mixed", complete_subtype$lauren_class, ignore.case = T), "Mixed", ifelse(grepl("Not Other", complete_subtype$lauren_class, ignore.case = T), "Other", "NA")))))

complete_subtype$sex <- ifelse(grepl("F", complete_subtype$sex, ignore.case = T), "Female", ifelse(grepl("female", complete_subtype$sex, ignore.case = T), "Female", ifelse(grepl("male", complete_subtype$sex, ignore.case = T), "Male", ifelse(grepl("M", complete_subtype$sex, ignore.case = T), "Male","NA"))))

complete_subtype$grade <- str_replace_all(complete_subtype$grade, c("GX" = "Other"))

complete_subtype$signet_ring <- ifelse(grepl("No", complete_subtype$signet_ring, ignore.case = T), "No", ifelse(grepl("Other", complete_subtype$signet_ring, ignore.case = T), "Other", ifelse(grepl("Signet", complete_subtype$signet_ring, ignore.case = T), "Signet Ring", ifelse(grepl("Signet Ring ", complete_subtype$signet_ring, ignore.case = T), "Signet Ring ","NA"))))

complete_subtype$tumour_location_coarse <- dplyr::recode_factor(complete_subtype$tumour_location, 
                                                      'cardia to antrum' = "whole",
                                                      'antrum' = "Distal",
                                                      'Antrum/Distal' = "Distal",
                                                      'distal' = "Distal",
                                                      'body,antrum' = "Proximal",
                                                      'Fundus/Body' = "Proximal",
                                                      'mid' = "Proximal",
                                                      'fundus' = "Proximal",
                                                      'Cardia/Proximal' = "Proximal",
                                                      'body' = "Proximal",
                                                      'cardia' = "Proximal",
                                                      'Gastroesophageal Junction' = "Proximal")

complete_subtype$tumour_location_coarse <- ifelse(grepl("Distal", complete_subtype$tumour_location_coarse, ignore.case = T), "Distal",
                        ifelse(grepl("Proximal", complete_subtype$tumour_location_coarse, ignore.case = T), "Proximal",
                        ifelse(grepl("entire", complete_subtype$tumour_location_coarse, ignore.case = T), "Whole",
                        ifelse(grepl("whole", complete_subtype$tumour_location_coarse, ignore.case = T), "Whole", "NA"))))

complete_subtype$tumour_location <- dplyr::recode_factor(complete_subtype$tumour_location, 
                                                      'cardia to antrum' = "whole",
                                                      'antrum' = "Distal",
                                                      'Antrum/Distal' = "Distal",
                                                      'distal' = "Distal",
                                                      'body,antrum' = "Proximal",
                                                      'Fundus/Body' = "Proximal",
                                                      'mid' = "Proximal",
                                                      'fundus' = "Proximal",
                                                      'Cardia/Proximal' = "Proximal",
                                                      'body' = "Proximal",
                                                      'cardia' = "GEJ",
                                                      'Gastroesophageal Junction' = "GEJ")

complete_subtype$tumour_location <- ifelse(grepl("Distal", complete_subtype$tumour_location, ignore.case = T), "Distal",
                        ifelse(grepl("Proximal", complete_subtype$tumour_location, ignore.case = T), "Proximal",
                        ifelse(grepl("GEJ", complete_subtype$tumour_location, ignore.case = T), "GEJ",
                        ifelse(grepl("entire", complete_subtype$tumour_location, ignore.case = T), "Whole",
                        ifelse(grepl("whole", complete_subtype$tumour_location, ignore.case = T), "Whole", "NA")))))


complete_subtype[complete_subtype == "NA"] <- NA

complete_subtype <- complete_subtype %>% filter("tumour_location" != '[Discrepancy]') %>% droplevels()
complete_subtype <- complete_subtype %>% filter("tumour_location" != '[Not Available] ') %>% droplevels()
complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("Low", "High"))
```

#Censored and Uncensored exploratory analysis
```{r}
censoring_plot = ggplot(complete_subtype, aes(x=OS_time, fill=as.factor(OS_status))) +
        geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
        scale_fill_manual(name = "Event status",labels = c("Censored (No event)", "Uncensored (Death Event)"), values=c("#69b3a2", "#404080")) +
        labs(fill="") +
        annotate(geom="text", label="Percent Censored = 54.8%", x = 100, y = 175 , size= 4.25, hjust=0) +
        ggtitle("Histogram of survival events over time (n=2197)") +
        ylab("Frequency") +
        xlab("Overall Survival Time (Months)") +
        theme_bw() +
        theme(plot.title = element_text(colour="black", size=13)) +
            theme(axis.text.x = element_text(colour="black", size = 13)) +
            theme(axis.text.y = element_text(colour="black", size = 13)) +
            theme(axis.title.x = element_text(colour="black", size=13)) +
            theme(axis.title.y = element_text(colour="black", size=13)) +
            theme(legend.title = element_text(color = "black", size = 13),
                  legend.text = element_text(color = "black", size = 13),
                  legend.position = "bottom", 
                  legend.background = element_rect(size=0.5, linetype="solid", colour ="black"))

ggsave("censoring_plot.svg",censoring_plot, height = 4, width = 7)

#Calculate % censored 
table(complete_subtype$OS_status)[1]/length(complete_subtype$OS_status)*100

```

#Test PH assumptions
```{r}
cox.zph(interaction)
ggcoxzph(cox.zph(interaction))
ggcoxfunctional(Surv(OS_time, vital_status) ~  F82 , data = matched_F82_cont)
```


#Univariate subtype survival (discrete)
```{r}
library(ggpp)

#TCGA cox
TCGA_cox = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype)
summary(TCGA_cox)
survfit(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype)
summary(survfit(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype), times = 60)
tcga_km_survdiff = pairwise_survdiff(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype)
tcga_km_survdiff = as.data.frame(tcga_km_survdiff$p.value)

tcga_km_survdiff$STAD_CIN = round(tcga_km_survdiff$STAD_CIN, 4)
tcga_km_survdiff$STAD_EBV = round(tcga_km_survdiff$STAD_EBV, 4)
tcga_km_survdiff$STAD_GS = round(tcga_km_survdiff$STAD_GS, 4)
colnames(tcga_km_survdiff) = c("CIN", "EBV", "GS")
row.names(tcga_km_survdiff) = c("EBV", "GS", "MSI")
tcga_km_survdiff[tcga_km_survdiff==0] = "<0.0001"
tcga_km_survdiff = tibble::rownames_to_column(tcga_km_survdiff, " ")

tcga_km = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype), 
           risk.table=TRUE, 
           risk.table.y.text = FALSE, 
           pval= "Logrank test \n p < 0.0001", 
           pval.coord = c(0.1, 0.1),
           palette = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF"),
           risk.table.y.text.col = TRUE,
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           title = "Kaplan-Meier Curves for Univariate Cox Models",
           legend = c(0.7,0.85),
           legend.title = "TCGA Subtype",
           legend.labs=c("CIN", "EBV", "GS", "MSI"),
           font.legend = c(12, "plain", "black"),
           font.main = c(13, "plain", "black"),
           risk.table.fontsize = 4,
           surv.plot.height = 0.75,
           risk.table.height = 0.25)


tcga_km_pairwise = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype), 
           risk.table=TRUE, 
           risk.table.y.text = FALSE, 
           palette = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF"),
           risk.table.y.text.col = TRUE,
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           legend = c(0.7,0.85),
           legend.title = "TCGA Subtype",
           legend.labs=c("CIN", "EBV", "GS", "MSI"),
           font.legend = c(12, "plain", "black"),
           font.x = c(14, "plain", "black"),
           font.y = c(14, "plain", "black"),
           risk.table.fontsize = 4,
           surv.plot.height = 0.75,
           risk.table.height = 0.25)


tcga_km_pairwise$plot = tcga_km_pairwise$plot +    
          annotate(geom = "table",x = 0,y = 0,
                   label = list(cbind(tcga_km_survdiff)), 
                   table.theme = ttheme_gtsimple(base_size = 11,
                                                 parse = TRUE,
                                                 colhead = list(bg_params = list(fill = "white"),fg_params=list(fontface=1)))) +
          annotate(geom= "text", x = 0, y = 0, label = "Pairwise Logrank Tests (p value)", hjust=0,fontface=2, vjust=-7, size=4)


svg(filename="tcga_km_pairwise.svg", width=4.6, height=6)
tcga_km_pairwise
dev.off()

svg(filename="tcga_km.svg", width=4.6, height=6)
tcga_km
dev.off()



png(filename="tcga_km.png", width=4.6, height=6,units="in", res = 300)
tcga_km
dev.off()

#ACRG cox
ACRG_cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
summary(ACRG_cox)
survfit(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
survdiff(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
summary(survfit(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype), times = 60)
acrg_km_survdiff = pairwise_survdiff(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
acrg_km_survdiff = as.data.frame(acrg_km_survdiff$p.value)

acrg_km_survdiff$EMT = round(acrg_km_survdiff$EMT, 4)
acrg_km_survdiff$MSI = round(acrg_km_survdiff$MSI, 4)
acrg_km_survdiff$MSS_TP53neg = round(acrg_km_survdiff$MSS_TP53neg, 4)
colnames(acrg_km_survdiff) = c("EMT", "MSI", "MSS TP53-")
row.names(acrg_km_survdiff) = c("MSI", "MSS TP53-", "MSS TP53+")
acrg_km_survdiff[acrg_km_survdiff==0] = "<0.0001"
acrg_km_survdiff = tibble::rownames_to_column(acrg_km_survdiff, " ")

acrg_km = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype), 
           risk.table=TRUE, 
           risk.table.y.text = FALSE, 
           pval= "Logrank test \n p < 0.0001", 
           pval.coord = c(0.1, 0.1),
           palette = c("#A6CEE3", "#3C5488FF", "#8491B4FF", "#33A02C"),
           risk.table.y.text.col = TRUE,
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           title = " ",
           legend = c(0.7,0.85),
           legend.title = "ACRG Subtype",
           legend.labs=c("EMT", "MSI", "MSS TP53 Negative", "MSS TP53 Positive"),
           font.legend = c(12, "plain", "black"),
           font.main = c(13, "plain", "black"),
           risk.table.fontsize = 4,
           surv.plot.height = 0.75,
           risk.table.height = 0.25)

acrg_km_pairwise = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype), 
           risk.table=TRUE, 
           risk.table.y.text = FALSE, 
           palette = c("#A6CEE3", "#3C5488FF", "#8491B4FF", "#33A02C"),
           risk.table.y.text.col = TRUE,
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           legend = c(0.7,0.85),
           legend.title = "ACRG Subtype",
           legend.labs=c("EMT", "MSI", "MSS TP53 Negative", "MSS TP53 Positive"),
           font.legend = c(12, "plain", "black"),
           font.main = c(13, "plain", "black"),
           font.x = c(14, "plain", "black"),
           font.y = c(14, "plain", "black"),
           risk.table.fontsize = 4,
           surv.plot.height = 0.75,
           risk.table.height = 0.25)


acrg_km_pairwise$plot = acrg_km_pairwise$plot +    
          annotate(geom = "table",x = 0,y = 0,
                   label = list(cbind(acrg_km_survdiff)), 
                   table.theme = ttheme_gtsimple(base_size = 11,
                                                 parse = TRUE,
                                                 colhead = list(bg_params = list(fill = "white"),fg_params=list(fontface=1)))) +
          annotate(geom= "text", x = 0, y = 0, label = "Pairwise Logrank Tests (p value)", hjust=0,fontface=2, vjust=-7, size=4)

svg(filename="acrg_km_pairwise.svg", width=4.6, height=6)
acrg_km_pairwise
dev.off()

svg(filename="acrg_km.svg", width=4.6, height=6)
acrg_km
dev.off()

png(filename="acrg_km.png", width=4.6, height=6,units="in", res = 300)
acrg_km
dev.off()

         
  


TME_cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype, data = complete_subtype)
summary(TME_cox)

TME_cox_cal = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype)
summary(TME_cox_cal)
survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype)
survdiff(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype)
summary(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype), times = 60)
pairwise_survdiff(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype)

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("High", "Low"))


tme_km = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype), 
           risk.table=TRUE, 
           risk.table.y.text = FALSE, 
           pval= "Logrank test \n p < 0.0001", 
           pval.coord = c(0.1, 0.1),
           palette = c("#925E9FFF","#EFC000FF"),
           risk.table.y.text.col = TRUE,
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           legend = c(0.7,0.85),
           legend.title = "TME Subtype",
           legend.labs=c("High", "Low"),
           font.legend = c(12, "plain", "black"),
           font.main = c(13, "plain", "black"),
           font.x = c(14, "plain", "black"),
           font.y = c(14, "plain", "black"),
           risk.table.fontsize = 4,
           surv.plot.height = 0.75,
           risk.table.height = 0.25)


svg(filename="tme_km.svg", width=4.6, height=6)
tme_km
dev.off()

png(filename="tme_km.png", width=4.6, height=6,units="in", res = 300)
tme_km
dev.off()

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("Low", "High")) ###CHANGE LEVELS BACK


#REGRESSION TABLES
TME_cox_cal %>%
  tbl_regression(exponentiate = TRUE) 

TCGA_cox %>%
  tbl_regression(exponentiate = TRUE) 

ACRG_cox %>%
  tbl_regression(exponentiate = TRUE) 


```

#Univariate cont vs discrete subtype survival (continuous) vs discrete
```{r}
TCGA_cox_con = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN, data = complete_subtype)
summary(TCGA_cox_con)
anova(TCGA_cox, TCGA_cox_con)
extractAIC(TCGA_cox)
extractAIC(TCGA_cox_con)
TCGA_cox_aic = MuMIn::AICc(TCGA_cox)
TCGA_cox_con_aic = MuMIn::AICc(TCGA_cox_con)


ACRG_cox_con = coxph(Surv(OS_time, OS_status) ~ MSS_TP53neg + MSS_TP53pos + MSI + EMT, data = complete_subtype)
summary(ACRG_cox_con)
anova(ACRG_cox, ACRG_cox_con)
extractAIC(ACRG_cox)
extractAIC(ACRG_cox_con)

ACRG_cox_aic = MuMIn::AICc(ACRG_cox)
ACRG_cox_con_aic = MuMIn::AICc(ACRG_cox_con)

###Removed - used calibrated
#TME_cox_con = coxph(Surv(OS_time, OS_status) ~ High + Low , data = complete_subtype)
#summary(TME_cox_con)
#anova(TME_cox, TME_cox_con)
#extractAIC(TME_cox)
#extractAIC(TME_cox_con)
###Removed
TME_cox_con_cal = coxph(Surv(OS_time, OS_status) ~ High_cal + Low_cal , data = complete_subtype)
summary(TME_cox_con_cal)
anova(TME_cox_cal, TME_cox_con_cal)
extractAIC(TME_cox_cal)
extractAIC(TME_cox_con_cal)

TME_cox_cal_aic= MuMIn::AICc(TME_cox_cal)
TME_cox_con_cal_aic= MuMIn::AICc(TME_cox_con_cal)

all_subtype_cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype + TME_subtype + TCGA_subtype, data = complete_subtype) 
summary(all_subtype_cox)

all_subtype_con_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT, data = complete_subtype)
summary(all_subtype_con_cox)

anova(all_subtype_cox, all_subtype_con_cox)


all_subtype_cox_aic= MuMIn::AICc(all_subtype_cox)
all_subtype_con_cox_aic= MuMIn::AICc(all_subtype_con_cox)

#Compile AIC from models for comparison
a = c(TCGA_cox_aic,ACRG_cox_aic, TME_cox_cal_aic,all_subtype_cox_aic)
b = c(TCGA_cox_con_aic,ACRG_cox_con_aic, TME_cox_con_cal_aic,all_subtype_con_cox_aic)
aic_comparison = data.frame(a,b)
colnames(aic_comparison) = c("discrete", "continuous")
aic_comparison$difference = aic_comparison$continuous-aic_comparison$discrete
row.names(aic_comparison) = c("TCGA", "ACRG", "TME", "All Subtypes" )
aic_comparison$Model = c("TCGA", "ACRG", "TME", "All Subtypes" )


level_order = c("TCGA" , "ACRG", "TME", "All Subtypes")

#Make plot 
aic_plot = ggplot(aic_comparison, aes(x=difference, y = factor(Model, level=rev(level_order)))) +
      geom_bar(stat="identity", fill = "skyblue3", width = 0.75) +
      xlim(-22,22) + 
      geom_vline(xintercept = 0) + 
      ggtitle("Comparison of non-nested Cox Models") +
      xlab("Delta Akaike Information Criterion") + 
      ylab("Model Subtypes") +
      annotate("text", x = -11, y =-0.25, label = "Favours Continuous", size = 4.5) +
      annotate("text", x = 10, y =-0.25, label = "Favours Discrete", size = 4.5) +
      geom_segment(x = -21, y = -0.25, xend = -24, yend = -0.25,size = 0.25, arrow = arrow(length = unit(0.03, "npc"))) +
      geom_segment(x = 18, y = -0.25, xend = 21, yend = -0.25,size = 0.25, arrow = arrow(length = unit(0.03, "npc"))) +
      theme_classic()  + 
      theme(axis.text.x = element_text(colour="black", size = 16)) +
      theme(axis.text.y = element_text(colour="black",size = 16)) + 
      theme(plot.title = element_text(colour="black", size=16,hjust = 0)) +
      theme(axis.title.x = element_text(colour="black", size =16, vjust = -8, margin = ggplot2::margin(0, 0, 35, 0))) +
      theme(axis.title.y = element_text(colour="black", size=16)) +
      theme(legend.title = element_text(color = "black", size = 16),
        legend.text = element_text(color = "black", size = 16)) +
      coord_cartesian(ylim = c(1,4),clip="off")

ggsave("aic_plot.svg", aic_plot, width=6, height=4)

```

#Table one 
```{r}
library(tableone)
library(flextable)
str(complete_subtype)

## define custom test #############
fisher.test.simulate.p.values <- function(data, variable, by, ...) {
  result <- list()
  test_results <- stats::fisher.test(data[[variable]], data[[by]], simulate.p.value = TRUE)
  result$p <- test_results$p.value
  result$test <- test_results$method
  result
}
############################

tb_overall = tbl_summary(complete_subtype,
             percent = "column", 
             include=c("age","stage", "sex", "TCGA_subtype", "ACRG_subtype", "TME_subtype_cal", "study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse", "chemotherapy", "radiation")) %>% 
   remove_row_type(variables = everything(),type = "missing") %>% 
   add_n(col_label="**n/N (Missing %)**", statistic= "{n} / {N} ({p_miss}%)", add_footnote = "Percent") 
 
tb_overall_flex = as_flex_table(
  tb_overall,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("tb_overall" = tb_overall_flex,path = "#make file name")

################################################

########################################################
##NOTE fishers with simulations uses monte carlo simulations to estimate p values. 

 tb1 = tbl_summary(complete_subtype,
             by = "TCGA_subtype", 
             percent = "column", 
             include=c("age","stage", "sex", "study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse", "chemotherapy", "radiation")) %>% 
   add_p(test = c("study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse") ~"fisher.test.simulate.p.values" ) %>% 
   remove_row_type(variables = everything(),type = "missing") 

 tb1_flex = as_flex_table(
  tb1,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("tcga_table1" = tb1_flex,path = "#make file name")


##NOTE fishers with simulations uses monte carlo simulations to estimate p values. 

 tb2 = tbl_summary(complete_subtype,
             by = "ACRG_subtype", 
             percent = "column", 
             include=c("age","stage", "sex", "study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse", "chemotherapy", "radiation")) %>% 
   add_p(test = c("study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse") ~"fisher.test.simulate.p.values" ) %>% 
   remove_row_type(variables = everything(),type = "missing") 

 tb2_flex = as_flex_table(
  tb2,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("acrg_table2" = tb2_flex,path = "#make file name")

##NOTE fishers with simulations uses monte carlo simulations to estimate p values. 

 tb3 = tbl_summary(complete_subtype,
             by = "TME_subtype_cal", 
             percent = "column", 
             include=c("age","stage", "sex", "study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse", "chemotherapy", "radiation")) %>% 
   add_p(test = c("study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse") ~"fisher.test.simulate.p.values" ) %>% 
   remove_row_type(variables = everything(),type = "missing") 
 
tb3_flex = as_flex_table(
  tb3,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("tme_table1" = tb3_flex,path = "#make file name")
```
#Distirbutions of continuous probabilities 
```{r}
library(ggbeeswarm)
probabilities_long = dplyr::select(complete_subtype, c("STAD_CIN", "STAD_MSI","STAD_EBV", "STAD_GS","EMT", "MSI","MSS_TP53neg", "MSS_TP53pos","High_cal", "Low_cal"))

probabilities_long = tidyr::gather(probabilities_long, subtype, probability, STAD_CIN:Low_cal, factor_key=TRUE)

probabilities_long$subtype = factor(probabilities_long$subtype, c("STAD_CIN", "STAD_EBV", "STAD_GS","STAD_MSI", "EMT", "MSI", "MSS_TP53neg","MSS_TP53pos", "High_cal", "Low_cal"))

probabiility_distributions = ggplot(data = probabilities_long,aes(x = subtype, y = probability, fill = subtype))+
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=2.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.05,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + 
  scale_fill_manual(values = c("#F39B7FFF", "#91D1C2FF","#4DBBD5FF","#E64B35FF", "#A6CEE3", "#3C5488FF", "#8491B4FF", "#33A02C","#925E9FFF","#EFC000FF")) +
  scale_x_discrete(labels = c("CIN", "EBV", "GS","TCGA MSI", "EMT", "MSI", "MSS TP53-", "MSS TP53+", "High", "Low")) +
  ylab("Probability") + 
  ggtitle("Distiribution of Subtype Probability Scores") +
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 14,angle = 90, hjust=1, vjust=0.5))  +
  theme(axis.text.y = element_text(colour="black",size = 14)) + 
  theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=14)) +
  theme(legend.position = "none") 
    
ggsave("probabiility_distributions.svg", probabiility_distributions, width=10, height=5)


```


#Cox TME effect on TCGA and ACRG

```{r}
cox_model = as.data.frame(c("High", "High (cateogrical)"))

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("Low", "High"))


#CIN
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_CIN", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_CIN", ])
coef$mod2 = multi.cox$coefficients
cox_model$STAD_CIN = t(coef)

#EBV
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_EBV", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_EBV", ])
coef$mod2 = multi.cox$coefficients
cox_model$STAD_EBV = t(coef)

#MSI
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_MSI", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_MSI", ])
coef$mod2 = multi.cox$coefficients
cox_model$STAD_MSI = t(coef)

#GS
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_GS", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_GS", ])
coef$mod2 = multi.cox$coefficients
cox_model$STAD_GS = t(coef)

#ACRG MSI
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSI", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSI", ])
coef$mod2 = multi.cox$coefficients
cox_model$MSI = t(coef)

#MSSTP53neg
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSS_TP53neg", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSS_TP53neg", ])
coef$mod2 = multi.cox$coefficients
cox_model$MSS_TP53neg = t(coef)

#MSSTP53 pos
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSS_TP53pos", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="MSS_TP53pos", ])
coef$mod2 = multi.cox$coefficients
cox_model$MSS_TP53pos = t(coef)

#EMT
multi.cox = coxph(Surv(OS_time, OS_status) ~ High_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="EMT", ])
coef = as.data.frame(multi.cox$coefficients)

multi.cox = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$ACRG_subtype=="EMT", ])
coef$mod2 = multi.cox$coefficients
cox_model$EMT = t(coef)

colnames(cox_model) = c("Factor", "TCGA CIN", "TCGA EBV","TCGA MSI","TCGA GS","ACRG MSI","ACRG MSS TP53-","ACRG MSS TP53+","ACRG EMT")
cox_model = tibble::column_to_rownames(cox_model, "Factor")


#Horizontal
cox_heatmap = pheatmap(t(cox_model),col=rev(brewer.pal(8,"Greens")), cellheight = 25, cellwidth=25, treeheight_col = 0, fontsize = 12, breaks = seq(-1.433933,0, length.out = 10), angle_col = 45)

cox_heatmap = pheatmap(t(cox_model),col=rev(brewer.pal(8,"Greens")), cellheight = 25, cellwidth=25, treeheight_col = 0, fontsize = 16, breaks = seq(-1.433933,0, length.out = 10), angle_col = 45)

svg("cox_model.svg", width = 6, height = 4.5 )
cox_heatmap
dev.off()


png("cox_model.png", width = 6, height = 4.4, units="in", res=300 )
cox_heatmap
dev.off()

```
#COX high vs low for CIN
```{r}
summary(coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_CIN", ]))

ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_CIN", ]))

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("High", "Low"))

tme_cin_km = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_CIN", ]),
           pval= "Logrank test \n p < 0.0001", 
           pval.coord = c(0.1, 0.1),
           palette = c("#41AB5D", "skyblue3"),
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           title = "Effect of TME status on CIN Tumours",
           legend = c(0.7,0.85),
           legend.title = "Molecular subtype",
           legend.labs=c("CIN, TME High", "CIN, TME Low"),
           font.legend = c(12, "plain", "black"),
           font.main = c(14, "plain", "black"),
           surv.plot.height = 0.75)


svg(filename="tme_cin_km.svg", width=4, height=4)
tme_cin_km
dev.off()

png(filename="tme_cin_km.png", width=4, height=4,units="in", res = 300)
tme_cin_km
dev.off()

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("Low", "High")) ###CHANGE LEVELS BACK

```

#COX high vs low for MSI
```{r}
summary(coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_MSI", ]))

ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_MSI", ]))

complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("High", "Low"))

tme_msi_km = ggsurvplot(survfit(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype[complete_subtype$TCGA_subtype=="STAD_MSI", ]),
           pval= "Logrank test \n p < 0.0001", 
           pval.coord = c(0.1, 0.1),
           palette = c("#41AB5D","skyblue3"),
           break.time.by = 24,
           xlab = "Time (months)",
           ylab = "Overall survival probability",
           title = "Effect of TME status on MSI Tumours",
           legend = c(0.75,0.15),
           legend.title = "Molecular subtype",
           legend.labs=c("MSI, TME High", "MSI, TME Low"),
           font.legend = c(12, "plain", "black"),
           font.main = c(14, "plain", "black"),
           surv.plot.height = 0.75) 
           

svg(filename="tme_msi_km.svg", width=4, height=4)
tme_msi_km
dev.off()

png(filename="tme_msi_km.png", width=4, height=4,units="in", res = 300)
tme_msi_km
dev.off()


complete_subtype$TME_subtype_cal = factor(complete_subtype$TME_subtype_cal, levels = c("Low", "High")) ###CHANGE LEVELS BACK
```
#TME proportions
```{r}
tme_prop = as.data.frame(table(complete_subtype$TME_subtype,complete_subtype$TCGA_subtype))

ggplot(tme_prop, aes(fill=Var1, y=Freq, x=Var2)) +
  geom_bar(position="fill", stat="identity", alpha=0.8, width = 0.75, colour="black") + 
  coord_flip() + 
  scale_fill_manual("Factor 73", values = c("Low" = "skyblue3", "High" = "seagreen3")) + 
  ggtitle("ERBB2 Copy Number Variation Informed by Factor 73") +
  xlab("Copy Number Status") + 
  ylab("Proportion") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 10,angle = 45, hjust=1)) +
  theme(axis.text.y = element_text(colour="black",size = 10)) + 
  theme(plot.title = element_text(face="bold", colour="black", size=15,hjust = 0.5)) +
  theme(axis.title.x = element_text(colour="black", size =15)) +
  theme(axis.title.y = element_text(colour="black", size=15)) +
  theme(legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(color = "black", size = 12)) 

tme_prop_cal = as.data.frame(table(complete_subtype$TME_subtype_cal,complete_subtype$TCGA_subtype))

tme_prop_cal_plot = ggplot(tme_prop_cal, aes(fill=Var1, y=Freq, x=Var2)) +
  geom_bar(position="fill", stat="identity", alpha=0.8, width = 0.75, colour="black") + 
  coord_flip() + 
  scale_fill_manual("TME Subtype", values = c("Low" = "skyblue3", "High" = "seagreen3")) + 
  ggtitle("Proportion of TME Subtypes in TCGA Classification") +
  xlab("TCGA Class") + 
  ylab("Proportion") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 10,angle = 45, hjust=1)) +
  theme(axis.text.y = element_text(colour="black",size = 10)) + 
  theme(plot.title = element_text(face="bold", colour="black", size=15,hjust = 0.5)) +
  theme(axis.title.x = element_text(colour="black", size =15)) +
  theme(axis.title.y = element_text(colour="black", size=15)) +
  theme(legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(color = "black", size = 12)) 

ggsave("tme_prop_cal_plot.svg", tme_prop_cal_plot, width=6, height=5)



tme_prop_acrg = as.data.frame(table(complete_subtype$TME_subtype,complete_subtype$ACRG_subtype))

ggplot(tme_prop_acrg, aes(fill=Var1, y=Freq, x=Var2)) +
  geom_bar(position="fill", stat="identity", alpha=0.8, width = 0.75, colour="black") + 
  scale_fill_manual("Factor 73", values = c("Low" = "skyblue3", "High" = "seagreen3")) + 
  ggtitle("ERBB2 Copy Number Variation Informed by Factor 73") +
  xlab("Copy Number Status") + 
  ylab("Proportion") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 10,angle = 45, hjust=1)) +
  theme(axis.text.y = element_text(colour="black",size = 10)) + 
  theme(plot.title = element_text(face="bold", colour="black", size=15,hjust = 0.5)) +
  theme(axis.title.x = element_text(colour="black", size =15)) +
  theme(axis.title.y = element_text(colour="black", size=15)) +
  theme(legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(color = "black", size = 12)) 

tme_prop_acrg_cal = as.data.frame(table(complete_subtype$TME_subtype_cal,complete_subtype$ACRG_subtype))

tme_prop_acrg_cal_plot = ggplot(tme_prop_acrg_cal, aes(fill=Var1, y=Freq, x=Var2)) +
  geom_bar(position="fill", stat="identity", alpha=0.8, width = 0.75, colour="black") + 
  coord_flip() + 
  scale_fill_manual("TME Subtype", values = c("Low" = "skyblue3", "High" = "seagreen3")) + 
  ggtitle("Proportion of TME Subtypes in ACRG Classification") +
  xlab("ACRG Class") + 
  ylab("Proportion") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 10,angle = 45, hjust=1)) +
  theme(axis.text.y = element_text(colour="black",size = 10)) + 
  theme(plot.title = element_text(face="bold", colour="black", size=15,hjust = 0.5)) +
  theme(axis.title.x = element_text(colour="black", size =15)) +
  theme(axis.title.y = element_text(colour="black", size=15)) +
  theme(legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(color = "black", size = 12)) 

ggsave("tme_prop_acrg_cal_plot.svg", tme_prop_acrg_cal_plot, width=6, height=5)

library(RVAideMemoire)
fisher.test(complete_subtype$TCGA_subtype, complete_subtype$TME_subtype_cal)
test_TCGA = table(complete_subtype$TCGA_subtype, complete_subtype$TME_subtype_cal)
fisher.multcomp(test_TCGA, p.method = "BH")  

#TCGA
476/ (1155+476)
0.2918455 # CIN
82/(82+42)
0.6612903 #EBV
13/(176 +  13)
0.06878307 # GS
160/(98 + 160)
0.620155 #MSI

fisher.test(complete_subtype$ACRG_subtype, complete_subtype$TME_subtype_cal)
test_ACRG = table(complete_subtype$ACRG_subtype, complete_subtype$TME_subtype_cal)
fisher.multcomp(test_ACRG, p.method = "BH")  

#ACRG
17/(261+17)
[1] 0.06115108 #EMT
216/(216+156)
[1] 0.5806452 #MSI
229/(229+621)
[1] 0.2694118 #MSS TP53neg
269/(269+433)
[1] 0.3831909 #MSS TP53pos


TME_proportions_fisher = rbind(test_TCGA,test_ACRG)
fisher.multcomp(TME_proportions_fisher, p.method = "BH")  

TME_proportions_fisher_plot = rbind(tme_prop_cal,tme_prop_acrg_cal)
  

TME_proportions_fisher_plot$Var2 <- str_replace_all(TME_proportions_fisher_plot$Var2 , c("STAD_CIN" = "CIN", "STAD_EBV" = "EBV", "STAD_GS" = "GS","STAD_MSI" = "TCGA MSI", "EMT" = "EMT", "MSI" = "MSI", "MSS_TP53neg" = "MSS TP53-", "MSS_TP53pos" = "MSS TP53+"))
 
level_order = c("EBV" , "TCGA MSI", "MSI", "MSS TP53+","CIN", "MSS TP53-", "GS", "EMT")
level_order_rev = rev(level_order)


TME_proportions_fisher_plot$Var1 = factor(TME_proportions_fisher_plot$Var1, levels = c("High", "Low"))

tme_prop_allsubtypes = ggplot(TME_proportions_fisher_plot, aes(fill=Var1, y=Freq, x=factor(Var2, level=level_order_rev))) +
  geom_bar(position="fill", stat="identity", alpha=0.8, width = 0.75, colour="black") + 
  coord_flip() + 
  scale_fill_manual("TME Subtype", values = c("Low" = "skyblue3", "High" = "seagreen3")) + 
  ggtitle("Proportion of TME Subtypes per Class") +
  xlab("Subtype Class") + 
  ylab("Proportion") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 16)) +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16)) +
  theme(axis.title.x = element_text(colour="black", size =16)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.title = element_text(color = "black", size = 16),
        legend.position = "bottom",
        legend.text = element_text(color = "black", size = 16)) 

ggsave("tme_prop_allsubtypes.svg", tme_prop_allsubtypes, width=5.5, height=4)

```

#ALLUVIAL PLOT
```{r}
library(ggalluvial)
```
```{r}
#Dataframe 
alluvial_plot = dplyr::select(complete_subtype, c("TCGA_subtype", "ACRG_subtype", "TME_subtype_cal"))  


alluvial_plot = as.data.frame(table(complete_subtype$TCGA_subtype, complete_subtype$TME_subtype_cal, complete_subtype$ACRG_subtype))

#Check format
is_alluvia_form(as.data.frame(alluvial_plot), axes = 1:3, silent = TRUE)

#Fix colnames
colnames(alluvial_plot)[which(names(alluvial_plot) == "Var1")] <- "TCGA Subtype"
colnames(alluvial_plot)[which(names(alluvial_plot) == "Var2")] <- "TME Subtype"
colnames(alluvial_plot)[which(names(alluvial_plot) == "Var3")] <- "ACRG Subtype"



#Now order factors by best to worst survival with the class with the worst survival being the reference in the model
TCGA_cox = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype)
summary(TCGA_cox)

ACRG_cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
summary(ACRG_cox)

#Relevel by best to worst survival
alluvial_plot$`TCGA Subtype` <- factor(alluvial_plot$`TCGA Subtype`, levels = c("STAD_MSI", "STAD_EBV", "STAD_CIN", "STAD_GS"))

alluvial_plot$`TME Subtype` <- factor(alluvial_plot$`TME Subtype`, levels = c("High", "Low"))

alluvial_plot$`ACRG Subtype` <- factor(alluvial_plot$`ACRG Subtype`, levels = c("MSI", "MSS_TP53pos", "MSS_TP53neg", "EMT"))

alluvial_plot

alluvial_plot$`TCGA Subtype` <- str_replace_all(alluvial_plot$`TCGA Subtype` , c("STAD_CIN" = "CIN", "STAD_EBV" = "EBV", "STAD_GS" = "GS","STAD_MSI" = "MSI"))

alluvial_plot$`ACRG Subtype` <- str_replace_all(alluvial_plot$`ACRG Subtype`, c("MSS_TP53neg" = "MSS TP53-", "MSS_TP53pos" = "MSS TP53+"))


#FINAL ALLUVIAL
svg("alluvial_plot_allsubtypes.svg", width = 6, height = 5 )
ggplot(as.data.frame(alluvial_plot),
       aes(y = Freq, axis1 = alluvial_plot$`TCGA Subtype`, axis2 = alluvial_plot$`TME Subtype`, axis3 = alluvial_plot$`ACRG Subtype`)) +
  geom_alluvium(aes(fill = alluvial_plot$`TME Subtype`), width = 0.25,knot.pos = 0.3, alpha=0.55) +
  guides(fill = FALSE) +
  scale_x_discrete(limits = c("TCGA Subtype", "TME Subtype", "ACRG Subtype"), expand = c(.15, .15)) +
  scale_y_continuous(expand = c(0.005, 0.005)) +
  geom_stratum(alpha = 0, width = 0.25,color = "white",size=0.9) +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 5) +
    theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(colour="black", size = 14),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank()
  ) +
  theme(legend.position = "none") +
  ylab(NULL) + xlab(NULL) +
  scale_fill_manual(values = c("#1F78B4","#6A3D9A"))
dev.off()
```
#Probabilities heatmap
```{r}
prob_mat = dplyr::select(complete_subtype, c("patient_id","STAD_CIN","STAD_GS","STAD_EBV","STAD_MSI","High","Low","MSS_TP53neg","MSS_TP53pos","MSI","EMT" ))

prob_mat= tibble::column_to_rownames(prob_mat, "patient_id")

pheatmap(prob_mat)

prob_mat_cal = dplyr::select(complete_subtype, c("patient_id","STAD_CIN","STAD_GS","STAD_EBV","STAD_MSI","High_cal","Low_cal","MSS_TP53neg","MSS_TP53pos","MSI","EMT" ))

prob_mat_cal= tibble::column_to_rownames(prob_mat_cal, "patient_id")

pheatmap(prob_mat_cal)



cols = rev(brewer.pal(9, "RdBu"))


corr_heatmap_probabilityscores = pheatmap(prob_mat_cal,method = 'complete', color = colorRampPalette(cols)(100), cellwidth = 20 , angle_col = 45, show_rownames = FALSE)


svg(filename="heatmap_probabilityscores.svg", width=6.666668, height=10)
corr_heatmap_probabilityscores
dev.off()

png(filename="heatmap_probabilityscores.png", width=6.666668, height=10,units="in", res = 300)
corr_heatmap_probabilityscores
dev.off()

#Consider annotation of age, stage, grade, lauren class, signet ring, tumour location


table(complete_subtype$patient_id == rownames(prob_mat_cal)) #Check if the rownames match up with the original dataframe
annotate_col = dplyr::select(complete_subtype, c("age","study", "sex", "stage", "grade", "lauren_class" ,"signet_ring","tumour_location"))
annotate_col$study = as.factor(annotate_col$study)
annotate_col$sex = as.factor(annotate_col$sex)
annotate_col$stage = as.factor(annotate_col$stage)
annotate_col$grade = as.factor(annotate_col$grade)
annotate_col$lauren_class = as.factor(annotate_col$lauren_class)
annotate_col$signet_ring = as.factor(annotate_col$signet_ring)
annotate_col$tumour_location = as.factor(annotate_col$tumour_location)
annotate_col$age = as.numeric(annotate_col$age)
annotate_col = as.data.frame(annotate_col)
row.names(annotate_col) = complete_subtype$patient_id

annotate_col = dplyr::select(annotate_col, c("stage", "lauren_class" ,"signet_ring", "tumour_location"))
colnames(annotate_col) = c("Stage", "Lauren Class", "Signet Ring", "Tumour Location" )


ann_colors = list(
  Stage = c('I'="#F0F9E8", 'II'="#BAE4BC", "III"= "#7BCCC4", "IV"="#2B8CBE"),
  `Lauren Class`  = c('Diffuse'="#B2182B", 'Intestinal'="#67A9CF", "Mixed" = "#EF8A62"),
  `Signet Ring` = c('No'="#E5F5F9", 'Other'="#99D8C9", "Signet Ring"= "#2CA25F"),
  `Tumour Location` = c('Distal'="mediumpurple3", 'GEJ'="#BDC9E1","Proximal" = "#67A9CF","Whole" ="#02818A"))

colnames(prob_mat_cal) = c("CIN", "GS","EBV","TCGA_MSI", "TME High", "TME Low", "MSS TP53-", "MSS TP53+", "MSI" ,        "EMT"   )


corr_heatmap_annotated = pheatmap(t(prob_mat_cal),method = 'complete', color = colorRampPalette(cols)(1000), cellheight = 20, show_colnames = FALSE, annotation_col = annotate_col,annotation_colors = ann_colors, treeheight_row = 20, treeheight_col = 20)

corr_heatmap_annotated = pheatmap(t(prob_mat_cal),
                                  method = 'complete', 
                                  color = colorRampPalette(cols)(1000), 
                                  cellheight = 20,
                                  show_colnames = FALSE, 
                                  legend_breaks = c(0,0.2, 0.4, 0.6, 0.8, max(prob_mat_cal)),
                                  legend_labels = c("0", "0.2", "0.4", "0.6", "0.8", "Probability"),
                                  annotation_col = annotate_col,
                                  annotation_colors = ann_colors,
                                  fontsize = 11,
                                  treeheight_row = 20, 
                                  treeheight_col = 20)



svg(filename="corr_heatmap_annotated.svg", width=12, height=10)
corr_heatmap_annotated
dev.off()

png(filename="corr_heatmap_annotated.png", width=12, height=10,units="in", res = 600)
corr_heatmap_annotated
dev.off()

pdf("corr_heatmap_annotated.pdf")
corr_heatmap_annotated
dev.off()

```

#Heatmap heterogenity clusters
```{r}

library(clValid)
intern <- clValid(prob_mat_cal, 2:20,maxitems = 2202,metric = "euclidean", method = "complete", clMethods=c("hierarchical"),  validation="internal")
summary(intern)
plot(intern, legend=FALSE)

svg(filename="silhoutette.svg", width=4, height=4)
plot(intern, legend=FALSE)
dev.off()

corr_heatmap_annotated_cut = pheatmap(t(prob_mat_cal),
                                  method = 'complete', 
                                  color = colorRampPalette(cols)(1000), 
                                  cellheight = 20,
                                  show_colnames = FALSE, 
                                  legend_breaks = c(0,0.2, 0.4, 0.6, 0.8, max(prob_mat_cal)),
                                  legend_labels = c("0", "0.2", "0.4", "0.6", "0.8", "Probability"),
                                  annotation_col = annotate_col,
                                  annotation_colors = ann_colors,
                                  fontsize = 11,
                                  treeheight_row = 20, 
                                  treeheight_col = 20,
                                  cutree_cols = 11)

svg(filename="corr_heatmap_annotated_cut.svg", width=12, height=10)
corr_heatmap_annotated_cut
dev.off()

png(filename="corr_heatmap_annotated_cut.png", width=12, height=10,units="in", res = 600)
corr_heatmap_annotated_cut
dev.off()

pdf("corr_heatmap_annotated_cut.pdf")
corr_heatmap_annotated_cut
dev.off()

cutree(as.hclust(corr_heatmap_annotated$tree_col), 11)
clust_assess = complete_subtype
clust_assess$Cluster = as.factor(cutree(as.hclust(corr_heatmap_annotated$tree_col), 11))


clust_survival = coxph(Surv(OS_time, OS_status) ~ Cluster, data = clust_assess)
summary(clust_survival)
pairwise_survdiff(Surv(OS_time, OS_status) ~ Cluster, data = clust_assess)

svg(filename="clust_forest.svg", width=6, height=4)
forestmodel::forest_model(clust_survival,  format_options = forest_model_format_options(text_size = 5))
dev.off()



table(clust_assess$Cluster,clust_assess$stage)
chisq.test(table(clust_assess$Cluster,clust_assess$stage))

table(clust_assess$Cluster,clust_assess$lauren_class)
chisq.test(table(clust_assess$Cluster,clust_assess$lauren_class))

table(clust_assess$Cluster,clust_assess$signet_ring)
chisq.test(table(clust_assess$Cluster,clust_assess$signet_ring))

table(clust_assess$Cluster,clust_assess$tumour_location)
chisq.test(table(clust_assess$Cluster,clust_assess$tumour_location))



```

#COX Regression Tables
```{r}

TME_cox_cal = coxph(Surv(OS_time, OS_status) ~ TME_subtype_cal, data = complete_subtype)
TME_cox_cal %>% tbl_regression(exponentiate = TRUE)  %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "#make file name")

TCGA_cox = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype, data = complete_subtype)
TCGA_cox %>% tbl_regression(exponentiate = TRUE)  %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "#make file name")

ACRG_cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype, data = complete_subtype)
ACRG_cox %>% tbl_regression(exponentiate = TRUE) %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "#make file name")

multi.cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype + TME_subtype_cal +TCGA_subtype , data = complete_subtype) 
multi.cox %>% tbl_regression(exponentiate = TRUE) %>% add_global_p()%>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "#make file name")


multi.cox = coxph(Surv(OS_time, OS_status) ~ ACRG_subtype + TME_subtype_cal +TCGA_subtype + age + stage , data = complete_subtype) 
multi.cox %>% tbl_regression(exponentiate = TRUE) %>% add_global_p() %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "#make file name")

```

#Multivariate cox forest plot
```{r}
library(forestplot)

#From these models I entered relevant data into .txt file to make forest plot
#############NEW MODELS MARCH 23 2022################################
#####################################################################

#NOTE chemo_only_PS in Propensity score matched markdown
multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +age + stage + tumour_location_coarse + lauren_class + treatment + sex, data = chemo_only_PS)
summary(multivariate_cox)

multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +ns(age, df=2) + stage + tumour_location_coarse + lauren_class + treatment + sex, data = chemo_only_PS)
summary(multivariate_cox)

multivariate_cox_discrete = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype + ACRG_subtype +TME_subtype_cal +age + stage + tumour_location_coarse + lauren_class + treatment + sex, data = chemo_only_PS)
summary(multivariate_cox_discrete)
wald_mutli = car::Anova(multivariate_cox_discrete)
wald_mutli$adjustp = p.adjust(wald_mutli$`Pr(>Chisq)`, method="BH")

###STUDY INCLUDED SENSITIVITY ANALYSIS

multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +age + stage + tumour_location_coarse + lauren_class + study + treatment + sex, data = chemo_only_PS)
summary(multivariate_cox)

multivariate_cox_discrete = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype + ACRG_subtype +TME_subtype_cal +age + stage + tumour_location_coarse + lauren_class + study + treatment + sex, data = chemo_only_PS)
summary(multivariate_cox_discrete)
wald_mutli = car::Anova(multivariate_cox_discrete)
wald_mutli$adjustp = p.adjust(wald_mutli$`Pr(>Chisq)`, method="BH")


####################################################################
####################################################################

#From these models I entered relevant data into .txt file to make forest plot

#Note: *** < 0.001, ** < 0.01, * <0.05


#Imported table text                 
table_text <- read.delim("~/Documents/Research/Integrated molecular classification of gastric cancer/New R Code repo for rework/Data/multivariate_survival_forestplot_data_oct29.txt", header=FALSE)
table_text = as.matrix(table_text)
table_text = na_if(table_text, '')

table_data <- read.delim("~/Documents/Research/Integrated molecular classification of gastric cancer/New R Code repo for rework/Data/multivariate_survival_forestplot_data_oct29.txt")



subgps <- c(3,4,5,6,8,9,11,12,13,14,17,18,19,20,20,21,22,24,25,27,28,30,31,32,34,35,36,38,39,40,41)
table_text[subgps] <- paste("  ",table_text[subgps]) 

table_text = as.matrix(table_text[,-c(4:6)])
table_text_list = list(list(), list(), list())
        table_text_list[[1]] <- table_text[,1]
        table_text_list[[2]] <- table_text[,2]
        table_text_list[[3]] <- table_text[,3]
        table_text_list[[1]][15] <- list(expression(bold("Age")))
        table_text_list[[1]][16] <- list(expression(bold("Study")))
        table_text_list[[3]][15] <- list(expression(bold("<0.001***")))
        table_text_list[[1]][1] <- list(expression(bold("Variable")))
        table_text_list[[2]][1] <- list(expression(bold("HR (95% CI)")))
        table_text_list[[1]][2] <- list(expression(bold("TCGA Subtype")))
        table_text_list[[1]][7] <- list(expression(bold("TME Subtype")))
        table_text_list[[1]][10] <- list(expression(bold("ACRG Subtype")))
        table_text_list[[1]][23] <- list(expression(bold("Chemotherapy")))
        table_text_list[[1]][26] <- list(expression(bold("Sex")))
        table_text_list[[1]][29] <- list(expression(bold("Lauren Class")))
        table_text_list[[1]][33] <- list(expression(bold("Tumour Location")))
        table_text_list[[1]][37] <- list(expression(bold("Stage")))
        table_text_list[[3]][2] <- list(expression(bold("0.469")))
        table_text_list[[3]][7] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][10] <- list(expression(bold("0.257")))
        table_text_list[[3]][16] <- list(expression(bold("0.018*")))
        table_text_list[[3]][23] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][26] <- list(expression(bold("0.469")))
        table_text_list[[3]][29] <- list(expression(bold("0.010*")))
        table_text_list[[3]][33] <- list(expression(bold("0.511")))
        table_text_list[[3]][37] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][1] <- list(expression(bold(paste("Global Wald Test"^"1"))))



forestplot_final = forestplot(table_text_list, mean = cbind(c(NA, table_data$hazard)),lower = cbind(c(NA, table_data$lower)) ,upper = cbind(c(NA, table_data$upper)), 
           new_page = TRUE,
           zero = 1,
           colgap = unit(2,"mm"),
           lineheight = unit(5.75,"mm"),
           line.margin = unit(0.1,"mm"),
           graphwidth = unit(70,"mm"),
           boxsize = 0.6,
           align = c("l", "l", "l"),
           grid = structure((1), gp = gpar(col = "black", lty = 2, lwd = 1)),
           xlog=TRUE,
           vertices = TRUE,
           lwd.ci = 2,
           ci.vertices.height = 0.25,
           xticks = log(c(0.3, 0.6, 1, 2, 5,12)), 
           col = fpColors(box = "skyblue3", lines = "skyblue3"),
           txt_gp = fpTxtGp(label = gpar(ps= 7, align ="left"),
                            ticks = gpar(ps= 7, cex = 1),
                            xlab = gpar(ps= 7, cex = 1)),
           hrzl_lines = list("2" = gpar(lwd = 1, columns = 1:4, col = "black"), 
                            "42" = gpar(lwd = 1, columns = 1:3, col = "black")),
           xlab  = "Hazard Ratio (95% CI)")


svg("forestplot_multivar_global_final_rework.svg", width=12, height=10)
forestplot_final
dev.off()

```
#Original Forest plot 
```{r}

#From these models I entered relevant data into .txt file to make forest plot

#Note: *** < 0.001, ** < 0.01, * <0.05


#Imported table text                 
table_text <- read.delim("~/Documents/R projects/TCGA Draft 2/multivariate_survival_forestplot_data_mar25.txt", header=FALSE)
table_text = as.matrix(table_text)
table_text = na_if(table_text, '')

table_data <- read.delim("~/Documents/R projects/TCGA Draft 2/multivariate_survival_forestplot_data_mar25.txt")

subgps <- c(3,4,5,6,8,9,11,12,13,14,17,18,20,21,23,24,25,27,28,29,31,32,33,34)
table_text[subgps] <- paste("  ",table_text[subgps]) 

table_text = as.matrix(table_text[,-c(4:6)])
table_text_list = list(list(), list(), list())
        table_text_list[[1]] <- table_text[,1]
        table_text_list[[2]] <- table_text[,2]
        table_text_list[[3]] <- table_text[,3]
        table_text_list[[1]][15] <- list(expression(bold("Age")))
        table_text_list[[3]][15] <- list(expression(bold("<0.001***")))
        table_text_list[[1]][1] <- list(expression(bold("Variable")))
        table_text_list[[2]][1] <- list(expression(bold("HR (95% CI)")))
        table_text_list[[1]][2] <- list(expression(bold("TCGA Subtype")))
        table_text_list[[1]][7] <- list(expression(bold("TME Subtype")))
        table_text_list[[1]][10] <- list(expression(bold("ACRG Subtype")))
        table_text_list[[1]][16] <- list(expression(bold("Chemotherapy")))
        table_text_list[[1]][19] <- list(expression(bold("Sex")))
        table_text_list[[1]][22] <- list(expression(bold("Lauren Class")))
        table_text_list[[1]][26] <- list(expression(bold("Tumour Location")))
        table_text_list[[1]][30] <- list(expression(bold("Stage")))
        table_text_list[[3]][2] <- list(expression(bold("0.281")))
        table_text_list[[3]][7] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][10] <- list(expression(bold("0.146")))
        table_text_list[[3]][16] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][19] <- list(expression(bold("0.566")))
        table_text_list[[3]][22] <- list(expression(bold("0.011*")))
        table_text_list[[3]][26] <- list(expression(bold("0.391")))
        table_text_list[[3]][30] <- list(expression(bold("<0.001***")))
        table_text_list[[3]][1] <- list(expression(bold(paste("Global Wald Test"^"1"))))



forestplot_final = forestplot(table_text_list, mean = cbind(c(NA, table_data$hazard)),lower = cbind(c(NA, table_data$lower)) ,upper = cbind(c(NA, table_data$upper)), 
           new_page = TRUE,
           zero = 1,
           colgap = unit(2,"mm"),
           lineheight = unit(5.75,"mm"),
           line.margin = unit(0.1,"mm"),
           graphwidth = unit(70,"mm"),
           boxsize = 0.6,
           align = c("l", "l", "l"),
           grid = structure((1), gp = gpar(col = "black", lty = 2, lwd = 1)),
           xlog=TRUE,
           vertices = TRUE,
           lwd.ci = 2,
           ci.vertices.height = 0.25,
           xticks = c(log(0.3), log(0.6), log(1), log(2), log(4),log(10)), 
           col = fpColors(box = "skyblue3", lines = "skyblue3"),
           txt_gp = fpTxtGp(label = gpar(ps= 7, align ="left"),
                            ticks = gpar(ps= 7, cex = 1),
                            xlab = gpar(ps= 7, cex = 1)),
           hrzl_lines = list("2" = gpar(lwd = 1, columns = 1:4, col = "black"), 
                            "35" = gpar(lwd = 1, columns = 1:3, col = "black")),
           xlab  = "Hazard Ratio (95% CI)")

e^y = 0.8000348

svg("forestplot_multivar_global_final_check.svg", width=12, height=10)
forestplot_final
dev.off()

```
#Sensitivity analysis COX
```{r}
#Without Samsung

multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +age + stage + tumour_location_coarse + lauren_class + treatment + sex, data = chemo_only_PS[!chemo_only_PS$study=="Samsung",])
summary(multivariate_cox)


multivariate_cox_discrete = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype + ACRG_subtype +TME_subtype_cal +age + stage + tumour_location_coarse + lauren_class + treatment + sex, data = chemo_only_PS[!chemo_only_PS$study=="Samsung",])
summary(multivariate_cox_discrete)
wald_mutli = car::Anova(multivariate_cox_discrete)
wald_mutli$adjustp = p.adjust(wald_mutli$`Pr(>Chisq)`, method="BH")


multivariate_cox %>% tbl_regression(exponentiate = TRUE)  %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "/Users/danielskubleny/Documents/R projects/TCGA Draft 2/multi_cox_sensitivity_nosamsung.docx")

#With study

multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +age + stage + tumour_location_coarse + lauren_class + treatment + sex + study, data = chemo_only_PS)
summary(multivariate_cox)

multivariate_cox_discrete = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype + ACRG_subtype +TME_subtype_cal +age + stage + tumour_location_coarse + lauren_class + treatment + sex + study, data = chemo_only_PS)
summary(multivariate_cox_discrete)
wald_mutli = car::Anova(multivariate_cox_discrete)
wald_mutli$adjustp = p.adjust(wald_mutli$`Pr(>Chisq)`, method="BH")

multivariate_cox %>% tbl_regression(exponentiate = TRUE)  %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "/Users/danielskubleny/Documents/R projects/TCGA Draft 2/multi_cox_sensitivity_study.docx")


#With sutdy Without Samsung

multivariate_cox = coxph(Surv(OS_time, OS_status) ~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT +age + stage + tumour_location_coarse + lauren_class + treatment + sex + study, data = chemo_only_PS[!chemo_only_PS$study=="Samsung",])
summary(multivariate_cox)


multivariate_cox_discrete = coxph(Surv(OS_time, OS_status) ~ TCGA_subtype + ACRG_subtype +TME_subtype_cal +age + stage + tumour_location_coarse + lauren_class + treatment + sex + study, data = chemo_only_PS[!chemo_only_PS$study=="Samsung",])
summary(multivariate_cox_discrete)
wald_mutli = car::Anova(multivariate_cox_discrete)
wald_mutli$adjustp = p.adjust(wald_mutli$`Pr(>Chisq)`, method="BH")


multivariate_cox %>% tbl_regression(exponentiate = TRUE)  %>% 
  as_flex_table(
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE) %>%
  save_as_docx(path = "/Users/danielskubleny/Documents/R projects/TCGA Draft 2/multi_cox_sensitivity_study_nosamsung.docx")

```

#EBV check
```{r}
table(complete_subtype$TCGA_subtype, complete_subtype$ebv_ish)

plot(complete_subtype$TCGA_subtype, complete_subtype$ebv_ish)
plot(complete_subtype$TCGA_subtype, complete_subtype$STAD_EBV)


```
```{r}
library(pROC)
#LR model for predicting EBV from probabilities
ebv_check = complete_subtype
ebv_check = ebv_check[!is.na(ebv_check$ebv_ish),] 
ebv_check$EBV_center = scale(ebv_check$STAD_EBV, center = TRUE, scale = TRUE)


#Final analysis
glmfit = glm(ebv_check$ebv_ish~ebv_check$EBV_center, family=binomial(link="logit"))



exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

ebv_check$prob_glm_fit = prob

roc_glmfit_ebv = roc(ebv_check$ebv_ish~ ebv_check$prob_glm_fit)
plot(roc_glmfit_ebv)
auc(roc_glmfit_ebv)
ci(roc_glmfit_ebv)

#LR model AUC 9972 (0.994-1) for EBV ISH based on STAD_EBV probabilities extracted from model. 


#Sensitivity analysis
glmfit = glm(ebv_ish~EBV_center,data = ebv_check[ebv_check$study=="ACRG",], family=binomial(link="logit"))
summary(glmfit)

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

ebv_check[ebv_check$study=="ACRG",]$prob_glm_fit = prob

roc_glmfit_ebv = roc(ebv_check[ebv_check$study=="ACRG",]$ebv_ish~ ebv_check[ebv_check$study=="ACRG",]$prob_glm_fit)
plot(roc_glmfit_ebv)
auc(roc_glmfit_ebv)
ci(roc_glmfit_ebv)

glmfit = glm(ebv_ish~EBV_center,data = ebv_check[ebv_check$study=="TCGA",], family=binomial(link="logit"))
summary(glmfit)

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

ebv_check[ebv_check$study=="TCGA",]$prob_glm_fit = prob

roc_glmfit_ebv = roc(ebv_check[ebv_check$study=="TCGA",]$ebv_ish~ ebv_check[ebv_check$study=="TCGA",]$prob_glm_fit)
plot(roc_glmfit_ebv)
auc(roc_glmfit_ebv)
ci(roc_glmfit_ebv)

#Final analysis
glmfit = glm(ebv_check$ebv_ish~ebv_check$EBV_center, family=binomial(link="logit"))



exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

ebv_check$prob_glm_fit = prob

roc_glmfit_ebv = roc(ebv_check$ebv_ish~ ebv_check$prob_glm_fit)
plot(roc_glmfit_ebv)
auc(roc_glmfit_ebv)
ci(roc_glmfit_ebv)

#LR model AUC 9972 (0.994-1) for EBV ISH based on STAD_EBV probabilities extracted from model.
```
#Plot EBV AUC  
```{r}
ebv_auc = ggroc(list(roc_glmfit_ebv), linetype = 1, size = 1.4) + 
                xlab("Specificity") +
                ylab("Sensitivity") +
                ggtitle("ROC EBV ISH informed by model probability") +
                geom_abline(intercept = 1, slope = 1, linetype = 2) +
                scale_colour_manual(name="Logistic Regression Model",labels = c("TCGA EBV (AUC = 0.997 [95% CI: 0.994-1])"), values = c("#91D1C2FF")) +
                theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.55,0.08),
                      legend.background = element_rect(size=0.5, linetype="solid",colour ="black", fill=alpha("white",0.7))) + 
    guides(colour = guide_legend("Logistic Regression Model"))
        
ggsave("ebv_auc.svg", ebv_auc, width=5, height=5)
ggsave("ebv_auc.png", ebv_auc, width=5, height=5)
```

#pheno_ACRG_MLH
```{r}
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/pheno_data_ACRG.csv'
pheno_ACRG_MSI<-read.csv(urlfile)


urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/pdata_acrg.csv'
pdata_acrg<-read.csv(urlfile)
pdata_acrg = pdata_acrg[,-1]

```
```{r}
#Note: pdata_acrg available on gituhb 
pheno_ACRG_MSI = merge(pdata_acrg,pheno_ACRG_MSI, by.x="Tumor.ID", all=TRUE)
colnames(pheno_ACRG_MSI)[which(names(pheno_ACRG_MSI) == "MLH1.IHC")] <- "MLH1_ihc"
pheno_ACRG_MSI = dplyr::select(pheno_ACRG_MSI, c("patient_id","MLH1_ihc"))

pheno_ACRG_MSI$MLH1_ihc <- str_replace_all(pheno_ACRG_MSI$MLH1_ihc, c("negative" = "Negative", "positive" = "Positive","partial loss" = "Other"))

pheno_ACRG_MSI$MLH1_ihc <- ifelse(grepl("Negative", pheno_ACRG_MSI$MLH1_ihc , ignore.case = T), "Negative",
                                  ifelse(grepl("Positive", pheno_ACRG_MSI$MLH1_ihc , ignore.case = T), "Positive",
                                  ifelse(grepl("Other", pheno_ACRG_MSI$MLH1_ihc , ignore.case = T), "Other", "Positive")))


```
#CNV and mutations from ACRG
```{r}
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/mutations_ACRG.csv'
mutations_ACRG<-read.csv(urlfile)

```
```{r}
colnames(mutations_ACRG)[which(names(mutations_ACRG) == "sample")] <- "Tumor.ID"
colnames(mutations_ACRG)[which(names(mutations_ACRG) == "MSI.h.assay.status...16..")] <- "MSI_analysis"
colnames(mutations_ACRG)[which(names(mutations_ACRG) == "EBV...6..")] <- "ebv_status"
colnames(mutations_ACRG)[which(names(mutations_ACRG) == "X..mutations")] <- "mutation_burden"

mutations_ACRG = merge(pdata_acrg,mutations_ACRG, by.x="Tumor.ID", all=TRUE)

mutations_ACRG = dplyr::select(mutations_ACRG, c("patient_id","MSI_analysis","ebv_status","mutation_burden"))

mutations_ACRG = merge(mutations_ACRG,complete_subtype,by="patient_id", all=TRUE )

mutations_ACRG$MSI_analysis = as.factor(mutations_ACRG$MSI_analysis)
mutations_ACRG$ACRG_subtype = as.factor(mutations_ACRG$ACRG_subtype)
mutations_ACRG$ebv_status = as.factor(mutations_ACRG$ebv_status)
mutations_ACRG$mutation_burden = as.numeric(mutations_ACRG$mutation_burden)

#MSI status ACRG
table(mutations_ACRG$TCGA_subtype, mutations_ACRG$MSI_analysis)
plot(mutations_ACRG$TCGA_subtype, mutations_ACRG$MSI_analysis)
plot(mutations_ACRG$MSI_analysis, mutations_ACRG$STAD_MSI)

table(mutations_ACRG$ACRG_subtype, mutations_ACRG$MSI_analysis)
plot(mutations_ACRG$ACRG_subtype, mutations_ACRG$MSI_analysis)
plot(mutations_ACRG$MSI_analysis, mutations_ACRG$MSI)
#ACRG specific EBV
table(mutations_ACRG$TCGA_subtype, mutations_ACRG$ebv_status)
plot(mutations_ACRG$TCGA_subtype, mutations_ACRG$ebv_status)
plot(mutations_ACRG$ebv_status, mutations_ACRG$STAD_EBV)

#Mutations burden
table(mutations_ACRG$TCGA_subtype, mutations_ACRG$mutation_burden)
table(mutations_ACRG$ACRG_subtype, mutations_ACRG$mutation_burden)
plot(mutations_ACRG$TCGA_subtype, mutations_ACRG$mutation_burden)
plot(mutations_ACRG$ACRG_subtype, mutations_ACRG$mutation_burden)

plot(mutations_ACRG$mutation_burden, mutations_ACRG$MSI)
plot(mutations_ACRG$mutation_burden, mutations_ACRG$STAD_MSI)

plot(as.factor(mutations_ACRG$TME_subtype), mutations_ACRG$mutation_burden)
plot(mutations_ACRG$mutation_burden, mutations_ACRG$High)

summary(lm(mutations_ACRG$mutation_burden~mutations_ACRG$STAD_MSI))


```
#CNV GI from ACRG
```{r}
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/CNV_GI_data.csv'
CNV_GI<-read.csv(urlfile)

```
```{r}
colnames(CNV_GI)[which(names(CNV_GI) == "sample")] <- "Tumor.ID"
colnames(CNV_GI)[which(names(CNV_GI) == "CNV.GI...28..")] <- "CNV_GI"

CNV_GI = merge(pdata_acrg,CNV_GI, by.x="Tumor.ID", all=TRUE)

CNV_GI = dplyr::select(CNV_GI, c("patient_id","CNV_GI"))

CNV_GI = merge(CNV_GI,complete_subtype,by="patient_id", all=TRUE )

CNV_GI$CNV_GI = as.factor(CNV_GI$CNV_GI)
CNV_GI$ACRG_subtype = as.factor(CNV_GI$ACRG_subtype)

table(CNV_GI$TCGA_subtype, CNV_GI$CNV_GI)
table(CNV_GI$ACRG_subtype, CNV_GI$CNV_GI)
plot(CNV_GI$TCGA_subtype, CNV_GI$CNV_GI)
plot(CNV_GI$TME_subtype, CNV_GI$CNV_GI)
plot(CNV_GI$CNV_GI, CNV_GI$STAD_CIN)

plot(CNV_GI$ACRG_subtype, CNV_GI$CNV_GI)
plot(CNV_GI$CNV_GI, CNV_GI$MSS_TP53neg)
plot(CNV_GI$CNV_GI, CNV_GI$MSS_TP53pos)
```
```{r}
#LR model for predicting CNV GI from STAD_CIN, MSS_tp53neg from probabilities
#MSSTP53neg
CNV_GI_LR = CNV_GI
CNV_GI_LR = CNV_GI_LR[!is.na(CNV_GI_LR$CNV_GI),] 

glmfit = glm(CNV_GI_LR$CNV_GI ~ CNV_GI_LR$MSS_TP53neg, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

CNV_GI_LR$prob_glm_fit = prob

roc_glmfit_MSS_TP53neg = roc(CNV_GI_LR$CNV_GI~ CNV_GI_LR$prob_glm_fit)
plot(roc_glmfit_MSS_TP53neg)
auc(roc_glmfit_MSS_TP53neg)
ci(roc_glmfit_MSS_TP53neg)

#STAD_CIN
glmfit = glm(CNV_GI_LR$CNV_GI ~ CNV_GI_LR$STAD_CIN, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

CNV_GI_LR$prob_glm_fit = prob

roc_glmfit_STADCIN = roc(CNV_GI_LR$CNV_GI~ CNV_GI_LR$prob_glm_fit)
plot(roc_glmfit_STADCIN)
auc(roc_glmfit_STADCIN)
ci(roc_glmfit_STADCIN)
```
#Plot CNV GI ROC
```{r}
auc_cnv = ggroc(list(roc_glmfit_STADCIN,roc_glmfit_MSS_TP53neg), linetype = 1, size = 1.4) +
                xlab("Specificity") +
                ylab("Sensitivity") +
                ggtitle("AUC CNV GI Score informed by model probability") +
                geom_abline(intercept = 1, slope = 1, linetype = 2) +
                scale_colour_manual(name="Logistic Regression Model",labels = c("TCGA CIN (AUC = 0.86 [95% CI: 0.80-0.92])", "ACRG MSS TP53- (AUC = 0.73 [95% CI: 0.66-0.81])"), values = c("#91D1C2FF", "#8491B4FF")) +
                theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.65,0.15),
                      legend.background = element_rect(size=0.5, linetype="solid",colour ="black")) 



```

#TCGA Mantis Score
```{r}
#MSI analysis from initial TCGA study
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/data_clinical_sample_mantis.txt'
tcga_msi_status<-read.delim(urlfile, comment.char="#")
```
```{r}
colnames(tcga_msi_status)[which(names(tcga_msi_status) == "PATIENT_ID")] <- "patient_id"
tcga_msi_status = dplyr::select(tcga_msi_status, c("patient_id","MLH1_SILENCING", "MSI_STATUS"))


```
#MSI_check
```{r}
MSI_check = complete_subtype
MSI_check = merge(pheno_ACRG_MSI,complete_subtype,by="patient_id", all=TRUE )
#MSI_check = merge(tcga_MSI,MSI_check,by="patient_id", all=TRUE )
MSI_check = merge(tcga_msi_status,MSI_check,by="patient_id", all=TRUE )
msi_acrg = dplyr::select(mutations_ACRG, c("patient_id", "MSI_analysis" ))
msi_acrg$MSI_analysis = str_replace_all(msi_acrg$MSI_analysis, c("0" = "MSI-L/MSS", "1" = "MSI-H"))
MSI_check = merge(msi_acrg,MSI_check,by="patient_id", all=TRUE )


table(duplicated(MSI_check$patient_id))
table(is.na(MSI_check$patient_id))
MSI_check$MLH1_ihc = as.factor(MSI_check$MLH1_ihc)
MSI_check$ACRG_subtype = as.factor(MSI_check$ACRG_subtype)
MSI_check$MLH1_SILENCING = as.factor(MSI_check$MLH1_SILENCING)
MSI_check$MSI_STATUS = as.factor(MSI_check$MSI_STATUS)



MSI_check$MSI_STATUS_high = ifelse(grepl("MSI-H", MSI_check$MSI_STATUS, ignore.case = T), "MSI-H", 
                            ifelse(grepl("MSI-L", MSI_check$MSI_STATUS, ignore.case = T), "MSI-L/MSS",
                            ifelse(grepl("MSS", MSI_check$MSI_STATUS, ignore.case = T), "MSI-L/MSS", "NA")))       
MSI_check$MSI_STATUS_high = na_if(MSI_check$MSI_STATUS_high, "NA")
MSI_check$MSI_STATUS_high = factor(MSI_check$MSI_STATUS_high)                                   
MSI_check$MSI_STATUS_high = as.factor(MSI_check$MSI_STATUS_high)
MSI_check = MSI_check[!is.na(MSI_check$TCGA_subtype),] 


x = MSI_check$MSI_analysis
y = MSI_check$MSI_STATUS_high
MSI_pcr = coalesce(x,y)
MSI_pcr = as.data.frame(MSI_pcr)
MSI_pcr$patient_id = MSI_check$patient_id
MSI_check = merge(MSI_pcr,MSI_check,by="patient_id", all=TRUE )



plot(MSI_check$MLH1_ihc, MSI_check$STAD_MSI)
plot(MSI_check$MLH1_ihc, MSI_check$MSI)
MSI_check$MLH1_ihc = na_if(MSI_check$MLH1_ihc, "Other")
MSI_check$MLH1_ihc = factor(MSI_check$MLH1_ihc)
kruskal.test(MSI_check$MLH1_ihc, MSI_check$MSI)
kruskal.test(MSI_check$MLH1_ihc, MSI_check$STAD_MSI)

```

```{r}
plot(MSI_check$STAD_MSI, MSI_check$MSI_SCORE_MANTIS)
plot(MSI_check$MSI, MSI_check$MSI_SCORE_MANTIS)


plot(MSI_check$TCGA_subtype, MSI_check$MSI_SCORE_MANTIS)
plot(MSI_check$ACRG_subtype, MSI_check$MSI_SCORE_MANTIS)
plot(as.factor(MSI_check$TME_subtype), MSI_check$MSI_SCORE_MANTIS)

#MLH1 silencing 
plot(MSI_check$TCGA_subtype, MSI_check$MLH1_SILENCING)

plot(MSI_check$TCGA_subtype, MSI_check$MLH1_SILENCING)
plot(MSI_check$MLH1_SILENCING, MSI_check$STAD_MSI)


#MSI analysis PCR
plot(MSI_check$TCGA_subtype, MSI_check$MSI_STATUS)

plot(MSI_check$MSI_STATUS, MSI_check$STAD_MSI)
plot(MSI_check$MSI_STATUS, MSI_check$MSI)
```
#MSI IHC
```{r}
library(pROC)
#LR model for predicting MLH1 and MSI from probabilities
MSI_check_LR = MSI_check
MSI_check_LR = MSI_check_LR[!is.na(MSI_check_LR$MLH1_ihc),] 
MSI_check_LR$MLH1_ihc = factor(MSI_check_LR$MLH1_ihc, levels = c("Positive", "Negative"))

glmfit = glm(MSI_check_LR$MLH1_ihc~MSI_check_LR$STAD_MSI, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_LR$prob_glm_fit = prob

roc_glmfit = roc(MSI_check_LR$MLH1_ihc~ MSI_check_LR$prob_glm_fit)
plot(roc_glmfit)
auc(roc_glmfit)
ci(roc_glmfit)

#ACRG MSI
glmfit = glm(MSI_check_LR$MLH1_ihc~MSI_check_LR$MSI, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_LR$prob_glm_fit = prob

roc_glmfit = roc(MSI_check_LR$MLH1_ihc~ MSI_check_LR$prob_glm_fit)
plot(roc_glmfit)
auc(roc_glmfit)
ci(roc_glmfit)
```

#MSI PCR
```{r}
#LR model for predicting MSI pcr from probabilities
MSI_check_pcr = MSI_check
MSI_check_pcr = MSI_check_pcr[!is.na(MSI_check_pcr$MSI_pcr),] 
MSI_check_pcr$MSI_pcr = factor(MSI_check_pcr$MSI_pcr, levels = c("MSI-L/MSS", "MSI-H"))



#MSI
glmfit = glm(MSI_check_pcr$MSI_pcr ~ MSI_check_pcr$MSI, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr$prob_glm_fit = prob

roc_glmfit_MSI = roc(MSI_check_pcr$MSI_pcr~ MSI_check_pcr$prob_glm_fit)
plot(roc_glmfit_MSI)
auc(roc_glmfit_MSI)
ci(roc_glmfit_MSI)

#STAD_MSI 
glmfit = glm(MSI_pcr ~ STAD_MSI, data = MSI_check_pcr, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr$prob_glm_fit = prob

roc_glmfit_STADMSI = roc(MSI_check_pcr$MSI_pcr ~ MSI_check_pcr$prob_glm_fit)
plot(roc_glmfit_STADMSI)
auc(roc_glmfit_STADMSI)
ci(roc_glmfit_STADMSI)

#MSI SENSITIVITY (TCGA only == external analysis)
glmfit = glm(MSI_check_pcr[MSI_check_pcr$study=="TCGA",]$MSI_pcr ~ MSI_check_pcr[MSI_check_pcr$study=="TCGA",]$MSI, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr[MSI_check_pcr$study=="TCGA",]$prob_glm_fit = prob

roc_glmfit_MSI = roc(MSI_check_pcr[MSI_check_pcr$study=="TCGA",]$MSI_pcr~ MSI_check_pcr[MSI_check_pcr$study=="TCGA",]$prob_glm_fit)
plot(roc_glmfit_MSI)
auc(roc_glmfit_MSI)
ci(roc_glmfit_MSI)


#STAD_MSI SENSITIVITY (ACRG only == external analysis)
glmfit = glm(MSI_pcr ~ STAD_MSI, data = MSI_check_pcr[MSI_check_pcr$study=="ACRG",], family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr[MSI_check_pcr$study=="ACRG",]$prob_glm_fit = prob

roc_glmfit_STADMSI = roc(MSI_check_pcr[MSI_check_pcr$study=="ACRG",]$MSI_pcr ~ MSI_check_pcr[MSI_check_pcr$study=="ACRG",]$prob_glm_fit)
plot(roc_glmfit_STADMSI)
auc(roc_glmfit_STADMSI)
ci(roc_glmfit_STADMSI)

#Final analysis



#MSI
glmfit = glm(MSI_check_pcr$MSI_pcr ~ MSI_check_pcr$MSI, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr$prob_glm_fit = prob

roc_glmfit_MSI = roc(MSI_check_pcr$MSI_pcr~ MSI_check_pcr$prob_glm_fit)
plot(roc_glmfit_MSI)
auc(roc_glmfit_MSI)
ci(roc_glmfit_MSI)

#STAD_MSI 
glmfit = glm(MSI_pcr ~ STAD_MSI, data = MSI_check_pcr, family=binomial(link="logit"))

exp(coefficients(glmfit))
est_glmfit = cbind(Estimate = coef(glmfit), confint(glmfit))
exp(est_glmfit)
prob=predict(glmfit, type = c("response"))

MSI_check_pcr$prob_glm_fit = prob

roc_glmfit_STADMSI = roc(MSI_check_pcr$MSI_pcr ~ MSI_check_pcr$prob_glm_fit)
plot(roc_glmfit_STADMSI)
auc(roc_glmfit_STADMSI)
ci(roc_glmfit_STADMSI)


```
#PLot MSI PCR ROC
```{r}
auc_msi = ggroc(list(roc_glmfit_STADMSI,roc_glmfit_MSI), linetype = 1, size = 1.4) +
                xlab("Specificity") +
                ylab("Sensitivity") +
                ggtitle("ROC Microsatellite Instability informed by model probability") +
                geom_abline(intercept = 1, slope = 1, linetype = 2) +
                scale_colour_manual(name="Logistic Regression Model",labels = c("TCGA MSI (AUC = 0.955 [95% CI: 0.93-0.87])", "ACRG MSI (AUC = 0.916 [95% CI: 0.884-0.958])"), values = c("#E64B35FF", "#3C5488FF")) +
                theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.55,0.08),
                      legend.background = element_rect(size=0.5, linetype="solid",colour ="black", fill=alpha("white",0.7))) 


ggroc(list(roc_glmfit_STADMSI,roc_glmfit_MSI), linetype = 1, size = 1.4) +
                xlab("Specificity") +
                ylab("Sensitivity") +
                ggtitle("ROC Microsatellite Instability informed by model probability") +
                geom_abline(intercept = 1, slope = 1, linetype = 2) +
                scale_colour_manual(name="Logistic Regression Model",labels = c(expression(atop("TCGA MSI", paste("(AUC = 0.955 [95% CI: 0.93-0.87])"))) , expression(atop("ACRG MSI", paste("AUC = 0.916 [95% CI: 0.884-0.958])")))), values = c("#E64B35FF", "#3C5488FF")) +
                theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.55,0.08),
                      legend.box.just = "left",
                      legend.background = element_rect(size=0.5, linetype="solid",colour ="black", fill=alpha("white",0.7))) 

ggsave("auc_msi.svg", auc_msi, width=5, height=5)

ggsave("auc_msi.png", auc_msi, width=5, height=5)
        
```

#Plot all models AUC  
```{r}
complete_auc = ggroc(list(roc_glmfit_ebv, roc_glmfit_STADMSI,roc_glmfit_MSI,roc_glmfit_STADCIN,roc_glmfit_MSS_TP53neg), aes = c("linetype", "colour"), size = 2.5) +
                xlab("Specificity") +
                ylab("Sensitivity") +
                ggtitle("ROC Logistic Regression Models") +
                geom_abline(intercept = 1, slope = 1, linetype = 2) +
                scale_colour_manual(name="Logistic Regression Model",labels = c("EBV ISH ~ TCGA EBV (AUC = 0.997)", "MSI Status ~ TCGA MSI (AUC = 0.955)", "MSI Status ~ ACRG MSI (AUC = 0.916)", "CNV GI ~ TCGA CIN (AUC = 0.86)", "CNV GI ~ ACRG MSS TP53- (AUC = 0.73)"), values = c("#91D1C2FF","#E64B35FF", "#3C5488FF","#F39B7FFF", "#8491B4FF")) +
    scale_linetype_manual(name="Logistic Regression Model", values = c("solid","twodash", "twodash","dotted","dotted"),labels = c("EBV ISH ~ TCGA EBV (AUC = 0.997)", "MSI Status ~ TCGA MSI (AUC = 0.955)", "MSI Status ~ ACRG MSI (AUC = 0.916)", "CNV GI ~ TCGA CIN (AUC = 0.86)", "CNV GI ~ ACRG MSS TP53- (AUC = 0.73)")) +
                theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 16)) +
                theme(axis.text.y = element_text(colour="black",size = 16)) + 
                theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=16)) +
                theme(legend.title = element_text(color = "black", size = 16),
                      legend.text = element_text(color = "black", size = 16),
                      legend.direction = "vertical",
                      legend.position = c(0.55, 0.18),
                      legend.background = element_rect(size=0.4, linetype="solid",colour ="black", fill=alpha("white",0.7))) + 
    guides(colour = guide_legend("Logistic Regression Model")) 

ggsave("complete_auc.svg", complete_auc, width=6, height=6)

ggsave("complete_auc.png", complete_auc, width=6, height=6)
        
```

#Heterogeneity by class
```{r}
table(complete_subtype$TCGA_subtype,complete_subtype$ACRG_subtype,complete_subtype$TME_subtype_cal)

```

#Heterogeneity by tumour type
```{r}
glm(stage~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT, data = complete_subtype , family=binomial(link="logit"))

test <- nnet::multinom(stage~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT, data = complete_subtype)
z <- summary(test)$coefficients/summary(test)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
exp(coef(test))

tt <- broom::tidy(test,conf.int=TRUE)
tt <- dplyr::filter(tt, term!="(Intercept)")

ggplot(tt, aes(x=estimate,y=term,colour=y.level))+
  ggstance::geom_pointrangeh(aes(xmin=conf.low,
                     xmax=conf.high),
    position=ggstance::position_dodgev(height=0.75))

model_data = dplyr::select(complete_subtype, c("stage", "STAD_EBV" , "STAD_MSI" , "STAD_GS" , "STAD_CIN" , "High_cal" , "Low_cal" , "MSS_TP53neg" , "MSS_TP53pos" , "MSI" , "EMT"))
model_data = na.omit(model_data)
x= data.matrix(model_data[, 2:11])
y= model_data$stage
y = as.factor(y)


set.seed(99)
cheese = caret::train(x,y, 'nnet',trControl=trainControl(method='none'))



glm(signet_ring~ STAD_EBV + STAD_MSI + STAD_GS + STAD_CIN + High_cal + Low_cal + MSS_TP53neg + MSS_TP53pos + MSI + EMT, data = complete_subtype , family=binomial(link="logit"))

plot(complete_subtype$signet_ring~ complete_subtype$STAD_EBV)



 tb2 = tbl_summary(complete_subtype,
             by = "stage", 
             percent = "column", 
             include=c("STAD_CIN", "STAD_MSI","STAD_EBV", "STAD_GS","EMT", "MSI","MSS_TP53neg", "MSS_TP53pos","High_cal", "Low_cal")) %>% 
   add_p(test = c("study", "grade", "lauren_class", "signet_ring", "tumour_location_coarse") ~"fisher.test.simulate.p.values" ) %>% 
   remove_row_type(variables = everything(),type = "missing") 

 tb2_flex = as_flex_table(
  tb2,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("acrg_table2" = tb2_flex,path = "#make file name")





combo_asses = complete_subtype
combo_asses$hetero <- paste(combo_asses$TCGA_subtype,combo_asses$ACRG_subtype, combo_asses$TME_subtype_cal)

length(unique(combo_asses$hetero))

table(combo_asses$stage,combo_asses$hetero)
chisq.test(table(combo_asses$stage,combo_asses$hetero))

table(combo_asses$lauren_class,combo_asses$hetero)
chisq.test(table(combo_asses$lauren_class,combo_asses$hetero))

table(combo_asses$signet_ring,combo_asses$hetero)
chisq.test(table(combo_asses$signet_ring,combo_asses$hetero))

test <- nnet::multinom(stage~ hetero, data = combo_asses)
z <- summary(test)$coefficients/summary(test)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
exp(coef(test))

tt <- broom::tidy(test,conf.int=TRUE)
tt <- dplyr::filter(tt, term!="(Intercept)")

ggplot(tt, aes(x=estimate,y=term,colour=y.level))+
  ggstance::geom_pointrangeh(aes(xmin=conf.low,
                     xmax=conf.high),
    position=ggstance::position_dodgev(height=0.75))
```


#*****IMMUNE ANALYSIS
```{r}
#Import Immune Landscapes of Cancer Data

urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/immune_landscape.csv'
immune_analysis<-read.csv(urlfile)

```
```{r}
colnames(immune_analysis)[which(names(immune_analysis) == "TCGA Participant Barcode")] <- "patient_id"

immune_analysis = merge(complete_subtype,immune_analysis, by.x="patient_id")

immune_analysis$ACRG_subtype = as.factor(immune_analysis$ACRG_subtype)


immune_analysis[,48:ncol(immune_analysis)] = lapply(48:ncol(immune_analysis),function(x) as.numeric(immune_analysis[[x]]))

immune_analysis = dplyr::select(immune_analysis, -c("SNV Neoantigens","Indel Neoantigens","OS Time","OS", "PFI", "PFI Time"))

immune_analysis = dplyr::select(immune_analysis, -c("OS_time","OS_status", "PFS_status", "PFS_time"))

colnames(immune_analysis)[which(names(immune_analysis) == "Eosinophils...41")] <- "Eosinophils"
colnames(immune_analysis)[which(names(immune_analysis) == "Eosinophils...61")] <- "Eosinophils 2"
colnames(immune_analysis)[which(names(immune_analysis) == "Neutrophils...48")] <- "Neutrophils"
colnames(immune_analysis)[which(names(immune_analysis) == "Neutrophils...60")] <- "Neutrophils 2"
```
#TCGA immune landscape

#### Correlation continuous immune features

```{r}
pancancer = immune_analysis[,44:97]
```
```{r}
#MSS_TP53neg
type = immune_analysis$MSS_TP53neg
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "MSS_TP53neg"

MSS_TP53neg_matt = corr_matt
#MSS_TP53pos
type = immune_analysis$MSS_TP53pos
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "MSS_TP53pos"

MSS_TP53pos_matt = corr_matt
#MSI
type = immune_analysis$MSI
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "MSI"

MSI_matt = corr_matt
#EMT
type = immune_analysis$EMT
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "EMT"

EMT_matt = corr_matt

#STAD_GS
type = immune_analysis$STAD_GS
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "STAD_GS"

STAD_GS_matt = corr_matt

#STAD_CIN
type = immune_analysis$STAD_CIN
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "STAD_CIN"

STAD_CIN_matt = corr_matt

#STAD_MSI
type = immune_analysis$STAD_MSI
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "STAD_MSI"

STAD_MSI_matt = corr_matt

#STAD_EBV
type = immune_analysis$STAD_EBV
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "STAD_EBV"

STAD_EBV_matt = corr_matt

#High
type = immune_analysis$High_cal
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "High"

High_matt = corr_matt

#Low
type = immune_analysis$Low_cal
type_contrasts = model.matrix(~ type +0, data = immune_analysis)
corr_matt = apply(type_contrasts, 2, function(type) {
  apply(pancancer, 2, function(F) {cor.test(type, F, method = "spearman", exact = T)$estimate[[1]]})
})
corr_matt = as.data.frame(corr_matt)
colnames(corr_matt)[which(names(corr_matt) == "type")] <- "Low"

Low_matt = corr_matt


corr_matt = cbind(MSS_TP53neg_matt,MSS_TP53pos_matt)
corr_matt = cbind(EMT_matt,corr_matt)
corr_matt = cbind(MSI_matt,corr_matt)
corr_matt = cbind(STAD_EBV_matt,corr_matt)
corr_matt = cbind(STAD_MSI_matt,corr_matt)
corr_matt = cbind(STAD_CIN_matt,corr_matt)
corr_matt = cbind(STAD_GS_matt,corr_matt)
corr_matt = cbind(Low_matt,corr_matt)
corr_matt = cbind(High_matt,corr_matt)
corr_matt_continuous = corr_matt

colnames(corr_matt_continuous) = c("High", "Low", "GS", "CIN", "TCGA MSI", "EBV", "MSI", "EMT", "MSS TP53-", "MSS TP53+")
```
```{r}
corr_heatmap = pheatmap(corr_matt_continuous,method = 'complete')
 
corr_heatmap = pheatmap(corr_matt_continuous,method = 'complete', color=rev(brewer.pal(8, "RdBu")))

cols = rev(brewer.pal(9, "RdBu"))
paletteLength=1000
myBreaks <- c(seq(min(corr_matt_continuous), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(corr_matt_continuous)/paletteLength, max(corr_matt_continuous), length.out=floor(paletteLength/2)))

#####
df = corr_matt_continuous
df$max <- apply(abs(df), 1, max, na.rm=TRUE)
removenames = rownames(df[df$max < quantile(df$max, 0.25), ])
trim_corr_matt_continuous = df[!rownames(df) %in% removenames,]
trim_corr_matt_continuous = dplyr::select(trim_corr_matt_continuous, -max)
#####

corr_heatmap = pheatmap(corr_matt_continuous,method = 'complete', breaks=myBreaks, color = colorRampPalette(cols)(1000), cellwidth = 20, cellheight = 10, angle_col = 45)


svg(filename="immune_features_heatmap.svg", width=6.666668, height=10)
corr_heatmap
dev.off()

png(filename="immune_features_heatmap.png", width=6.666668, height=10,units="in", res = 300)
corr_heatmap
dev.off()
```
#Mutliple comparisons TME high vs low immune landscape 
```{r}
immune_analysis[,c(25,44:97)]

multi_comp = immune_analysis[,c(25,44:97)] 
multi_comp_long = tidyr::gather(multi_comp, immune_feature, value, "Leukocyte Fraction":"Macrophages" )

multi_comp_long_test = multi_comp_long%>% 
   group_by(immune_feature) %>% 
   filter(n() > 3) %>% 
   rstatix::wilcox_test(value~TME_subtype_cal) 
multi_comp_long_test$p.adjust = p.adjust(multi_comp_long_test$p, method="BH")
multi_comp_long_test$sig = cut(multi_comp_long_test$p, c(0,0.001,0.01,0.05,0.1,Inf), c("***", "**", "*", ".",""))
multi_comp_long_test$sig.adjust = cut(multi_comp_long_test$p.adjust, c(0,0.001,0.01,0.05,0.1,Inf), c("***", "**", "*", ".",""))


```
#Mutliple comparisons All immune landscape 
```{r}
immune_analysis[,c(2,25,30,44:97)]

multi_comp_all = immune_analysis[,c(2,25,30,44:97)]
multi_comp_long_all = tidyr::gather(multi_comp_all, immune_feature, value, "Leukocyte Fraction":"Macrophages" )

multi_comp_long_all = tidyr::gather(multi_comp_long_all, subtype, class, "TCGA_subtype":"ACRG_subtype" )


multi_comp_long_test_all = multi_comp_long_all%>% 
   group_by(immune_feature) %>% 
   filter(n() > 3) %>% 
   rstatix::dunn_test(value~class) 
multi_comp_long_test_all$p.adjust = p.adjust(multi_comp_long_test_all$p, method="BH")

write.csv(multi_comp_long_test_all, "dunns_test_immunelandscape.csv")

multi_comp_long_test_all$sig = cut(multi_comp_long_test_all$p, c(0,0.001,0.01,0.05,0.1,Inf), c("***", "**", "*", ".",""))
multi_comp_long_test_all$sig.adjust = cut(multi_comp_long_test_all$p.adjust, c(0,0.001,0.01,0.05,0.1,Inf), c("***", "**", "*", ".",""))
multi_comp_long_test_all$abs_stat = abs(multi_comp_long_test_all$statistic)


#Order levels
multi_comp_long_all$class  = as.factor(multi_comp_long_all$class)
multi_comp_long_all$class <- factor(multi_comp_long_all$class, levels=c("STAD_CIN","STAD_EBV" , "STAD_GS", "STAD_MSI", "EMT", "MSI", "MSS_TP53neg", "MSS_TP53pos", "High", "Low"))

multi_comp_long_all$class <- factor(multi_comp_long_all$class, levels=c("STAD_CIN","MSS_TP53neg" , "STAD_MSI", "MSS_TP53pos", "High", "MSI", "Low", "STAD_EBV", "STAD_GS", "EMT"))


multi_comp_long_all %>% filter(immune_feature == "Aneuploidy Score") %>%
ggplot(data = .,aes(x = class, y = value))+ 
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free")



#WE ALREADY KNOWN MANY OF THE GENMOCI CHARACTERISTIICS SUH CAS HOMOLOGOUS RECOMBINATION AND MUTATION RATES. (Describe the replication...). 

immune_tgfbeta = multi_comp_long_all %>% filter(immune_feature == "TGF-beta Response") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_tgfbeta.svg", width=6, height=4)
immune_tgfbeta
dev.off()


immune_wound_heal = multi_comp_long_all %>% filter(immune_feature == "Wound Healing") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_wound_heal.svg", width=6, height=4)
immune_wound_heal
dev.off()


immune_macM1 = multi_comp_long_all %>% filter(immune_feature == "Macrophages M1") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_macM1.svg", width=6, height=4)
immune_macM1
dev.off()


immune_stromal = multi_comp_long_all %>% filter(immune_feature == "Stromal Fraction") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_stromal.svg", width=6, height=4)
immune_stromal
dev.off()


immune_prolif = multi_comp_long_all %>% filter(immune_feature == "Proliferation") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_prolif.svg", width=6, height=4)
immune_prolif
dev.off()


immune_Th2  = multi_comp_long_all %>% filter(immune_feature == "Th2 Cells") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_Th2.svg", width=6, height=4)
immune_Th2
dev.off()


immune_cd4_activated  = multi_comp_long_all %>% filter(immune_feature == "T Cells CD4 Memory Activated") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Value") + 
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 

svg(filename="immune_cd4_activated.svg", width=6, height=4)
immune_cd4_activated
dev.off()

multi_comp_long_all %>% filter(immune_feature == "TGF-beta Response" | immune_feature == "Wound Healing" | immune_feature == "Th2 Cells" | immune_feature == "Macrophages M1" | immune_feature == "Stromal Fraction" | immune_feature == "Proliferation"| immune_feature == "T Cells CD4 Memory Activated" | immune_feature == "T Cells CD8" | immune_feature == "IFN-gamma Response") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Probability") + 
  ggtitle("Distiribution of Subtype Probability Scores") +
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 


multi_comp_long_all %>% filter(immune_feature == "TGF-beta Response" | immune_feature == "Wound Healing" | immune_feature == "Th2 Cells" | immune_feature == "Macrophages M1" | immune_feature == "Stromal Fraction" | immune_feature == "Proliferation"| immune_feature == "T Cells CD4 Memory Activated" | immune_feature == "T Cells CD8" | immune_feature == "IFN-gamma Response") %>%
  ggplot(data = .,aes(x = class, y = value, fill = class))+ 
  geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) +
  ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + facet_wrap(~immune_feature, scales = "free") +
   scale_fill_manual(values = c("#F39B7FFF", "#8491B4FF","#E64B35FF", "#33A02C", "#925E9FFF", "#3C5488FF","#EFC000FF", "#91D1C2FF","#4DBBD5FF","#A6CEE3")) +
  scale_x_discrete(labels = c("CIN", "MSS TP53-", "TCGA MSI","MSS TP53+", "High", "MSI", "Low", "EBV", "GS", "EMT")) +
  ylab("Probability") + 
  ggtitle("Distiribution of Subtype Probability Scores") +
  theme_bw() +
  theme(axis.text.x = element_text(colour="black", size = 16,angle = 45, hjust=1, vjust=1))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(strip.text = element_text(colour="black",size = 14)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 






rank = multi_comp_long_test_all%>% dplyr::group_by(immune_feature)%>% dplyr::summarise(Average=mean(abs_stat))


```


#TGF beta boxplot
```{r}

immune_analysis$TME_subtype_cal = factor(immune_analysis$TME_subtype_cal, levels = c("High", "Low"))


tgf_beta_response_TME = ggplot(data = immune_analysis,aes(x = TME_subtype_cal, y = immune_analysis$`TGF-beta Response`, fill = TME_subtype_cal))+
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + 
  scale_fill_manual(values = c("#925E9FFF","#EFC000FF")) +
  ylab("TGF-beta Response") + 
  xlab("TME Subtype") +
  ggtitle("TGF Beta Response vs TME Subtype") +stat_compare_means(size=4, vjust= 2.5, hjust = 0.6) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 13)) +
  theme(axis.text.y = element_text(colour="black",size = 13)) + 
  theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
  theme(axis.title.y = element_text(colour="black", size=13)) +
  theme(legend.position = "none")

ggsave("tgf_beta_response_TME.svg", tgf_beta_response_TME, width=4, height=3)

M1_TME = ggplot(data = immune_analysis,aes(x = TME_subtype_cal, y = immune_analysis$`Macrophages M1`, fill = TME_subtype_cal))+
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + 
  scale_fill_manual(values = c("#925E9FFF","#EFC000FF")) +
  ylab("M1 Macrophages") + 
  xlab("TME Subtype") +
  ggtitle("M1 Macrophages vs TME Subtype") +
  stat_compare_means(size=4, vjust= 2, hjust = 0.6) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 13)) +
  theme(axis.text.y = element_text(colour="black",size = 13)) + 
  theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
  theme(axis.title.y = element_text(colour="black", size=13)) +
  theme(legend.position = "none")

ggsave("M1_TME.svg", M1_TME, width=4, height=3)

M2_TME = ggplot(data = immune_analysis,aes(x = TME_subtype_cal, y = immune_analysis$`Macrophages M2`, fill = TME_subtype_cal))+
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + 
  scale_fill_manual(values = c("#925E9FFF","#EFC000FF")) +
  ylab("M2 Macrophages") + 
  xlab("TME Subtype") +
  ggtitle("M2 Macrophages vs TME Subtype") +stat_compare_means(size=4, vjust= 2.5, hjust = 0.6) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 13)) +
  theme(axis.text.y = element_text(colour="black",size = 13)) + 
  theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
  theme(axis.title.y = element_text(colour="black", size=13)) +
  theme(legend.position = "none")

ggsave("M2_TME.svg", M2_TME, width=4, height=3)

CD4_memory_TME = ggplot(data = immune_analysis,aes(x = TME_subtype_cal, y = immune_analysis$`T Cells CD4 Memory Activated`, fill = TME_subtype_cal))+
    geom_violin(alpha=0.4, scale = "width",size=1,color=NA, adjust=1.5) + 
     ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, width = 0.45, color="black",alpha=0.4,show.legend = F, bandwidth = 1)+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + 
  scale_fill_manual(values = c("#925E9FFF","#EFC000FF")) +
  ylab("Activated CD4 T Cells") + 
  xlab("TME Subtype") +
  ggtitle("Activated CD4 T Cells vs TME Subtype") +stat_compare_means(size=4, vjust= 2.5, hjust = 0.45) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 13)) +
  theme(axis.text.y = element_text(colour="black",size = 13)) + 
  theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
  theme(axis.title.y = element_text(colour="black", size=13)) +
  theme(legend.position = "none")

ggsave("CD4_memory_TME.svg", CD4_memory_TME, width=4, height=3)

#Change levels back
immune_analysis$TME_subtype_cal = factor(immune_analysis$TME_subtype_cal, levels = c("Low", "High"))

```



