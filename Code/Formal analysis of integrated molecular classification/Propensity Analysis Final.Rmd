---
title: "Propensity score models"
author: "Daniel Skubleny"
date: "09/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Propensity score matching
```{r}
library(MatchIt)
library(optmatch)
```


#Set up data for matching
```{r}
chemo_only_PS = complete_subtype
chemo_only_PS$treatment = chemo_only_PS$chemotherapy=="Yes"
chemo_only_PS$treatment = as.factor(chemo_only_PS$treatment)
chemo_only_PS = chemo_only_PS[!is.na(chemo_only_PS$treatment),] 
chemo_only_PS = chemo_only_PS[!is.na(chemo_only_PS$stage),]  
chemo_only_PS = chemo_only_PS[(chemo_only_PS$radiation=="No" | is.na(chemo_only_PS$radiation)),] 
chemo_only_PS = chemo_only_PS[!is.na(chemo_only_PS$age),]##NEEDED to remove one age
chemo_only_PS = chemo_only_PS[!is.na(chemo_only_PS$OS_time),] 
row.names(chemo_only_PS) = NULL 
chemo_only_PS = tibble::column_to_rownames(chemo_only_PS, "patient_id")
```

```{r}
optimal_chemo_PS = chemo_only_PS
optimal_chemo_PS = optimal_chemo_PS[!is.na(optimal_chemo_PS$tumour_location_coarse),] 
optimal_chemo_PS = optimal_chemo_PS[!(optimal_chemo_PS$tumour_location_coarse=="Whole"),] 
optimal_chemo_PS = optimal_chemo_PS[!is.na(optimal_chemo_PS$lauren_class),] 
optimal_chemo_PS = optimal_chemo_PS[!is.na(optimal_chemo_PS$age),]##NEEDED to remove one age
optimal_chemo_PS$age_center = scale(optimal_chemo_PS$age, center = TRUE, scale = FALSE)

optimal_chemo_PS$age_cut = cut(optimal_chemo_PS$age, c(-Inf,59.0,Inf), c("Low", "High"))
```

#Analysis of factors on continuous metric with centering
```{r}
#The purpose of centering is to allow the interaction terms to be more interpretable and to ensure we do not inflate standard errors
centered_chemo_PS = optimal_chemo_PS
centered_chemo_PS$High_center = scale(centered_chemo_PS$High_cal, center = TRUE, scale = TRUE)
centered_chemo_PS$Low_center = scale(centered_chemo_PS$Low_cal, center = TRUE, scale = TRUE)
centered_chemo_PS$CIN_center = scale(centered_chemo_PS$STAD_CIN, center = TRUE, scale = TRUE)
centered_chemo_PS$STAD_MSI_center = scale(centered_chemo_PS$STAD_MSI, center = TRUE, scale = TRUE)
centered_chemo_PS$GS_center = scale(centered_chemo_PS$STAD_GS, center = TRUE, scale = TRUE)
centered_chemo_PS$EBV_center = scale(centered_chemo_PS$STAD_EBV, center = TRUE, scale = TRUE)
centered_chemo_PS$MSI_center = scale(centered_chemo_PS$MSI, center = TRUE, scale = TRUE)
centered_chemo_PS$EMT_center = scale(centered_chemo_PS$EMT, center = TRUE, scale = TRUE)
centered_chemo_PS$TP53neg_center = scale(centered_chemo_PS$MSS_TP53neg, center = TRUE, scale = TRUE)
centered_chemo_PS$TP53pos_center = scale(centered_chemo_PS$MSS_TP53pos, center = TRUE, scale = TRUE)
```


```{r}
centered_chemo_PS$sex = as.factor(centered_chemo_PS$sex)
centered_chemo_PS$lauren_class = as.factor(centered_chemo_PS$lauren_class)
centered_chemo_PS$tumour_location_coarse = as.factor(centered_chemo_PS$tumour_location_coarse)

centered_chemo_PS$TCGA_subtype = as.factor(centered_chemo_PS$TCGA_subtype)
centered_chemo_PS$ACRG_subtype = as.factor(centered_chemo_PS$ACRG_subtype)
centered_chemo_PS$TME_subtype_cal = as.factor(centered_chemo_PS$TME_subtype_cal)
centered_chemo_PS$study = as.factor(centered_chemo_PS$study)


library(cobalt)
stage_stratify = centered_chemo_PS

stage_stratify$stage = na_if(stage_stratify$stage, "I")
stage_stratify <- stage_stratify %>% filter("stage" != "I") %>% droplevels()
stage_stratify = stage_stratify[!is.na(stage_stratify$stage),] 


#CI = curative intent
stage_stratify_CI = centered_chemo_PS

stage_stratify_CI$stage = na_if(stage_stratify_CI$stage, "I")
stage_stratify_CI$stage = na_if(stage_stratify_CI$stage, "IV")
stage_stratify_CI <- stage_stratify_CI %>% filter("stage" != "I") %>% droplevels()
stage_stratify_CI <- stage_stratify_CI %>% filter("stage" != "IV") %>% droplevels()
stage_stratify_CI = stage_stratify_CI[!is.na(stage_stratify_CI$stage),] 

#No stage IV
stage_stratify_noIV = centered_chemo_PS

stage_stratify_noIV$stage = na_if(stage_stratify_noIV$stage, "IV")
stage_stratify_noIV <- stage_stratify_noIV %>% filter("stage" != "IV") %>% droplevels()
stage_stratify_noIV = stage_stratify_noIV[!is.na(stage_stratify_noIV$stage),] 
```
#SPLINES 
```{r}
require(splines, quietly=TRUE)
nfit1 <- coxph(Surv(OS_time, OS_status) ~ age, optimal_chemo_PS)
nfit2 <- coxph(Surv(OS_time, OS_status) ~ ns(age, df=2), optimal_chemo_PS)
nfit3 <- coxph(Surv(OS_time, OS_status) ~ ns(age, df=3), optimal_chemo_PS)
    anova(nfit1, nfit2,nfit3)
    
mfit <- coxph(Surv(OS_time, OS_status) ~  ns(age, df=2), data=optimal_chemo_PS)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
#Significantly nonlinear

ptemp <- termplot(mfit, se=TRUE, plot=FALSE)
ageterm <- ptemp$age # this will be a data frame
center = ageterm$y[ageterm$x==50]
ytemp <- ageterm$y + outer(ageterm$se, c(0, -1.96, 1.96), '*')


svg(filename="ns_age.svg", width=6, height=4)
par(mar=c(5,5,4,2) + 0.1)
matplot(ageterm$x, 
        exp(ytemp - center), 
        log='y',
        type='l', 
        lty=c(1,2,2),
        lwd=2,
        col=1, 
        xlab="Age at diagnosis", 
        ylab="Relative death rate", 
        main = "Natural Cubic Spline for Age (df=2)",
        cex.lab=1.5,
        cex.main = 1.5,
        cex.axis=1.5)
dev.off()

png(filename="ns_age.png", width=6, height=4,units="in", res = 300)
par(mar=c(5,5,4,2) + 0.1)
matplot(ageterm$x, 
        exp(ytemp - center), 
        log='y',
        type='l', 
        lty=c(1,2,2),
        lwd=2,
        col=1, 
        xlab="Age at diagnosis", 
        ylab="Relative death rate", 
        main = "Natural Cubic Spline for Age (df=2)",
        cex.lab=1.5,
        cex.main = 1.5,
        cex.axis=1.5)
dev.off()



#Linear interpretation

    
mfit <- coxph(Surv(OS_time, OS_status) ~  age, data=optimal_chemo_PS)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
#Significantly nonlinear

ptemp <- termplot(mfit, se=TRUE, plot=FALSE)
ageterm <- ptemp$age # this will be a data frame
center = ageterm$y[ageterm$x==50]
ytemp <- ageterm$y + outer(ageterm$se, c(0, -1.96, 1.96), '*')

svg(filename="linear_age.svg", width=6, height=4)
par(mar=c(5,5,4,2) + 0.1)
matplot(ageterm$x, 
        exp(ytemp - center), 
        log='y',
        type='l', 
        lty=c(1,2,2),
        lwd=2,
        col=1, 
        xlab="Age at diagnosis", 
        ylab="Relative death rate", 
        main = "Linear Effect of Age",
        cex.lab=1.5,
        cex.main = 1.5,
        cex.axis=1.5)
dev.off()

png(filename="linear_age.png", width=6, height=4,units="in", res = 300)
par(mar=c(5,5,4,2) + 0.1)
matplot(ageterm$x, 
        exp(ytemp - center), 
        log='y',
        type='l', 
        lty=c(1,2,2),
        lwd=2,
        col=1, 
        xlab="Age at diagnosis", 
        ylab="Relative death rate", 
        main = "Linear Effect of Age",
        cex.lab=1.5,
        cex.main = 1.5,
        cex.axis=1.5)
dev.off()


#Age is associated with the outcome (survival) in  a nonlinear fashion best expalined by a ns spline with df=2. Note bs spline was not significant. 
```

#////Model 3 All stages Match ATC 
```{r}
require(splines, quietly=TRUE)

match_nearest = matchit(treatment ~ ns(age, df=2) + sex + stage + TCGA_subtype + ACRG_subtype + TME_subtype_cal + tumour_location_coarse + study + lauren_class, data = centered_chemo_PS, link="logit",method = "nearest", estimand = "ATC", caliper = 0.06, ratio = 4)

sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")


#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC_allstage = match.data(match_nearest)

model_3_ATC_allstage <- model_3_ATC_allstage %>% filter("study" != "Samsung") %>% droplevels()

```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment , weights = weights, data = model_3_ATC_allstage, robust = TRUE, cluster = subclass)
summary(base_model)

conditional_model = coxph(Surv(OS_time, OS_status) ~ treatment, weights = weights, data = model_3_ATC_allstage, robust = TRUE, cluster = subclass)
summary(conditional_model)
```
###TME_subtype
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment + TME_subtype_cal, data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
summary(base_model)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TME_subtype_cal, data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

waldtest(base_model, multi.cox, test = "Chisq")
car::Anova(multi.cox, test.statistic="Wald")

survival::cox.zph(multi.cox)
```
```{r}
interaction_effects = publish(multi.cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]

```
###ACRG subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + ACRG_subtype , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

ACRG_cox = coxph(Surv(OS_time, OS_status) ~ treatment*ACRG_subtype, data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(ACRG_cox)
#Test for overall interaction across ACRG subtypes with treatment
###

waldtest(base, ACRG_cox, test = "Chisq")
car::Anova(ACRG_cox, test.statistic="Wald")
s

interaction_effects = publish(ACRG_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]

```
###TCGA subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + TCGA_subtype , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

TCGA_cox = coxph(Surv(OS_time, OS_status) ~ treatment*TCGA_subtype , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(TCGA_cox)
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, TCGA_cox, test = "Chisq")
car::Anova(TCGA_cox, test.statistic="Wald")
s

interaction_effects = publish(TCGA_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")
s

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse ,data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse, data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
#Test for overall interaction across ACRG subtypes with treatment
waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")
s

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage  ,data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage  , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(stage_cox)
s
#Test for overall interaction across stage with treatment
waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")

interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class  ,data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class , data = model_3_ATC_allstage, weights = weights,robust = TRUE, cluster = subclass)
s=summary(lauren_cox)
s
#Test for overall interaction across ACRG subtypes with treatment
waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
#ATC Model 3 continuous Match ATC
```{r}
require(splines, quietly=TRUE)
match_nearest = matchit(treatment ~ ns(age, df=2) + sex +stage + High_center + Low_center + STAD_MSI_center + GS_center + EBV_center + MSI_center + CIN_center + EMT_center +TP53neg_center + TP53pos_center + tumour_location_coarse + study + lauren_class, data = centered_chemo_PS, link="logit",method = "nearest", estimand = "ATC", caliper = 0.1, ratio =4)
sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")


#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC_allstage_cont = match.data(match_nearest)
model_3_ATC_allstage_cont <- model_3_ATC_allstage_cont %>% filter("study" != "Samsung") %>% droplevels()

```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment, weights = weights, data = model_3_ATC_allstage_cont, robust = TRUE, cluster = subclass)
summary(base_model)
```
###TME_subtype
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment + High_center , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*High_center , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```

###ACRG subgroup 
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*MSI_center , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EMT_center , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53pos_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53neg_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```
###TCGA_subtypes
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*STAD_MSI_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*GS_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*CIN_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EBV_center  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

#STAD_MSI and STAD_CIN have effects near significance which might be worth exploring with simPH
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
s
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse ,data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse, data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
s
#Test for overall interaction across ACRG subtypes with treatment


waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage  ,data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage  , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(stage_cox)
s
#Test for overall interaction across stage with treatment


waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")

interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class  ,data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class , data = model_3_ATC_allstage_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(lauren_cox)
s
#Test for overall interaction across ACRG subtypes with treatment



waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```





#////Model 3 II-IV Stage Match ATC 
```{r}
require(splines, quietly=TRUE)
match_nearest = matchit(treatment ~ ns(age, df=2) + sex + stage + TCGA_subtype + ACRG_subtype + TME_subtype_cal + tumour_location_coarse + study + lauren_class, data = stage_stratify, link="logit",method = "nearest", estimand = "ATC", caliper = 0.07, ratio =4)

sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")


#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC = match.data(match_nearest)
model_3_ATC <- model_3_ATC %>% filter("study" != "Samsung") %>% droplevels()
```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment , weights = weights, data = model_3_ATC, robust = TRUE, cluster = subclass)
summary(base_model)

```
###TME_subtype
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment, data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
summary(base_model)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TME_subtype_cal, data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)


waldtest(base_model, multi.cox, test = "Chisq")
car::Anova(multi.cox, test.statistic="Wald")

```
```{r}
interaction_effects = publish(multi.cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]


```
###ACRG subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + ACRG_subtype , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

ACRG_cox = coxph(Surv(OS_time, OS_status) ~ treatment*ACRG_subtype, data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(ACRG_cox)
#Test for overall interaction across ACRG subtypes with treatment
s


waldtest(base, ACRG_cox, test = "Chisq")
car::Anova(ACRG_cox, test.statistic="Wald")

interaction_effects = publish(ACRG_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###TCGA subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + TCGA_subtype , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

TCGA_cox = coxph(Surv(OS_time, OS_status) ~ treatment*TCGA_subtype , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(TCGA_cox)
#Test for overall interaction across ACRG subtypes with treatment
s


waldtest(base, TCGA_cox, test = "Chisq")
car::Anova(TCGA_cox, test.statistic="Wald")


interaction_effects = publish(TCGA_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse ,data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse  , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage  ,data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage  , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(stage_cox)

#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")

interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class ,data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class , data = model_3_ATC, weights = weights,robust = TRUE, cluster = subclass)
s=summary(lauren_cox)
s
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
#ATC Model 3 continuous Match ATC
```{r}
require(splines, quietly=TRUE)
match_nearest = matchit(treatment ~ ns(age, df=2) + sex +stage + High_center + Low_center + STAD_MSI_center + GS_center + EBV_center + MSI_center + CIN_center + EMT_center +TP53neg_center + TP53pos_center + tumour_location_coarse + study + lauren_class, data = stage_stratify, link="logit",method = "nearest", estimand = "ATC", caliper = 0.09, ratio =4)

sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")



svg("model_3_ATC_cont_jitter.svg", width=7, height=5)
plot(match_nearest, type="jitter", interactive=FALSE, 
     cex.lab = 1,
     cex.main = 1)
dev.off()

png("model_3_ATC_cont_jitter.png", width = 7, height = 5, units = 'in', res = 300)
plot(match_nearest, type="jitter", interactive=FALSE, 
     cex.lab = 1,
     cex.main = 1)
dev.off()

######

v <- data.frame(old = c("distance", "ns(age, df = 2)_1", "ns(age, df = 2)_2", "sex_Male", "stage_III", 
                        "High_center", "STAD_MSI_center", "GS_center", "EBV_center", "CIN_center", "MSI_center",
                        "EMT_center", "TP53neg_center", "TP53pos_center","tumour_location_coarse_Proximal",
                        "study_ACRG","study_Kosin", "study_KUGH", "study_Samsung", "study_TCGA", "study_Yonsei MDACC",
                        "lauren_class_Intestinal","lauren_class_Diffuse","lauren_class_Mixed"),
                new = c("Propensity Score","Natural Cubic Spline(Age_1)", "Natural Cubic Spline(Age_2)", "Male",
                        "Stage III", "TME High", "STAD MSI", "GS", 
                        "EBV", "CIN", "MSI", "EMT", "MSS TP53-", "MSS TP53+", "Location:Proximal", "Study:ACRG", 
                        "Study:Kosin", "Study:KUGH", "Study:Samsung", "Study:TCGA", "Study:Yonsei MDACC", 
                        "Lauren Class:Intestinal","Lauren Class:Diffuse","Lauren Class:Mixed"))


model_3_ATC_cont_plot = love.plot(match_nearest, 
          binary = "std",
          size=4,
          alpha = 0.8,
          thresholds = c(m = .1), 
          abs =TRUE, 
          line=TRUE,
          position = "bottom", 
          var.order = "unadjusted",
          sample.names = c("Unmatched", "Matched"),
          var.names = v) +
  theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.box.background = element_rect(), 
                      legend.position = c(0.7,0.12))

ggsave("model_3_ATC_cont_plot.svg", model_3_ATC_cont_plot, width=8, height=5)
ggsave("model_3_ATC_cont_plot.png", model_3_ATC_cont_plot, width=8, height=5)


#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC_cont = match.data(match_nearest)
model_3_ATC_cont <- model_3_ATC_cont %>% filter("study" != "Samsung") %>% droplevels()

```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment, weights = weights, data = model_3_ATC_cont, robust = TRUE, cluster = subclass)
summary(base_model)

conditional_model = coxph(Surv(OS_time, OS_status) ~ treatment + study , weights = weights, data = model_3_ATC_cont, robust = TRUE, cluster = subclass)
summary(conditional_model)
```
###TME_subtype
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*High_center , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*High_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```

###ACRG subgroup 
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*MSI_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EMT_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53pos_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53neg_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```
###TCGA_subtypes
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*STAD_MSI_center  + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*GS_center  + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*CIN_center + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EBV_center  + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse + study ,data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
#Test for overall interaction across ACRG subtypes with treatment
s


waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage + study ,data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage + study , data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(stage_cox)
s
#Test for overall interaction across stage with treatment

waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")

interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class + study ,data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)
s=summary(lauren_cox)
s
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

#////Model 3 II-III Stage Match ATC 
```{r}
require(splines, quietly=TRUE)
match_nearest = matchit(treatment ~ ns(age, df=2) + sex + stage + TCGA_subtype + ACRG_subtype + TME_subtype_cal + tumour_location_coarse + study + lauren_class, data = stage_stratify_CI, link="logit",method = "nearest", estimand = "ATC", caliper = 0.09, ratio =4)

sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")


#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC_CI = match.data(match_nearest)
model_3_ATC_CI <- model_3_ATC_CI %>% filter("study" != "Samsung") %>% droplevels()

```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment , weights = weights, data = model_3_ATC_CI, robust = TRUE, cluster = subclass)
summary(base_model)

```
###TME_subtype
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment, data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(base_model)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TME_subtype_cal, data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)


waldtest(base_model, multi.cox, test = "Chisq")
car::Anova(multi.cox, test.statistic="Wald")

```
```{r}
interaction_effects = publish(multi.cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###ACRG subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + ACRG_subtype , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

ACRG_cox = coxph(Surv(OS_time, OS_status) ~ treatment*ACRG_subtype, data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(ACRG_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, ACRG_cox, test = "Chisq")
car::Anova(ACRG_cox, test.statistic="Wald")

interaction_effects = publish(ACRG_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###TCGA subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + TCGA_subtype , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

TCGA_cox = coxph(Surv(OS_time, OS_status) ~ treatment*TCGA_subtype , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(TCGA_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, TCGA_cox, test = "Chisq")
car::Anova(TCGA_cox, test.statistic="Wald")


interaction_effects = publish(TCGA_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse  ,data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse  , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage  ,data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage  , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

s

waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")

interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class  ,data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class  , data = model_3_ATC_CI, weights = weights,robust = TRUE, cluster = subclass)

s

waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```
#ATC Model 3 continuous Match ATC
```{r}
require(splines, quietly=TRUE)
match_nearest = matchit(treatment ~ ns(age, df=2) + sex +stage + High_center + Low_center + STAD_MSI_center + GS_center + EBV_center + MSI_center + CIN_center + EMT_center +TP53neg_center + TP53pos_center + tumour_location_coarse + study + lauren_class, data = stage_stratify_CI, link="logit",method = "nearest", estimand = "ATC", caliper = 0.11, ratio =4)

sd_logit = sd(match_nearest$weights)
sd_logit*0.2
#Ratio 4 with not caliper sd_ligt*2 = 0.09824851 Increase caliper until SMD < 1 is violated. 


plot(summary(match_nearest))
summary(match_nearest)
plot(match_nearest, type="hist")
plot(match_nearest, type = "jitter", interactive = FALSE)


v <- data.frame(old = c("distance", "ns(age, df = 2)_1", "ns(age, df = 2)_2", "sex_Male", "stage_III", 
                        "High_center", "STAD_MSI_center", "GS_center", "EBV_center", "CIN_center", "MSI_center",
                        "EMT_center", "TP53neg_center", "TP53pos_center","tumour_location_coarse_Proximal",
                        "study_ACRG","study_Kosin", "study_KUGH", "study_Samsung", "study_TCGA", "study_Yonsei MDACC",
                        "lauren_class_Intestinal","lauren_class_Diffuse","lauren_class_Mixed"),
                new = c("Propensity Score","Natural Cubic Spline(Age_1)", "Natural Cubic Spline(Age_2)", "Male",
                        "Stage III", "TME High", "STAD MSI", "GS", 
                        "EBV", "CIN", "MSI", "EMT", "MSS TP53-", "MSS TP53+", "Location:Proximal", "Study:ACRG", 
                        "Study:Kosin", "Study:KUGH", "Study:Samsung", "Study:TCGA", "Study:Yonsei MDACC", 
                        "Lauren Class:Intestinal","Lauren Class:Diffuse","Lauren Class:Mixed"))


love.plot(match_nearest, 
          binary = "std", 
          thresholds = c(m = .1), 
          abs =TRUE, 
          line=TRUE,
          position = "bottom", 
          var.order = "unadjusted",
          sample.names = c("Unmatched", "Matched"),
          var.names = v) +
  theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.box.background = element_rect(), 
                      legend.position = c(0.85,0.12))
 
#Because I have used calipers and discard patients it is not estimating ATT or ATC exactly... instead I am estimating the effects on my matched patients... thus the results are less generalizable. However we are interested in predicting subgroup responses so this is okay. That is, we are looking at signals to produce future hypotheses to test in better controlled observational studies or randomised clinical trials

model_3_ATC_cont_CI = match.data(match_nearest)
model_3_ATC_cont_CI <- model_3_ATC_cont_CI %>% filter("study" != "Samsung") %>% droplevels()

```
#Model 3 Marginal HR treatment and conditional
```{r}
base_model = coxph(Surv(OS_time, OS_status) ~ treatment, weights = weights, data = model_3_ATC_cont_CI, robust = TRUE, cluster = subclass)
summary(base_model)


```
###TME_subtype
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*High_center , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)


```

###ACRG subgroup 
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*MSI_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EMT_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53pos_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*TP53neg_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)
```
###TCGA_subtypes
```{r}
multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*STAD_MSI_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*GS_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*CIN_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

multi.cox = coxph(Surv(OS_time, OS_status) ~ treatment*EBV_center  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
summary(multi.cox)

#STAD_MSI and STAD_CIN have effects near significance which might be worth exploring with simPH
```

###Study subgroup analysis
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + study , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)

study_cox = coxph(Surv(OS_time, OS_status) ~ treatment*study , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(study_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, study_cox, test = "Chisq")
car::Anova(study_cox, test.statistic="Wald")

interaction_effects = publish(study_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Tumour location 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + tumour_location_coarse  ,data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)

location_cox = coxph(Surv(OS_time, OS_status) ~ treatment*tumour_location_coarse , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(location_cox)
#Test for overall interaction across ACRG subtypes with treatment
s

waldtest(base, location_cox, test = "Chisq")
car::Anova(location_cox, test.statistic="Wald")

interaction_effects = publish(location_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

###Stage subgroup 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + stage  ,data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)

stage_cox = coxph(Surv(OS_time, OS_status) ~ treatment*stage  , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(stage_cox)
s
#Test for overall interaction across stage with treatment

waldtest(base, stage_cox, test = "Chisq")
car::Anova(stage_cox, test.statistic="Wald")


interaction_effects = publish(stage_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]

```
###Lauren Classification 
```{r}
base = coxph(Surv(OS_time, OS_status) ~ treatment + lauren_class  ,data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)

lauren_cox = coxph(Surv(OS_time, OS_status) ~ treatment*lauren_class , data = model_3_ATC_cont_CI, weights = weights,robust = TRUE, cluster = subclass)
s=summary(lauren_cox)
s
#Test for overall interaction across ACRG subtypes with treatment

waldtest(base, lauren_cox, test = "Chisq")
car::Anova(lauren_cox, test.statistic="Wald")

interaction_effects = publish(lauren_cox)
interaction_effects$rawTable
interaction_effects$rawTable[,3:5]
```

#****SimPH
#simPH for TME high, STAD MSI and CIN
```{r}
library(simPH)
```
```{r}
model_3_ATC_cont$treatment <- ifelse(model_3_ATC_cont$treatment == "TRUE", 1, 0)
model_3_ATC_cont$treatment =  as.factor(model_3_ATC_cont$treatment)
model_3_ATC_cont$study = factor(model_3_ATC_cont$study)

#TME HIGH
interaction =  coxph(Surv(OS_time, OS_status) ~ High_center*treatment + study, data = model_3_ATC_cont, weights = weights,robust = TRUE, cluster = subclass)

Sim_TME <- coxsimInteract(interaction, b1 = "High_center", b2 = "treatment1",
                    X1 =seq(-0.9918 , 1.2390    , by = 0.1),
                    X2 = c(0, 1),
                    qi = "Hazard Ratio", ci = 0.95,extremesDrop = TRUE, nsim=500, spin = TRUE)

simGG(Sim_TME)
simGG(Sim_TME,type="lines", alpha = 0.05)
Sim_TME[["sims"]]$QI = log(Sim_TME[["sims"]]$QI)
Sim_TME_plot = simGG(Sim_TME, type="lines", alpha = 0.05, ylab="Log Hazard Ratio", xlab="TME High Score (Z-score)", labs(colour="Chemotherapy Status"))
Sim_TME_plot[["layers"]][[3]]$mapping$yintercept = Sim_TME_plot[["layers"]][[3]]$mapping$yintercept=0
Sim_TME_plot

Sim_TME_plot_final = Sim_TME_plot  + 
            scale_colour_manual(name = "Treatment", labels = c("No Chemotherapy", "Chemotherapy"), values = c("#E41A1C", "#377EB8"), guide = guide_legend(reverse=TRUE)) + 
            ggtitle("Interaction effect of Chemotherapy according to TME High Score") +
            annotate(geom="text",x = -1, y=0.75 , label = "HR 0.59 [95%CI 0.37,0.97]; p=0.04*;\nE-Value: HR 2.24 [95%CI 1.17,NA] ", size = 4.5, hjust=0) +
            theme(plot.title = element_text(colour="black", size=13)) +
            theme(axis.text.x = element_text(colour="black", size = 13)) +
            theme(axis.text.y = element_text(colour="black", size = 13)) +
            theme(axis.title.x = element_text(colour="black", size=13)) +
            theme(axis.title.y = element_text(colour="black", size=13)) +
            theme(legend.title = element_text(color = "black", size = 13),
                  legend.text = element_text(color = "black", size = 13),
                  legend.position = c(0.25, 0.25), 
                  legend.background = element_rect(size=0.5, linetype="solid", colour ="black"))
            

ggsave("Sim_TME_plot_final.png", Sim_TME_plot_final, width=6, height=4)
ggsave("Sim_TME_plot_final.svg", Sim_TME_plot_final, width=6, height=4)

```
#Proportional hazards assumption 
```{r}
test_interaction_model = cox.zph(interaction)

colnames(test_interaction_model$y) = c("TME High", "Treatment", "Study", "TME High:Treatment")

interaction_ph_assumption = ggcoxzph(test_interaction_model)

svg(filename="interaction_ph_assumption.svg", width=12, height=8)
interaction_ph_assumption
dev.off()



```

#FORESTPLOTS II-IV stage continuous
```{r}
#Imported table text   
urlfile<-'https://raw.githubusercontent.com/skubleny/Integrated-Molecular-Classification-GC/main/Data/multivariate_survival_stageII-IV_cont.txt'
table_text<-read.delim(urlfile, comment.char="#", header=FALSE)
table_data<-read.delim(urlfile, comment.char="#")


table_text[-1,3] = paste0((table_text[-1,4]), " (", 
              paste(table_text[-1,5], table_text[-1,6], sep = ', '), ")") 
table_text[ table_text == " (, )" ] = NA

table_text = as.matrix(table_text)
table_text = na_if(table_text, '')


subgps <- c(3,5,6,7,8,10,11,12,13,15,16,17,18,19,21,22,24,25,26,28,29,30)
table_text[subgps] <- paste("  ",table_text[subgps]) 

forestplot_match_model3ATC_cont = forestplot(labeltext = as.matrix(table_text[,-c(4:6)]),graph.pos=3, mean = cbind(c(NA, table_data$hazard)),lower = cbind(c(NA, table_data$lower)) ,upper = cbind(c(NA, table_data$upper)), 
           new_page = TRUE,
           zero = 1,
           lwd.zero = 1,
           colgap = unit(1,"mm"),
           lineheight = unit(5.5,"mm"),
           line.margin = unit(0.1,"mm"),
           graphwidth = unit(50,"mm"),
           clip = c(0.1, 5), 
           align = c("l", "c", "l","l"),
           grid = structure((0.6589), gp = gpar(col = "black", lty = 2, lwd = 1.5)),
           is.summary = c(TRUE, TRUE, FALSE, TRUE,rep(FALSE, 4),TRUE,rep(FALSE, 4), TRUE,rep(FALSE, 5), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 3), TRUE,rep(FALSE, 3), TRUE),
           xlog=TRUE,
           vertices = TRUE,
           ci.vertices.height = 0.25,
           lwd.ci = 2.5,
           xticks = c(0.1,0.25, 0.5, 1, 2, 4), 
           col = fpColors(box = "skyblue3", lines = "skyblue3", zero="black"),
           txt_gp = fpTxtGp(label = gpar(ps= 7, align ="left"),
                            ticks = gpar(ps= 7, cex = 1),
                            xlab = gpar(ps= 7, cex = 1)),
           hrzl_lines = list("2" = gpar(lwd = 1, columns = c(1:5), col = "black"), 
                            "32" = gpar(lwd = 1, columns = c(1:2,4:5), col = "black")),
           xlab  = "Hazard Ratio (95% CI)")


svg("forestplot_match_model3ATC_cont.svg", width=12, height=10)
forestplot_match_model3ATC_cont
dev.off()

png("forestplot_match_model3ATC_cont.png", width = 4, height = 3, units = 'in', res = 300)
forestplot_match_model3ATC_cont
dev.off()


```


#Table ones
```{r}

####### all stage discrete
model_3_ATC_allstage = as.data.frame(model_3_ATC_allstage)
model_3_ATC_allstage$study = factor(model_3_ATC_allstage$study)

all_stage_tb1 = survey::svydesign(id=~subclass, weights = ~weights, data = model_3_ATC_allstage, nest = TRUE)

all_stage_discrete = tbl_svysummary(all_stage_tb1,by = "treatment", percent = "column", include=c("age", "stage", "sex","TME_subtype_cal", "TCGA_subtype", "ACRG_subtype","study","tumour_location_coarse", "lauren_class")) %>% 
      add_p() %>%
      add_overall()


tb_all_stage_discrete = as_flex_table(
  all_stage_discrete,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("tb_all_stage_discrete" = tb_all_stage_discrete,path = "# make file name")

#####stage II-IV continuous 

model_3_ATC_cont = as.data.frame(model_3_ATC_cont)
model_3_ATC_cont$study = factor(model_3_ATC_cont$study)

model_3_ATC_cont_svy = survey::svydesign(id=~subclass, weights = ~weights, data = model_3_ATC_cont, nest = TRUE)

model_3_ATC_cont_tb1 = tbl_svysummary(model_3_ATC_cont_svy,by = "treatment", percent = "column", include=c("age", "stage", "sex","TME_subtype_cal", "TCGA_subtype", "ACRG_subtype","study","tumour_location_coarse", "lauren_class")) %>% 
      add_p() %>%
      add_overall()


tb_model_3_ATC_cont_tb1 = as_flex_table(
  model_3_ATC_cont_tb1,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
save_as_docx("tb_model_3_ATC_cont_tb1" = tb_model_3_ATC_cont_tb1,path = "# make file name")


```
