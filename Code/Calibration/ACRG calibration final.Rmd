---
title: "acrg calibration"
author: "Daniel Skubleny"
date: "26/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



#Plan
```{r}
#Plan is to have calibration metrics (conf-MCE, conf-ECE, cw-ECE, multiclass brier and cw-brier) for each fold for the basic uncalibrated pseudo-probabilities and 3 other models (1 = dirichlet calibrated with multinom and decay, 2 = multinomial glmnet with ElasticNet regularization (tuned for lambda and alpha), 3 = dirichlet with L2 regularization (tuned for lambda). We will use logloss as a metric in keeping with the dirichlet paper 
```
#CV1////////
```{r}
trainData_ACRG1 = subtype_ACRG[trainRowNumbers_ACRG$Resample01,]
testData_ACRG1 = subtype_ACRG[-trainRowNumbers_ACRG$Resample01,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_1_train = dplyr::select(trainData_ACRG1, "Subtype")
cal_1_train = predict(gbm.svm.ACRG.model1,newdata = svm.train1, type="prob")
cal_1_train_class = predict(gbm.svm.ACRG.model1,newdata = svm.train1, type="raw")
class_1_train = tibble::rownames_to_column(class_1_train, "patient_id")
cal_1_train = tibble::rownames_to_column(cal_1_train, "patient_id")
cal_data1_train = merge(class_1_train,cal_1_train, by="patient_id")
cal_data1_train = tibble::column_to_rownames(cal_data1_train, "patient_id")

train_prob1 = cal_1_train[,2:5]
train_prob1 = as.data.frame(log(train_prob1))
```
#Uncalibrated
```{r}
#Outer fold test data
class_1 = dplyr::select(testData_ACRG1, "Subtype")
cal_1 = predict(gbm.svm.ACRG.model1,newdata = svm.test1, type="prob")
cal_1_class = predict(gbm.svm.ACRG.model1,newdata = svm.test1, type="raw")
class_1 = tibble::rownames_to_column(class_1, "patient_id")
cal_1 = tibble::rownames_to_column(cal_1, "patient_id")
cal_data1 = merge(class_1,cal_1, by="patient_id")
cal_data1 = tibble::column_to_rownames(cal_data1, "patient_id")

test_prob1 = cal_1[,2:5]
test_prob1 = as.data.frame(log(test_prob1)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal1 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_1[,2:5]
data_dir_cal$true_class = class_1[,2]
data_dir_cal$pred_class = cal_1_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal1 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal1plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal1 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal1plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal1 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal1plotdata = conf_ece_dir
cw_MSI_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal1 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal1plotdata = conf_ece_dir
cw_EMT_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal1 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal1_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal1 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal1 = max(absolute_diff)
```
```{r}
acc_uncal1 = confusionMatrix(as.factor(class_1[,2]), as.factor(cal_1_class))

cw_uncal_ece1 = 0.25*(cw_MSS_TP53neg_mce_uncal1 + 
                 cw_MSS_TP53pos_mce_uncal1 + 
                 cw_MSI_ece_uncal1 + 
                 cw_EMT_ece_uncal1)

cw_uncal_mce1 = max(c(cw_MSS_TP53pos_mce_uncal1, 
               cw_MSS_TP53pos_mce_uncal1 ,
               cw_MSI_mce_uncal1, 
               cw_EMT_mce_uncal1))


dirichlet_cal_prob = (cal_1[,2:5])/rowSums(cal_1[,2:5])
brier.uncal_prob1 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_1[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_1_class = predict(dirichlet_cal,newdata = test_prob1, type="raw")
dirichlet_cal_1_prob = predict(dirichlet_cal,newdata = test_prob1, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_1_prob
data_dir_cal$true_class = class_1[,2]
data_dir_cal$pred_class = dirichlet_cal_1_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal1 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir1plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir1 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir1plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir1 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir1plotdata = conf_ece_dir
cw_MSI_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir1 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir1plotdata = conf_ece_dir
cw_EMT_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir1 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir1_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir1 <- weighted.mean(absolute_diff, weight)
conf_mce_dir1 = max(absolute_diff)
```
```{r}
acc_dir1 = confusionMatrix(as.factor(class_1[,2]), as.factor(dirichlet_cal_1_class))


cw_dir_ece1 = 0.25*(cw_MSS_TP53neg_ece_dir1 + 
                 cw_MSS_TP53pos_ece_dir1 + 
                 cw_MSI_ece_dir1 + 
                 cw_EMT_ece_dir1)

cw_dir_mce1 = max(c(cw_MSS_TP53neg_mce_dir1, 
               cw_MSS_TP53pos_mce_dir1 ,
               cw_MSI_mce_dir1, 
               cw_EMT_mce_dir1))
#Brier
dirichlet_cal_prob = (dirichlet_cal_1_prob)/rowSums(dirichlet_cal_1_prob)
brier.dirichlet_cal_prob1 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_1[,2]))
```

#CV2////////
```{r}
trainData_ACRG2 = subtype_ACRG[trainRowNumbers_ACRG$Resample02,]
testData_ACRG2 = subtype_ACRG[-trainRowNumbers_ACRG$Resample02,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_2_train = dplyr::select(trainData_ACRG2, "Subtype")
cal_2_train = predict(gbm.svm.ACRG.model2,newdata = svm.train2, type="prob")
cal_2_train_class = predict(gbm.svm.ACRG.model2,newdata = svm.train2, type="raw")
class_2_train = tibble::rownames_to_column(class_2_train, "patient_id")
cal_2_train = tibble::rownames_to_column(cal_2_train, "patient_id")
cal_data2_train = merge(class_2_train,cal_2_train, by="patient_id")
cal_data2_train = tibble::column_to_rownames(cal_data2_train, "patient_id")

train_prob2 = cal_2_train[,2:5]
train_prob2 = as.data.frame(log(train_prob2))
```
#Uncalibrated
```{r}
#Outer fold test data
class_2 = dplyr::select(testData_ACRG2, "Subtype")
cal_2 = predict(gbm.svm.ACRG.model2,newdata = svm.test2, type="prob")
cal_2_class = predict(gbm.svm.ACRG.model2,newdata = svm.test2, type="raw")
class_2 = tibble::rownames_to_column(class_2, "patient_id")
cal_2 = tibble::rownames_to_column(cal_2, "patient_id")
cal_data2 = merge(class_2,cal_2, by="patient_id")
cal_data2 = tibble::column_to_rownames(cal_data2, "patient_id")

test_prob2 = cal_2[,2:5]
test_prob2 = as.data.frame(log(test_prob2)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob2,as.factor(class_2_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal2 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_2[,2:5]
data_dir_cal$true_class = class_2[,2]
data_dir_cal$pred_class = cal_2_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal2 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal2plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal2 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal2plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal2 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal2plotdata = conf_ece_dir
cw_MSI_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal2 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal2plotdata = conf_ece_dir
cw_EMT_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal2 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal2_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal2 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal2 = max(absolute_diff)
```
```{r}
acc_uncal2 = confusionMatrix(as.factor(class_2[,2]), as.factor(cal_2_class))

cw_uncal_ece2 = 0.25*(cw_MSS_TP53neg_mce_uncal2 + 
                 cw_MSS_TP53pos_mce_uncal2 + 
                 cw_MSI_ece_uncal2 + 
                 cw_EMT_ece_uncal2)

cw_uncal_mce2 = max(c(cw_MSS_TP53pos_mce_uncal2, 
               cw_MSS_TP53pos_mce_uncal2 ,
               cw_MSI_mce_uncal2, 
               cw_EMT_mce_uncal2))


dirichlet_cal_prob = (cal_2[,2:5])/rowSums(cal_2[,2:5])
brier.uncal_prob2 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_2[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_2_class = predict(dirichlet_cal,newdata = test_prob2, type="raw")
dirichlet_cal_2_prob = predict(dirichlet_cal,newdata = test_prob2, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_2_prob
data_dir_cal$true_class = class_2[,2]
data_dir_cal$pred_class = dirichlet_cal_2_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal2 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir2plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir2 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir2plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir2 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir2plotdata = conf_ece_dir
cw_MSI_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir2 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir2plotdata = conf_ece_dir
cw_EMT_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir2 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir2_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir2 <- weighted.mean(absolute_diff, weight)
conf_mce_dir2 = max(absolute_diff)
```
```{r}
acc_dir2 = confusionMatrix(as.factor(class_2[,2]), as.factor(dirichlet_cal_2_class))


cw_dir_ece2 = 0.25*(cw_MSS_TP53neg_ece_dir2 + 
                 cw_MSS_TP53pos_ece_dir2 + 
                 cw_MSI_ece_dir2 + 
                 cw_EMT_ece_dir2)

cw_dir_mce2 = max(c(cw_MSS_TP53neg_mce_dir2, 
               cw_MSS_TP53pos_mce_dir2 ,
               cw_MSI_mce_dir2, 
               cw_EMT_mce_dir2))
#Brier
dirichlet_cal_prob = (dirichlet_cal_2_prob)/rowSums(dirichlet_cal_2_prob)
brier.dirichlet_cal_prob2 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_2[,2]))
```


#CV3////////
```{r}
trainData_ACRG3 = subtype_ACRG[trainRowNumbers_ACRG$Resample03,]
testData_ACRG3 = subtype_ACRG[-trainRowNumbers_ACRG$Resample03,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_3_train = dplyr::select(trainData_ACRG3, "Subtype")
cal_3_train = predict(gbm.svm.ACRG.model3,newdata = svm.train3, type="prob")
cal_3_train_class = predict(gbm.svm.ACRG.model3,newdata = svm.train3, type="raw")
class_3_train = tibble::rownames_to_column(class_3_train, "patient_id")
cal_3_train = tibble::rownames_to_column(cal_3_train, "patient_id")
cal_data3_train = merge(class_3_train,cal_3_train, by="patient_id")
cal_data3_train = tibble::column_to_rownames(cal_data3_train, "patient_id")

train_prob3 = cal_3_train[,2:5]
train_prob3 = as.data.frame(log(train_prob3))
```
#Uncalibrated
```{r}
#Outer fold test data
class_3 = dplyr::select(testData_ACRG3, "Subtype")
cal_3 = predict(gbm.svm.ACRG.model3,newdata = svm.test3, type="prob")
cal_3_class = predict(gbm.svm.ACRG.model3,newdata = svm.test3, type="raw")
class_3 = tibble::rownames_to_column(class_3, "patient_id")
cal_3 = tibble::rownames_to_column(cal_3, "patient_id")
cal_data3 = merge(class_3,cal_3, by="patient_id")
cal_data3 = tibble::column_to_rownames(cal_data3, "patient_id")

test_prob3 = cal_3[,2:5]
test_prob3 = as.data.frame(log(test_prob3)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal3 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_3[,2:5]
data_dir_cal$true_class = class_3[,2]
data_dir_cal$pred_class = cal_3_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal3 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal3plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal3 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal3plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal3 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal3plotdata = conf_ece_dir
cw_MSI_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal3 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal3plotdata = conf_ece_dir
cw_EMT_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal3 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal3_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal3 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal3 = max(absolute_diff)
```
```{r}
acc_uncal3 = confusionMatrix(as.factor(class_3[,2]), as.factor(cal_3_class))

cw_uncal_ece3 = 0.25*(cw_MSS_TP53neg_mce_uncal3 + 
                 cw_MSS_TP53pos_mce_uncal3 + 
                 cw_MSI_ece_uncal3 + 
                 cw_EMT_ece_uncal3)

cw_uncal_mce3 = max(c(cw_MSS_TP53pos_mce_uncal3, 
               cw_MSS_TP53pos_mce_uncal3 ,
               cw_MSI_mce_uncal3, 
               cw_EMT_mce_uncal3))


dirichlet_cal_prob = (cal_3[,2:5])/rowSums(cal_3[,2:5])
brier.uncal_prob3 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_3[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_3_class = predict(dirichlet_cal,newdata = test_prob3, type="raw")
dirichlet_cal_3_prob = predict(dirichlet_cal,newdata = test_prob3, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_3_prob
data_dir_cal$true_class = class_3[,2]
data_dir_cal$pred_class = dirichlet_cal_3_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal3 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir3plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir3 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir3plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir3 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir3plotdata = conf_ece_dir
cw_MSI_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir3 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir3plotdata = conf_ece_dir
cw_EMT_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir3 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir3_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir3 <- weighted.mean(absolute_diff, weight)
conf_mce_dir3 = max(absolute_diff)
```
```{r}
acc_dir3 = confusionMatrix(as.factor(class_3[,2]), as.factor(dirichlet_cal_3_class))


cw_dir_ece3 = 0.25*(cw_MSS_TP53neg_ece_dir3 + 
                 cw_MSS_TP53pos_ece_dir3 + 
                 cw_MSI_ece_dir3 + 
                 cw_EMT_ece_dir3)

cw_dir_mce3 = max(c(cw_MSS_TP53neg_mce_dir3, 
               cw_MSS_TP53pos_mce_dir3 ,
               cw_MSI_mce_dir3, 
               cw_EMT_mce_dir3))
#Brier
dirichlet_cal_prob = (dirichlet_cal_3_prob)/rowSums(dirichlet_cal_3_prob)
brier.dirichlet_cal_prob3 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_3[,2]))
```

#CV4////////
```{r}
trainData_ACRG4 = subtype_ACRG[trainRowNumbers_ACRG$Resample04,]
testData_ACRG4 = subtype_ACRG[-trainRowNumbers_ACRG$Resample04,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_4_train = dplyr::select(trainData_ACRG4, "Subtype")
cal_4_train = predict(gbm.svm.ACRG.model4,newdata = svm.train4, type="prob")
cal_4_train_class = predict(gbm.svm.ACRG.model4,newdata = svm.train4, type="raw")
class_4_train = tibble::rownames_to_column(class_4_train, "patient_id")
cal_4_train = tibble::rownames_to_column(cal_4_train, "patient_id")
cal_data4_train = merge(class_4_train,cal_4_train, by="patient_id")
cal_data4_train = tibble::column_to_rownames(cal_data4_train, "patient_id")

train_prob4 = cal_4_train[,2:5]
train_prob4 = as.data.frame(log(train_prob4))
```
#Uncalibrated
```{r}
#Outer fold test data
class_4 = dplyr::select(testData_ACRG4, "Subtype")
cal_4 = predict(gbm.svm.ACRG.model4,newdata = svm.test4, type="prob")
cal_4_class = predict(gbm.svm.ACRG.model4,newdata = svm.test4, type="raw")
class_4 = tibble::rownames_to_column(class_4, "patient_id")
cal_4 = tibble::rownames_to_column(cal_4, "patient_id")
cal_data4 = merge(class_4,cal_4, by="patient_id")
cal_data1 = tibble::column_to_rownames(cal_data1, "patient_id")

test_prob4 = cal_4[,2:5]
test_prob4 = as.data.frame(log(test_prob4)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal4 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_4[,2:5]
data_dir_cal$true_class = class_4[,2]
data_dir_cal$pred_class = cal_4_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal4 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal4plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal4 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal4plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal4 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal4plotdata = conf_ece_dir
cw_MSI_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal4 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal4plotdata = conf_ece_dir
cw_EMT_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal4 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal4_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal4 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal4 = max(absolute_diff)
```
```{r}
acc_uncal4 = confusionMatrix(as.factor(class_4[,2]), as.factor(cal_4_class))

cw_uncal_ece4 = 0.25*(cw_MSS_TP53neg_mce_uncal4 + 
                 cw_MSS_TP53pos_mce_uncal4 + 
                 cw_MSI_ece_uncal4 + 
                 cw_EMT_ece_uncal4)

cw_uncal_mce4 = max(c(cw_MSS_TP53pos_mce_uncal4, 
               cw_MSS_TP53pos_mce_uncal4 ,
               cw_MSI_mce_uncal4, 
               cw_EMT_mce_uncal4))


dirichlet_cal_prob = (cal_4[,2:5])/rowSums(cal_4[,2:5])
brier.uncal_prob4 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_4[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_4_class = predict(dirichlet_cal,newdata = test_prob4, type="raw")
dirichlet_cal_4_prob = predict(dirichlet_cal,newdata = test_prob4, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_4_prob
data_dir_cal$true_class = class_4[,2]
data_dir_cal$pred_class = dirichlet_cal_4_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal4 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir4plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir4 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir4plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir4 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir4plotdata = conf_ece_dir
cw_MSI_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir4 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir4plotdata = conf_ece_dir
cw_EMT_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir4 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir4_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir4 <- weighted.mean(absolute_diff, weight)
conf_mce_dir4 = max(absolute_diff)
```
```{r}
acc_dir4 = confusionMatrix(as.factor(class_4[,2]), as.factor(dirichlet_cal_4_class))


cw_dir_ece4 = 0.25*(cw_MSS_TP53neg_ece_dir4 + 
                 cw_MSS_TP53pos_ece_dir4 + 
                 cw_MSI_ece_dir4 + 
                 cw_EMT_ece_dir4)

cw_dir_mce4 = max(c(cw_MSS_TP53neg_mce_dir4, 
               cw_MSS_TP53pos_mce_dir4 ,
               cw_MSI_mce_dir4, 
               cw_EMT_mce_dir4))
#Brier
dirichlet_cal_prob = (dirichlet_cal_4_prob)/rowSums(dirichlet_cal_4_prob)
brier.dirichlet_cal_prob4 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_4[,2]))
```

#CV5////////
```{r}
trainData_ACRG5 = subtype_ACRG[trainRowNumbers_ACRG$Resample05,]
testData_ACRG5 = subtype_ACRG[-trainRowNumbers_ACRG$Resample05,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_5_train = dplyr::select(trainData_ACRG5, "Subtype")
cal_5_train = predict(gbm.svm.ACRG.model5,newdata = svm.train5, type="prob")
cal_5_train_class = predict(gbm.svm.ACRG.model5,newdata = svm.train5, type="raw")
class_5_train = tibble::rownames_to_column(class_5_train, "patient_id")
cal_5_train = tibble::rownames_to_column(cal_5_train, "patient_id")
cal_data5_train = merge(class_5_train,cal_5_train, by="patient_id")
cal_data5_train = tibble::column_to_rownames(cal_data5_train, "patient_id")

train_prob5 = cal_5_train[,2:5]
train_prob5 = as.data.frame(log(train_prob5))
```
#Uncalibrated
```{r}
#Outer fold test data
class_5 = dplyr::select(testData_ACRG5, "Subtype")
cal_5 = predict(gbm.svm.ACRG.model5,newdata = svm.test5, type="prob")
cal_5_class = predict(gbm.svm.ACRG.model5,newdata = svm.test5, type="raw")
class_5 = tibble::rownames_to_column(class_5, "patient_id")
cal_5 = tibble::rownames_to_column(cal_5, "patient_id")
cal_data5 = merge(class_5,cal_5, by="patient_id")
cal_data5 = tibble::column_to_rownames(cal_data5, "patient_id")

test_prob5 = cal_5[,2:5]
test_prob5 = as.data.frame(log(test_prob5)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal5 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_5[,2:5]
data_dir_cal$true_class = class_5[,2]
data_dir_cal$pred_class = cal_5_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal5 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal5plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal5 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal5plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal5 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal5plotdata = conf_ece_dir
cw_MSI_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal5 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal5plotdata = conf_ece_dir
cw_EMT_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal5 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal5_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal5 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal5 = max(absolute_diff)
```
```{r}
acc_uncal5 = confusionMatrix(as.factor(class_5[,2]), as.factor(cal_5_class))

cw_uncal_ece5 = 0.25*(cw_MSS_TP53neg_mce_uncal5 + 
                 cw_MSS_TP53pos_mce_uncal5 + 
                 cw_MSI_ece_uncal5 + 
                 cw_EMT_ece_uncal5)

cw_uncal_mce5 = max(c(cw_MSS_TP53pos_mce_uncal5, 
               cw_MSS_TP53pos_mce_uncal5 ,
               cw_MSI_mce_uncal5, 
               cw_EMT_mce_uncal5))


dirichlet_cal_prob = (cal_5[,2:5])/rowSums(cal_5[,2:5])
brier.uncal_prob5 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_5[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_5_class = predict(dirichlet_cal,newdata = test_prob5, type="raw")
dirichlet_cal_5_prob = predict(dirichlet_cal,newdata = test_prob5, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_5_prob
data_dir_cal$true_class = class_5[,2]
data_dir_cal$pred_class = dirichlet_cal_5_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal5 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir5plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir5 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir5plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir5 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir5plotdata = conf_ece_dir
cw_MSI_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir5 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir5plotdata = conf_ece_dir
cw_EMT_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir5 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir5_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir5 <- weighted.mean(absolute_diff, weight)
conf_mce_dir5 = max(absolute_diff)
```
```{r}
acc_dir5 = confusionMatrix(as.factor(class_5[,2]), as.factor(dirichlet_cal_5_class))


cw_dir_ece5 = 0.25*(cw_MSS_TP53neg_ece_dir5 + 
                 cw_MSS_TP53pos_ece_dir5 + 
                 cw_MSI_ece_dir5 + 
                 cw_EMT_ece_dir5)

cw_dir_mce5 = max(c(cw_MSS_TP53neg_mce_dir5, 
               cw_MSS_TP53pos_mce_dir5 ,
               cw_MSI_mce_dir5, 
               cw_EMT_mce_dir5))
#Brier
dirichlet_cal_prob = (dirichlet_cal_5_prob)/rowSums(dirichlet_cal_5_prob)
brier.dirichlet_cal_prob5 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_5[,2]))
```

#CV6////////
```{r}
trainData_ACRG6 = subtype_ACRG[trainRowNumbers_ACRG$Resample06,]
testData_ACRG6 = subtype_ACRG[-trainRowNumbers_ACRG$Resample06,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_6_train = dplyr::select(trainData_ACRG6, "Subtype")
cal_6_train = predict(gbm.svm.ACRG.model6,newdata = svm.train6, type="prob")
cal_6_train_class = predict(gbm.svm.ACRG.model6,newdata = svm.train6, type="raw")
class_6_train = tibble::rownames_to_column(class_6_train, "patient_id")
cal_6_train = tibble::rownames_to_column(cal_6_train, "patient_id")
cal_data6_train = merge(class_6_train,cal_6_train, by="patient_id")
cal_data6_train = tibble::column_to_rownames(cal_data6_train, "patient_id")

train_prob6 = cal_6_train[,2:5]
train_prob6 = as.data.frame(log(train_prob6))
```
#Uncalibrated
```{r}
#Outer fold test data
class_6 = dplyr::select(testData_ACRG6, "Subtype")
cal_6 = predict(gbm.svm.ACRG.model6,newdata = svm.test6, type="prob")
cal_6_class = predict(gbm.svm.ACRG.model6,newdata = svm.test6, type="raw")
class_6 = tibble::rownames_to_column(class_6, "patient_id")
cal_6 = tibble::rownames_to_column(cal_6, "patient_id")
cal_data6 = merge(class_6,cal_6, by="patient_id")
cal_data6 = tibble::column_to_rownames(cal_data6, "patient_id")

test_prob6 = cal_6[,2:5]
test_prob6 = as.data.frame(log(test_prob6)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal6 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_6[,2:5]
data_dir_cal$true_class = class_6[,2]
data_dir_cal$pred_class = cal_6_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal6 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal6plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal6 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal6plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal6 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal6plotdata = conf_ece_dir
cw_MSI_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal6 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal6plotdata = conf_ece_dir
cw_EMT_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal6 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal6_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal6 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal6 = max(absolute_diff)
```
```{r}
acc_uncal6 = confusionMatrix(as.factor(class_6[,2]), as.factor(cal_6_class))

cw_uncal_ece6 = 0.25*(cw_MSS_TP53neg_mce_uncal6 + 
                 cw_MSS_TP53pos_mce_uncal6 + 
                 cw_MSI_ece_uncal6 + 
                 cw_EMT_ece_uncal6)

cw_uncal_mce6 = max(c(cw_MSS_TP53pos_mce_uncal6, 
               cw_MSS_TP53pos_mce_uncal6 ,
               cw_MSI_mce_uncal6, 
               cw_EMT_mce_uncal6))


dirichlet_cal_prob = (cal_6[,2:5])/rowSums(cal_6[,2:5])
brier.uncal_prob6 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_6[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_6_class = predict(dirichlet_cal,newdata = test_prob6, type="raw")
dirichlet_cal_6_prob = predict(dirichlet_cal,newdata = test_prob6, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_6_prob
data_dir_cal$true_class = class_6[,2]
data_dir_cal$pred_class = dirichlet_cal_6_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal6 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir6plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir6 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir6plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir6 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir6plotdata = conf_ece_dir
cw_MSI_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir6 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir6plotdata = conf_ece_dir
cw_EMT_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir6 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir6_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir6 <- weighted.mean(absolute_diff, weight)
conf_mce_dir6 = max(absolute_diff)
```
```{r}
acc_dir6 = confusionMatrix(as.factor(class_6[,2]), as.factor(dirichlet_cal_6_class))


cw_dir_ece6 = 0.25*(cw_MSS_TP53neg_ece_dir6 + 
                 cw_MSS_TP53pos_ece_dir6 + 
                 cw_MSI_ece_dir6 + 
                 cw_EMT_ece_dir6)

cw_dir_mce6 = max(c(cw_MSS_TP53neg_mce_dir6, 
               cw_MSS_TP53pos_mce_dir6 ,
               cw_MSI_mce_dir6, 
               cw_EMT_mce_dir6))
#Brier
dirichlet_cal_prob = (dirichlet_cal_6_prob)/rowSums(dirichlet_cal_6_prob)
brier.dirichlet_cal_prob6 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_6[,2]))
```

#CV7////////
```{r}
trainData_ACRG7 = subtype_ACRG[trainRowNumbers_ACRG$Resample07,]
testData_ACRG7 = subtype_ACRG[-trainRowNumbers_ACRG$Resample07,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_7_train = dplyr::select(trainData_ACRG7, "Subtype")
cal_7_train = predict(gbm.svm.ACRG.model7,newdata = svm.train7, type="prob")
cal_7_train_class = predict(gbm.svm.ACRG.model7,newdata = svm.train7, type="raw")
class_7_train = tibble::rownames_to_column(class_7_train, "patient_id")
cal_7_train = tibble::rownames_to_column(cal_7_train, "patient_id")
cal_data7_train = merge(class_7_train,cal_7_train, by="patient_id")
cal_data7_train = tibble::column_to_rownames(cal_data7_train, "patient_id")

train_prob7 = cal_7_train[,2:5]
train_prob7 = as.data.frame(log(train_prob7))
```
#Uncalibrated
```{r}
#Outer fold test data
class_7 = dplyr::select(testData_ACRG7, "Subtype")
cal_7 = predict(gbm.svm.ACRG.model7,newdata = svm.test7, type="prob")
cal_7_class = predict(gbm.svm.ACRG.model7,newdata = svm.test7, type="raw")
class_7 = tibble::rownames_to_column(class_7, "patient_id")
cal_7 = tibble::rownames_to_column(cal_7, "patient_id")
cal_data7 = merge(class_7,cal_7, by="patient_id")
cal_data7 = tibble::column_to_rownames(cal_data7, "patient_id")

test_prob7 = cal_7[,2:5]
test_prob7 = as.data.frame(log(test_prob7)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal7 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_7[,2:5]
data_dir_cal$true_class = class_7[,2]
data_dir_cal$pred_class = cal_7_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal7 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal7plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal7 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal7plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal7 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal7plotdata = conf_ece_dir
cw_MSI_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal7 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal7plotdata = conf_ece_dir
cw_EMT_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal7 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal7_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal7 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal7 = max(absolute_diff)
```
```{r}
acc_uncal7 = confusionMatrix(as.factor(class_7[,2]), as.factor(cal_7_class))

cw_uncal_ece7 = 0.25*(cw_MSS_TP53neg_mce_uncal7 + 
                 cw_MSS_TP53pos_mce_uncal7 + 
                 cw_MSI_ece_uncal7 + 
                 cw_EMT_ece_uncal7)

cw_uncal_mce7 = max(c(cw_MSS_TP53pos_mce_uncal7, 
               cw_MSS_TP53pos_mce_uncal7 ,
               cw_MSI_mce_uncal7, 
               cw_EMT_mce_uncal7))


dirichlet_cal_prob = (cal_7[,2:5])/rowSums(cal_7[,2:5])
brier.uncal_prob7 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_7[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_7_class = predict(dirichlet_cal,newdata = test_prob7, type="raw")
dirichlet_cal_7_prob = predict(dirichlet_cal,newdata = test_prob7, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_7_prob
data_dir_cal$true_class = class_7[,2]
data_dir_cal$pred_class = dirichlet_cal_7_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal7 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir7plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir7 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir7plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir7 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir7plotdata = conf_ece_dir
cw_MSI_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir7 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir7plotdata = conf_ece_dir
cw_EMT_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir7 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir7_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir7 <- weighted.mean(absolute_diff, weight)
conf_mce_dir7 = max(absolute_diff)
```
```{r}
acc_dir7 = confusionMatrix(as.factor(class_7[,2]), as.factor(dirichlet_cal_7_class))


cw_dir_ece7 = 0.25*(cw_MSS_TP53neg_ece_dir7 + 
                 cw_MSS_TP53pos_ece_dir7 + 
                 cw_MSI_ece_dir7 + 
                 cw_EMT_ece_dir7)

cw_dir_mce7 = max(c(cw_MSS_TP53neg_mce_dir7, 
               cw_MSS_TP53pos_mce_dir7 ,
               cw_MSI_mce_dir7, 
               cw_EMT_mce_dir7))
#Brier
dirichlet_cal_prob = (dirichlet_cal_7_prob)/rowSums(dirichlet_cal_7_prob)
brier.dirichlet_cal_prob7 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_7[,2]))
```

#CV8////////
```{r}
trainData_ACRG8 = subtype_ACRG[trainRowNumbers_ACRG$Resample08,]
testData_ACRG8 = subtype_ACRG[-trainRowNumbers_ACRG$Resample08,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_8_train = dplyr::select(trainData_ACRG8, "Subtype")
cal_8_train = predict(gbm.svm.ACRG.model8,newdata = svm.train8, type="prob")
cal_8_train_class = predict(gbm.svm.ACRG.model8,newdata = svm.train8, type="raw")
class_8_train = tibble::rownames_to_column(class_8_train, "patient_id")
cal_8_train = tibble::rownames_to_column(cal_8_train, "patient_id")
cal_data8_train = merge(class_8_train,cal_8_train, by="patient_id")
cal_data8_train = tibble::column_to_rownames(cal_data8_train, "patient_id")

train_prob8 = cal_8_train[,2:5]
train_prob8 = as.data.frame(log(train_prob8))
```
#Uncalibrated
```{r}
#Outer fold test data
class_8 = dplyr::select(testData_ACRG8, "Subtype")
cal_8 = predict(gbm.svm.ACRG.model8,newdata = svm.test8, type="prob")
cal_8_class = predict(gbm.svm.ACRG.model8,newdata = svm.test8, type="raw")
class_8 = tibble::rownames_to_column(class_8, "patient_id")
cal_8 = tibble::rownames_to_column(cal_8, "patient_id")
cal_data8 = merge(class_8,cal_8, by="patient_id")
cal_data8 = tibble::column_to_rownames(cal_data8, "patient_id")

test_prob8 = cal_8[,2:5]
test_prob8 = as.data.frame(log(test_prob8)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal8 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_8[,2:5]
data_dir_cal$true_class = class_8[,2]
data_dir_cal$pred_class = cal_8_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal8 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal8plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal8 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal8plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal8 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal8plotdata = conf_ece_dir
cw_MSI_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal8 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal8plotdata = conf_ece_dir
cw_EMT_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal8 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal8_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal8 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal8 = max(absolute_diff)
```
```{r}
acc_uncal8 = confusionMatrix(as.factor(class_8[,2]), as.factor(cal_8_class))

cw_uncal_ece8 = 0.25*(cw_MSS_TP53neg_mce_uncal8 + 
                 cw_MSS_TP53pos_mce_uncal8 + 
                 cw_MSI_ece_uncal8 + 
                 cw_EMT_ece_uncal8)

cw_uncal_mce8 = max(c(cw_MSS_TP53pos_mce_uncal8, 
               cw_MSS_TP53pos_mce_uncal8 ,
               cw_MSI_mce_uncal8, 
               cw_EMT_mce_uncal8))


dirichlet_cal_prob = (cal_8[,2:5])/rowSums(cal_8[,2:5])
brier.uncal_prob8 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_8[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_8_class = predict(dirichlet_cal,newdata = test_prob8, type="raw")
dirichlet_cal_8_prob = predict(dirichlet_cal,newdata = test_prob8, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_8_prob
data_dir_cal$true_class = class_8[,2]
data_dir_cal$pred_class = dirichlet_cal_8_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal8 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir8plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir8 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir8plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir8 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir8plotdata = conf_ece_dir
cw_MSI_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir8 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir8plotdata = conf_ece_dir
cw_EMT_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir8 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir8_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir8 <- weighted.mean(absolute_diff, weight)
conf_mce_dir8 = max(absolute_diff)
```
```{r}
acc_dir8 = confusionMatrix(as.factor(class_8[,2]), as.factor(dirichlet_cal_8_class))


cw_dir_ece8 = 0.25*(cw_MSS_TP53neg_ece_dir8 + 
                 cw_MSS_TP53pos_ece_dir8 + 
                 cw_MSI_ece_dir8 + 
                 cw_EMT_ece_dir8)

cw_dir_mce8 = max(c(cw_MSS_TP53neg_mce_dir8, 
               cw_MSS_TP53pos_mce_dir8 ,
               cw_MSI_mce_dir8, 
               cw_EMT_mce_dir8))
#Brier
dirichlet_cal_prob = (dirichlet_cal_8_prob)/rowSums(dirichlet_cal_8_prob)
brier.dirichlet_cal_prob8 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_8[,2]))
```

#CV9////////
```{r}
trainData_ACRG9 = subtype_ACRG[trainRowNumbers_ACRG$Resample09,]
testData_ACRG9 = subtype_ACRG[-trainRowNumbers_ACRG$Resample09,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_9_train = dplyr::select(trainData_ACRG9, "Subtype")
cal_9_train = predict(gbm.svm.ACRG.model9,newdata = svm.train9, type="prob")
cal_9_train_class = predict(gbm.svm.ACRG.model9,newdata = svm.train9, type="raw")
class_9_train = tibble::rownames_to_column(class_9_train, "patient_id")
cal_9_train = tibble::rownames_to_column(cal_9_train, "patient_id")
cal_data9_train = merge(class_9_train,cal_9_train, by="patient_id")
cal_data9_train = tibble::column_to_rownames(cal_data9_train, "patient_id")

train_prob9 = cal_9_train[,2:5]
train_prob9 = as.data.frame(log(train_prob9))
```
#Uncalibrated
```{r}
#Outer fold test data
class_9 = dplyr::select(testData_ACRG9, "Subtype")
cal_9 = predict(gbm.svm.ACRG.model9,newdata = svm.test9, type="prob")
cal_9_class = predict(gbm.svm.ACRG.model9,newdata = svm.test9, type="raw")
class_9 = tibble::rownames_to_column(class_9, "patient_id")
cal_9 = tibble::rownames_to_column(cal_9, "patient_id")
cal_data9 = merge(class_9,cal_9, by="patient_id")
cal_data9 = tibble::column_to_rownames(cal_data9, "patient_id")

test_prob9 = cal_9[,2:5]
test_prob9 = as.data.frame(log(test_prob9)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal9 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_9[,2:5]
data_dir_cal$true_class = class_9[,2]
data_dir_cal$pred_class = cal_9_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal9 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal9plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal9 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal9plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal9 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal9plotdata = conf_ece_dir
cw_MSI_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal9 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal9plotdata = conf_ece_dir
cw_EMT_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal9 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal9_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal9 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal9 = max(absolute_diff)
```
```{r}
acc_uncal9 = confusionMatrix(as.factor(class_9[,2]), as.factor(cal_9_class))

cw_uncal_ece9 = 0.25*(cw_MSS_TP53neg_mce_uncal9 + 
                 cw_MSS_TP53pos_mce_uncal9 + 
                 cw_MSI_ece_uncal9 + 
                 cw_EMT_ece_uncal9)

cw_uncal_mce9 = max(c(cw_MSS_TP53pos_mce_uncal9, 
               cw_MSS_TP53pos_mce_uncal9 ,
               cw_MSI_mce_uncal9, 
               cw_EMT_mce_uncal9))


dirichlet_cal_prob = (cal_9[,2:5])/rowSums(cal_9[,2:5])
brier.uncal_prob9 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_9[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_9_class = predict(dirichlet_cal,newdata = test_prob9, type="raw")
dirichlet_cal_9_prob = predict(dirichlet_cal,newdata = test_prob9, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_9_prob
data_dir_cal$true_class = class_9[,2]
data_dir_cal$pred_class = dirichlet_cal_9_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal9 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir9plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir9 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir9plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir9 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir9plotdata = conf_ece_dir
cw_MSI_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir9 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir9plotdata = conf_ece_dir
cw_EMT_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir9 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir9_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir9 <- weighted.mean(absolute_diff, weight)
conf_mce_dir9 = max(absolute_diff)
```
```{r}
acc_dir9 = confusionMatrix(as.factor(class_9[,2]), as.factor(dirichlet_cal_9_class))


cw_dir_ece9 = 0.25*(cw_MSS_TP53neg_ece_dir9 + 
                 cw_MSS_TP53pos_ece_dir9 + 
                 cw_MSI_ece_dir9 + 
                 cw_EMT_ece_dir9)

cw_dir_mce9 = max(c(cw_MSS_TP53neg_mce_dir9, 
               cw_MSS_TP53pos_mce_dir9 ,
               cw_MSI_mce_dir9, 
               cw_EMT_mce_dir9))
#Brier
dirichlet_cal_prob = (dirichlet_cal_9_prob)/rowSums(dirichlet_cal_9_prob)
brier.dirichlet_cal_prob9 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_9[,2]))
```

#CV10////////
```{r}
trainData_ACRG10 = subtype_ACRG[trainRowNumbers_ACRG$Resample10,]
testData_ACRG10 = subtype_ACRG[-trainRowNumbers_ACRG$Resample10,]
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_10_train = dplyr::select(trainData_ACRG10, "Subtype")
cal_10_train = predict(gbm.svm.ACRG.model10,newdata = svm.train10, type="prob")
cal_10_train_class = predict(gbm.svm.ACRG.model10,newdata = svm.train10, type="raw")
class_10_train = tibble::rownames_to_column(class_10_train, "patient_id")
cal_10_train = tibble::rownames_to_column(cal_10_train, "patient_id")
cal_data10_train = merge(class_10_train,cal_10_train, by="patient_id")
cal_data10_train = tibble::column_to_rownames(cal_data10_train, "patient_id")

train_prob10 = cal_10_train[,2:5]
train_prob10 = as.data.frame(log(train_prob10))
```
#Uncalibrated
```{r}
#Outer fold test data
class_10 = dplyr::select(testData_ACRG10, "Subtype")
cal_10 = predict(gbm.svm.ACRG.model10,newdata = svm.test10, type="prob")
cal_10_class = predict(gbm.svm.ACRG.model10,newdata = svm.test10, type="raw")
class_10 = tibble::rownames_to_column(class_10, "patient_id")
cal_10 = tibble::rownames_to_column(cal_10, "patient_id")
cal_data10 = merge(class_10,cal_10, by="patient_id")
cal_data10 = tibble::column_to_rownames(cal_data10, "patient_id")

test_prob10 = cal_10[,2:5]
test_prob10 = as.data.frame(log(test_prob10)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal10 = dirichlet_cal
```


####ORGANIZE DATA 
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_10[,2:5]
data_dir_cal$true_class = class_10[,2]
data_dir_cal$pred_class = cal_10_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_uncal10 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_uncal10plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_uncal10 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_uncal10plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_uncal10 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal10plotdata = conf_ece_dir
cw_MSI_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal10 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_uncal10plotdata = conf_ece_dir
cw_EMT_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_uncal10 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal10_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal10 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal10 = max(absolute_diff)
```
```{r}
acc_uncal10 = confusionMatrix(as.factor(class_10[,2]), as.factor(cal_10_class))

cw_uncal_ece10 = 0.25*(cw_MSS_TP53neg_mce_uncal10 + 
                 cw_MSS_TP53pos_mce_uncal10 + 
                 cw_MSI_ece_uncal10 + 
                 cw_EMT_ece_uncal10)

cw_uncal_mce10 = max(c(cw_MSS_TP53pos_mce_uncal10, 
               cw_MSS_TP53pos_mce_uncal10 ,
               cw_MSI_mce_uncal10, 
               cw_EMT_mce_uncal10))


dirichlet_cal_prob = (cal_10[,2:5])/rowSums(cal_10[,2:5])
brier.uncal_prob10 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_10[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_10_class = predict(dirichlet_cal,newdata = test_prob10, type="raw")
dirichlet_cal_10_prob = predict(dirichlet_cal,newdata = test_prob10, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_10_prob
data_dir_cal$true_class = class_10[,2]
data_dir_cal$pred_class = dirichlet_cal_10_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("MSS_TP53neg", "MSS_TP53pos", "MSI", "EMT", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$MSS_TP53neg_bin = cut(data_dir_cal$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSS_TP53pos_bin = cut(data_dir_cal$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$MSI_bin = cut(data_dir_cal$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$EMT_bin = cut(data_dir_cal$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$MSS_TP53neg_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "MSS_TP53neg", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53neg_subtype = as.factor(data_dir_cal$MSS_TP53neg_subtype)
data_dir_cal$MSS_TP53neg_subtype <- factor(data_dir_cal$MSS_TP53neg_subtype, levels = c("MSS_TP53neg", "Other"))

data_dir_cal$MSS_TP53pos_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "MSS_TP53pos", "MSI" = "Other", "EMT" = "Other"))
data_dir_cal$MSS_TP53pos_subtype = as.factor(data_dir_cal$MSS_TP53pos_subtype)
data_dir_cal$MSS_TP53pos_subtype <- factor(data_dir_cal$MSS_TP53pos_subtype, levels = c("MSS_TP53pos", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "MSI", "EMT" = "Other"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("MSI", "Other"))

data_dir_cal$EMT_subtype = str_replace_all(data_dir_cal$true_class, c("MSS_TP53neg" = "Other", "MSS_TP53pos" = "Other", "MSI" = "Other", "EMT" = "EMT"))
data_dir_cal$EMT_subtype = as.factor(data_dir_cal$EMT_subtype)
data_dir_cal$EMT_subtype <- factor(data_dir_cal$EMT_subtype, levels = c("EMT", "Other"))
```
```{r}
data_dir_cal10 = data_dir_cal
```
#####cw_MSS_TP53neg
```{r}
cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53neg_ece_dir10plotdata = conf_ece_dir
cw_MSS_TP53neg_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53neg_mce_dir10 = max(absolute_diff)
```
#####cw_MSS_TP53pos
```{r}
cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSS_TP53pos_dir10plotdata = conf_ece_dir
cw_MSS_TP53pos_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_MSS_TP53pos_mce_dir10 = max(absolute_diff)
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir10plotdata = conf_ece_dir
cw_MSI_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir10 = max(absolute_diff)
```
#####cw_EMT
```{r}
cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EMT_ece_dir10plotdata = conf_ece_dir
cw_EMT_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_EMT_mce_dir10 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir10_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir10 <- weighted.mean(absolute_diff, weight)
conf_mce_dir10 = max(absolute_diff)
```
```{r}
acc_dir10 = confusionMatrix(as.factor(class_10[,2]), as.factor(dirichlet_cal_10_class))


cw_dir_ece10 = 0.25*(cw_MSS_TP53neg_ece_dir10 + 
                 cw_MSS_TP53pos_ece_dir10 + 
                 cw_MSI_ece_dir10 + 
                 cw_EMT_ece_dir10)

cw_dir_mce10 = max(c(cw_MSS_TP53neg_mce_dir10, 
               cw_MSS_TP53pos_mce_dir10 ,
               cw_MSI_mce_dir10, 
               cw_EMT_mce_dir10))
#Brier
dirichlet_cal_prob = (dirichlet_cal_10_prob)/rowSums(dirichlet_cal_10_prob)
brier.dirichlet_cal_prob10 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_10[,2]))
```




#Compile Dirichlet
```{r}
conf_ece_dir = mget(ls(pattern = 'conf_ece_dir\\d+'))
conf_ece_dir = data.frame(matrix(unlist(conf_ece_dir), nrow=length(conf_ece_dir), byrow=TRUE))  
colnames(conf_ece_dir) <- c("conf_ece_dir")

conf_mce_dir = mget(ls(pattern = 'conf_mce_dir\\d+'))
conf_mce_dir = data.frame(matrix(unlist(conf_mce_dir), nrow=length(conf_mce_dir), byrow=TRUE))  
colnames(conf_mce_dir) <- c("conf_mce_dir")

cw_dir_ece = mget(ls(pattern = 'cw_dir_ece\\d+'))
cw_dir_ece = data.frame(matrix(unlist(cw_dir_ece), nrow=length(cw_dir_ece), byrow=TRUE))  
colnames(cw_dir_ece) <- c("cw_ece_dir")

cw_dir_mce = mget(ls(pattern = 'cw_dir_mce\\d+'))
cw_dir_mce = data.frame(matrix(unlist(cw_dir_mce), nrow=length(cw_dir_mce), byrow=TRUE))  
colnames(cw_dir_mce) <- c("cw_mce_dir")

brier_dirichlet = mget(ls(pattern = 'brier.dirichlet_cal_prob\\d+'))
brier_dirichlet = data.frame(matrix(unlist(brier_dirichlet), nrow=length(brier_dirichlet), byrow=TRUE))  
colnames(brier_dirichlet) <- c("brier_dirichlet")

total_list <- lapply(mget(ls(pattern = 'acc_dir\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
dirichlet_accuracy <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(dirichlet_accuracy) <- c("Accuracy", "Kappa")

dirichlet_metrics = data.frame(dirichlet_accuracy, conf_ece_dir, conf_mce_dir, cw_dir_ece, cw_dir_mce, brier_dirichlet)

data_dir_cal_final = mget(ls(pattern = 'data_dir_cal\\d+'))
data_dir_cal_final = do.call(rbind, data_dir_cal_final)
```
```{r}
mean = lapply(dirichlet_metrics, mean)
sd = lapply(dirichlet_metrics, sd)

dirichlet_metrics_mean = melt(mean)
dirichlet_metrics_sd = melt(sd)
```
#Compile Uncal
```{r}
conf_ece_uncal = mget(ls(pattern = 'conf_ece_uncal\\d+'))
conf_ece_uncal = data.frame(matrix(unlist(conf_ece_uncal), nrow=length(conf_ece_uncal), byrow=TRUE))  
colnames(conf_ece_uncal) <- c("conf_ece_uncal")

conf_mce_uncal = mget(ls(pattern = 'conf_mce_uncal\\d+'))
conf_mce_uncal = data.frame(matrix(unlist(conf_mce_uncal), nrow=length(conf_mce_uncal), byrow=TRUE))  
colnames(conf_mce_uncal) <- c("conf_mce_uncal")

cw_uncal_ece = mget(ls(pattern = 'cw_uncal_ece\\d+'))
cw_uncal_ece = data.frame(matrix(unlist(cw_uncal_ece), nrow=length(cw_uncal_ece), byrow=TRUE))  
colnames(cw_uncal_ece) <- c("cw_ece_uncal")

cw_uncal_mce = mget(ls(pattern = 'cw_uncal_mce\\d+'))
cw_uncal_mce = data.frame(matrix(unlist(cw_uncal_mce), nrow=length(cw_uncal_mce), byrow=TRUE))  
colnames(cw_uncal_mce) <- c("cw_mce_uncal")

brier_uncal = mget(ls(pattern = 'brier.uncal_prob\\d+'))
brier_uncal = data.frame(matrix(unlist(brier_uncal), nrow=length(brier_uncal), byrow=TRUE))  
colnames(brier_uncal) <- c("brier_uncal")

total_list <- lapply(mget(ls(pattern = 'acc_uncal\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
uncal_accuracy <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(uncal_accuracy) <- c("Accuracy", "Kappa")

uncal_metrics = data.frame(uncal_accuracy, conf_ece_uncal, conf_mce_uncal, cw_uncal_ece, cw_uncal_mce, brier_uncal)

data_dir_uncal = mget(ls(pattern = 'data_dir_uncal\\d+'))
data_dir_uncal = do.call(rbind, data_dir_uncal)
```
```{r}
mean = lapply(uncal_metrics, mean)
sd = lapply(uncal_metrics, sd)

uncal_metrics_mean = melt(mean)
uncal_metrics_sd = melt(sd)
```


#SKCE per fold uncal
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_uncal1[,1:4])
outcomes = as.numeric(data_dir_uncal1$true_class)
outcomes = as.integer(outcomes)
skce_uncal1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal2[,1:4])
outcomes = as.numeric(data_dir_uncal2$true_class)
outcomes = as.integer(outcomes)
skce_uncal2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal3[,1:4])
outcomes = as.numeric(data_dir_uncal3$true_class)
outcomes = as.integer(outcomes)
skce_uncal3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal4[,1:4])
outcomes = as.numeric(data_dir_uncal4$true_class)
outcomes = as.integer(outcomes)
skce_uncal4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal5[,1:4])
outcomes = as.numeric(data_dir_uncal5$true_class)
outcomes = as.integer(outcomes)
skce_uncal5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal6[,1:4])
outcomes = as.numeric(data_dir_uncal6$true_class)
outcomes = as.integer(outcomes)
skce_uncal6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal7[,1:4])
outcomes = as.numeric(data_dir_uncal7$true_class)
outcomes = as.integer(outcomes)
skce_uncal7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal8[,1:4])
outcomes = as.numeric(data_dir_uncal8$true_class)
outcomes = as.integer(outcomes)
skce_uncal8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal9[,1:4])
outcomes = as.numeric(data_dir_uncal9$true_class)
outcomes = as.integer(outcomes)
skce_uncal9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal10[,1:4])
outcomes = as.numeric(data_dir_uncal10$true_class)
outcomes = as.integer(outcomes)
skce_uncal10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_uncal = mget(ls(pattern = 'skce_uncal\\d+'))
skce_uncal = data.frame(matrix(unlist(skce_uncal), nrow=length(skce_uncal), byrow=TRUE))  
colnames(skce_uncal) <- c("skce_uncal")

skce_uncal_summary <- summarySE(skce_uncal, measurevar="skce_uncal")
```
#SKCE per fold dir logloss
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(data_dir_cal1$true_class)
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(data_dir_cal2$true_class)
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(data_dir_cal3$true_class)
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(data_dir_cal4$true_class)
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(data_dir_cal5$true_class)
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(data_dir_cal6$true_class)
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(data_dir_cal7$true_class)
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(data_dir_cal8$true_class)
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(data_dir_cal9$true_class)
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(data_dir_cal10$true_class)
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_dir = mget(ls(pattern = 'skce_dir\\d+'))
skce_dir = data.frame(matrix(unlist(skce_dir), nrow=length(skce_dir), byrow=TRUE))  
colnames(skce_dir) <- c("skce_dir")

skce_dir_summary <- summarySE(skce_dir, measurevar="skce_dir")

```
#SKCE per fold dir accuracy
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(data_dir_cal1$true_class)
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(data_dir_cal2$true_class)
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(data_dir_cal3$true_class)
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(data_dir_cal4$true_class)
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(data_dir_cal5$true_class)
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(data_dir_cal6$true_class)
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(data_dir_cal7$true_class)
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(data_dir_cal8$true_class)
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(data_dir_cal9$true_class)
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(data_dir_cal10$true_class)
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_dir_acc = mget(ls(pattern = 'skce_dir\\d+'))
skce_dir_acc = data.frame(matrix(unlist(skce_dir_acc), nrow=length(skce_dir_acc), byrow=TRUE))  
colnames(skce_dir_acc) <- c("skce_dir_acc")

skce_dir_acc_summary <- summarySE(skce_dir_acc, measurevar="skce_dir_acc")

```
#SKCE per fold multinom logloss
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(data_dir_cal1$true_class)
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(data_dir_cal2$true_class)
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(data_dir_cal3$true_class)
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(data_dir_cal4$true_class)
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(data_dir_cal5$true_class)
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(data_dir_cal6$true_class)
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(data_dir_cal7$true_class)
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(data_dir_cal8$true_class)
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(data_dir_cal9$true_class)
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(data_dir_cal10$true_class)
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)


skce_multinom = mget(ls(pattern = 'skce_dir\\d+'))
skce_multinom = data.frame(matrix(unlist(skce_multinom), nrow=length(skce_multinom), byrow=TRUE))  
colnames(skce_multinom) <- c("skce_multinom")

skce_multinom_summary <- summarySE(skce_multinom, measurevar="skce_multinom")

```
#SKCE per fold multinom acc
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(data_dir_cal1$true_class)
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(data_dir_cal2$true_class)
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(data_dir_cal3$true_class)
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(data_dir_cal4$true_class)
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(data_dir_cal5$true_class)
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(data_dir_cal6$true_class)
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(data_dir_cal7$true_class)
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(data_dir_cal8$true_class)
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(data_dir_cal9$true_class)
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(data_dir_cal10$true_class)
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)


skce_multinom_acc = mget(ls(pattern = 'skce_dir\\d+'))
skce_multinom_acc = data.frame(matrix(unlist(skce_multinom_acc), nrow=length(skce_multinom_acc), byrow=TRUE))  
colnames(skce_multinom_acc) <- c("skce_multinom_acc")

skce_multinom_acc_summary <- summarySE(skce_multinom_acc, measurevar="skce_multinom_acc")

```
#Plots conf Uncal
```{r}
data_dir_cal = data_dir_uncal

conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal_plotdata_final = conf_ece_dir
```
```{r}
bin = as.factor(levels(uncal_plotdata_final$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
uncal_plotdata_final = left_join(plot_data, uncal_plotdata_final)
uncal_plotdata_final$weight[is.na(uncal_plotdata_final$weight)] <- 0
uncal_plotdata_final[11,] = c(NA, -1, rep(NA,9))


conf_uncalacrg_final = ggplot(uncal_plotdata_final, aes(x=midpoint, y=accuracy)) +
      geom_bar(aes(x=midpoint, y=accuracy, fill= c("salmon", rep("blue", 10))), stat="identity", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
      ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("Confidence-reliability: Uncalibrated ACRG") +
      scale_fill_manual(name = NULL,guide = "legend",values=c("blue", "salmon"), labels = c("Observed Accuracy", "Gap (conf-ECE=0.105)")) +
      scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
      geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
      geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(uncal_plotdata_final$weight*30), colour ="salmon") +
      theme_classic() + 
      theme(axis.text.x = element_text(colour="black", size = 13)) +
      theme(axis.text.y = element_text(colour="black",size = 13)) + 
      theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=13)) +
      theme(legend.title = element_text(color = "black", size = 13),
            legend.text = element_text(color = "black", size = 13),
            legend.position = c(0.35,0.9),
            legend.background = element_blank())  
conf_uncalacrg_final

ggsave("conf_uncalacrg_final.svg",conf_uncalacrg_final, height = 3.1875, width=4.25)

```
#####plot cw_MSS_TP53neg
```{r}
data_dir_cal = data_dir_uncal

cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0
conf_ece_dir[11,] = c(NA, -1, rep(NA,9))

cw_MSS_TP53neg_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(aes(x=midpoint, y=accuracy, fill= c(rep("blue", 10),"salmon")), stat="identity", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
      ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Uncalibrated MSS TP53 negative") +
      scale_fill_manual(name = NULL,guide = "legend",values=c("blue", "salmon"), labels = c("Observed Accuracy", "Gap Predicted Mean")) +
      scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
      geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
      geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
      theme_classic() + 
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())    
cw_MSS_TP53neg_uncaldata_final

ggsave("cw_MSS_TP53neg_uncaldata_final.svg",cw_MSS_TP53neg_uncaldata_final, height = 3, width=4)

```
##### plot cw_MSS_TP53pos
```{r}
data_dir_cal = data_dir_uncal

cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_MSS_TP53pos_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Uncalibrated MSS TP53 positive") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_MSS_TP53pos_uncaldata_final

ggsave("cw_MSS_TP53pos_uncaldata_final.svg",cw_MSS_TP53pos_uncaldata_final, height = 3, width=4)

```
#####plot cw_MSI
```{r}
data_dir_cal = data_dir_uncal

cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_MSI_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Uncalibrated MSI") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_MSI_uncaldata_final

ggsave("cw_MSI_uncaldata_final.svg",cw_MSI_uncaldata_final, height = 3, width=4)

```
##### plot cw_EMT
```{r}
data_dir_cal = data_dir_uncal

cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_EMT_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Uncalibrated EMT") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_EMT_uncaldata_final

ggsave("cw_EMT_uncaldata_final.svg",cw_EMT_uncaldata_final, height = 3, width=4)

```



#Plots dirichlet
```{r}
data_dir_cal = data_dir_cal_final

conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal_plotdata_final = conf_ece_dir
```
```{r}
bin = as.factor(levels(uncal_plotdata_final$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
uncal_plotdata_final = left_join(plot_data, uncal_plotdata_final)
uncal_plotdata_final$weight[is.na(uncal_plotdata_final$weight)] <- 0

uncal_plotdata_final[11,] = c(NA, -1, rep(NA,9))

conf_dirdata_final = ggplot(uncal_plotdata_final, aes(x=midpoint, y=accuracy)) +
      geom_bar(aes(x=midpoint, y=accuracy, fill= c("salmon", rep("blue", 10))), stat="identity", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
      ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("Confidence-reliability: L2 Dirichlet ACRG") +
      scale_fill_manual(name = NULL,guide = "legend",values=c("blue", "salmon"), labels = c("Observed Accuracy", "Gap (conf-ECE=0.125)")) +
      scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
      geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
      geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(uncal_plotdata_final$weight*30), colour ="salmon") +
      theme_classic() + 
      theme(axis.text.x = element_text(colour="black", size = 13)) +
      theme(axis.text.y = element_text(colour="black",size = 13)) + 
      theme(plot.title = element_text(colour="black", size=13,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =13, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=13)) +
      theme(legend.title = element_text(color = "black", size = 13),
            legend.text = element_text(color = "black", size = 13),
            legend.position = c(0.35,0.9),
            legend.background = element_blank())  
conf_dirdata_final

ggsave("conf_dirdata_final.svg",conf_dirdata_final, height = 3.1875, width=4.25)

```
#####plot cw_MSS_TP53neg
```{r}
data_dir_cal = data_dir_cal_final

cw_MSS_TP53neg = dplyr::select(data_dir_cal, c("MSS_TP53neg", "true_class", "MSS_TP53neg_subtype"))
cw_MSS_TP53neg$correct = (as.character(cw_MSS_TP53neg$true_class) == as.character(cw_MSS_TP53neg$MSS_TP53neg_subtype))
cw_MSS_TP53neg$bin = cut(cw_MSS_TP53neg$MSS_TP53neg, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53neg %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53neg))) NA_real_ else mean(MSS_TP53neg, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53neg$bin,cw_MSS_TP53neg$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0
conf_ece_dir[11,] = c(NA, -1, rep(NA,9))

cw_MSS_TP53neg_dirdata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(aes(x=midpoint, y=accuracy, fill= c(rep("blue", 10),"salmon")), stat="identity", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
      ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Dirichlet MSS TP53 negative") +
      scale_fill_manual(name = NULL,guide = "legend",values=c("blue", "salmon"), labels = c("Observed Accuracy", "Gap Predicted Mean")) +
      scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
      geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
      geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
      theme_classic() + 
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())    
cw_MSS_TP53neg_dirdata_final

ggsave("cw_MSS_TP53neg_dirdata_final.svg",cw_MSS_TP53neg_dirdata_final, height = 3, width=4)
```
##### plot cw_MSS_TP53pos
```{r}
data_dir_cal = data_dir_cal_final

cw_MSS_TP53pos = dplyr::select(data_dir_cal, c("MSS_TP53pos", "true_class", "MSS_TP53pos_subtype"))
cw_MSS_TP53pos$correct = (as.character(cw_MSS_TP53pos$true_class) == as.character(cw_MSS_TP53pos$MSS_TP53pos_subtype))
cw_MSS_TP53pos$bin = cut(cw_MSS_TP53pos$MSS_TP53pos, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSS_TP53pos %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSS_TP53pos))) NA_real_ else mean(MSS_TP53pos, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSS_TP53pos$bin,cw_MSS_TP53pos$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_MSS_TP53pos_dirdata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Dirichlet MSS TP53 positive") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_MSS_TP53pos_dirdata_final

ggsave("cw_MSS_TP53pos_dirdata_final.svg",cw_MSS_TP53pos_dirdata_final, height = 3, width=4)

```
#####plot cw_MSI
```{r}
data_dir_cal = data_dir_cal_final

cw_MSI = dplyr::select(data_dir_cal, c("MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (as.character(cw_MSI$true_class) == as.character(cw_MSI$MSI_subtype))
cw_MSI$bin = cut(cw_MSI$MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MSI))) NA_real_ else mean(MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_MSI_dirdata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Dirichlet MSI") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_MSI_dirdata_final

ggsave("cw_MSI_dirdata_final.svg",cw_MSI_dirdata_final, height = 3, width=4)

```
##### plot cw_EMT
```{r}
data_dir_cal = data_dir_cal_final

cw_EMT = dplyr::select(data_dir_cal, c("EMT", "true_class", "EMT_subtype"))
cw_EMT$correct = (as.character(cw_EMT$true_class) == as.character(cw_EMT$EMT_subtype))
cw_EMT$bin = cut(cw_EMT$EMT, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EMT %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(EMT))) NA_real_ else mean(EMT, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EMT$bin,cw_EMT$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_EMT_dirdata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.2)), breaks=c(seq(from = 0, to = 1, by = 0.2))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") +
  ylim(0,1) +
      ylab("Accuracy") + 
      xlab("Confidence") +
      ggtitle("cw-ECE Dirichlet EMT") +
  theme_classic() +
      theme(axis.text.x = element_text(colour="black", size = 12)) +
      theme(axis.text.y = element_text(colour="black",size = 12)) + 
      theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
      theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
      theme(axis.title.y = element_text(colour="black", size=12)) +
      theme(legend.title = element_text(color = "black", size = 12),
            legend.text = element_text(color = "black", size = 12),
            legend.position = c(0.3,0.85),
            legend.background = element_blank())  
cw_EMT_dirdata_final

ggsave("cw_EMT_dirdata_final.svg",cw_EMT_dirdata_final, height = 3, width=4)

```
```{r}
ggplot(data_dir_uncal) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

ggplot(data_dir_cal_final) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

ggplot(data_multinom_cal_final) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

```


#Base cal plots
```{r}
x = c(data_dir_uncal$MSS_TP53neg, data_dir_uncal$MSS_TP53pos, data_dir_uncal$MSI, data_dir_uncal$EMT)
y = c(data_dir_uncal$MSS_TP53neg_subtype, data_dir_uncal$MSS_TP53pos_subtype, data_dir_uncal$MSI_subtype, data_dir_uncal$EMT_subtype)
y = ifelse(grepl("2", y, ignore.case = T), "TRUE", "FALSE")
df = data.frame(x,y)

cal_obj_all <- calibration(as.factor(df$y) ~ df$x , data = df, cuts = 10)
plot(cal_obj_all, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_MSS_TP53neg <- calibration(as.factor(data_dir_uncal$MSS_TP53neg_subtype) ~ data_dir_uncal$MSS_TP53neg , data = data_dir_uncal, cuts = 10)
plot(cal_obj_MSS_TP53neg, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSS_TP53pos <- calibration(as.factor(data_dir_uncal$MSS_TP53pos_subtype) ~ data_dir_uncal$MSS_TP53pos , data = data_dir_uncal, cuts = 10)
plot(cal_obj_MSS_TP53pos, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSI <- calibration(as.factor(data_dir_uncal$MSI_subtype) ~ data_dir_uncal$MSI , data = data_dir_uncal, cuts = 10)
plot(cal_obj_MSI, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_EMT <- calibration(as.factor(data_dir_uncal$EMT_subtype) ~ data_dir_uncal$EMT , data = data_dir_uncal, cuts = 10)
plot(cal_obj_EMT, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_combined = rbind(cal_obj_EMT$data, cal_obj_MSI$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_MSS_TP53pos$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_MSS_TP53neg$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_all$data)



g = ggplot(cal_obj_combined, aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
     stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")
g + geom_smooth(aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("Calibration Plot for TCGA Classification Model Across 10 Nested Folds")  +
    scale_colour_manual(name = NULL, labels = c("EMT","MSI","MSS TP53-","MSS TP53+","Mean Class Calibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                  theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 15)) +
                theme(axis.text.y = element_text(colour="black",size = 15)) + 
                theme(plot.title = element_text(colour="black", size=15,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =15, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=15)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.8,0.26),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 




g = ggplot(cal_obj_combined[17:26,], aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
      stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")

g + geom_smooth(cal_obj_combined[1:16,],mapping = aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("Calibration Plot for TCGA Classification Model Across 10 Nested Folds")  +
    scale_colour_manual(name = NULL, labels = c("EMT","MSI","MSS TP53-","MSS TP53+","Mean Class Calibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 12)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 10),
                      legend.text = element_text(color = "black", size = 10),
                      legend.position = c(0.8,0.25),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 





g = ggplot(cal_obj_combined[41:50,], aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
      stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")

acrg_uncal_plot = g + geom_smooth(cal_obj_combined[1:40,],mapping = aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("ACRG Base Model Calibration Plot")  +
    scale_colour_manual(name = NULL, labels = c("EMT","MSI","MSS TP53-","MSS TP53+","Mean Class \nCalibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 15)) +
                theme(axis.text.y = element_text(colour="black",size = 15)) + 
                theme(plot.title = element_text(colour="black", size=15,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =15, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=15)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.8,0.26),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 

ggsave("acrg_uncal_plot.svg",acrg_uncal_plot, width=5, height=4)

```
#Dirichlet cal plots
```{r}
x = c(data_dir_cal_final$MSS_TP53neg, data_dir_cal_final$MSS_TP53pos, data_dir_cal_final$MSI, data_dir_cal_final$EMT)
y = c(data_dir_cal_final$MSS_TP53neg_subtype, data_dir_cal_final$MSS_TP53pos_subtype, data_dir_cal_final$MSI_subtype, data_dir_cal_final$EMT_subtype)
y = ifelse(grepl("2", y, ignore.case = T), "TRUE", "FALSE")
df = data.frame(x,y)

cal_obj_all <- calibration(as.factor(df$y) ~ df$x , data = df, cuts = 10)
plot(cal_obj_all, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_MSS_TP53neg <- calibration(as.factor(data_dir_cal_final$MSS_TP53neg_subtype) ~ data_dir_cal_final$MSS_TP53neg , data = data_dir_cal_final, cuts = 10)
plot(cal_obj_MSS_TP53neg, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSS_TP53pos <- calibration(as.factor(data_dir_cal_final$MSS_TP53pos_subtype) ~ data_dir_cal_final$MSS_TP53pos , data = data_dir_cal_final, cuts = 10)
plot(cal_obj_MSS_TP53pos, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSI <- calibration(as.factor(data_dir_cal_final$MSI_subtype) ~ data_dir_cal_final$MSI , data = data_dir_cal_final, cuts = 10)
plot(cal_obj_MSI, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_EMT <- calibration(as.factor(data_dir_cal_final$EMT_subtype) ~ data_dir_cal_final$EMT , data = data_dir_cal_final, cuts = 10)
plot(cal_obj_EMT, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_combined = rbind(cal_obj_EMT$data, cal_obj_MSI$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_MSS_TP53pos$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_MSS_TP53neg$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_all$data)




g = ggplot(cal_obj_combined[41:50,], aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
      stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")

acrg_dir_plot = g + geom_smooth(cal_obj_combined[1:40,],mapping = aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("ACRG L2 Dirichlet Calibration Plot")  +
    scale_colour_manual(name = NULL, labels = c("EMT","MSI","MSS TP53-","MSS TP53+","Mean Class \nCalibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                  theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 15)) +
                theme(axis.text.y = element_text(colour="black",size = 15)) + 
                theme(plot.title = element_text(colour="black", size=15,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =15, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=15)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.8,0.26),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
acrg_dir_plot

ggsave("acrg_dir_plot.svg",acrg_dir_plot, width=5, height=4)
```


#calibration_metrics_mean
```{r}
uncal_metrics_mean$model = "Uncalibrated"
uncal_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

dirichlet_metrics_mean$model = "Dirichlet Logloss"
dirichlet_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

multinom_metrics_mean$model = "Multinomial Logistic Logloss"
multinom_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

dirichlet_metrics_mean_acc$model = "Dirichlet Accuracy"
dirichlet_metrics_mean_acc$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

multinom_metrics_mean_acc$model = "Multinomial Logistic Accuracy "
multinom_metrics_mean_acc$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

calibration_metrics_mean = rbind(uncal_metrics_mean[,c(1,3:4)],dirichlet_metrics_mean[,c(1,3:4)],multinom_metrics_mean[,c(1,3:4)],dirichlet_metrics_mean_acc[,c(1,3:4)],multinom_metrics_mean_acc[,c(1,3:4)])

calibration_metrics_mean = dcast(calibration_metrics, Metric~model, value.var="value")
```
#Calibration metrics 
```{r}
colnames(uncal_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
uncal_metrics$Model = "Uncalibrated"
uncal_metrics$SKCE = skce_uncal$skce_uncal

colnames(dirichlet_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
dirichlet_metrics$Model = "L2 Dirichlet Calibration"
dirichlet_metrics$SKCE = skce_dir$skce_dir

colnames(multinom_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
multinom_metrics$Model = "Penalized Multinomial Logistic"
multinom_metrics$SKCE = skce_multinom$skce_multinom

calibration_metrics = rbind(uncal_metrics,dirichlet_metrics,multinom_metrics)
```
```{r}
acrg_calibrated_table = CreateTableOne(vars = c("Accuracy", "Kappa", "SKCE","Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score"), strata = c("Model"), data = calibration_metrics)


print(acrg_calibrated_table, contDigits = 4, quote = TRUE, noSpaces = TRUE)


acrg_calibrated_table_tab <- print(acrg_calibrated_table,  contDigits = 4,quote = FALSE, noSpaces = TRUE, printToggle = FALSE, missing = TRUE, smd=TRUE)
write.csv(acrg_calibrated_table_tab, file = "acrg_calibrated_table_tab.csv")

#Ttests

pairwise.t.test(calibration_metrics$Accuracy, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$Kappa, calibration_metrics$Model, p.adj = "BH")

pairwise.t.test(calibration_metrics$`Confidence ECE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Confidence MCE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Class-wise ECE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Class-wise MCE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Multiclass Brier Score`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$SKCE, calibration_metrics$Model, p.adj = "BH")

```


#Summary calibration metrics 
```{r}

summary(calibration_metrics)
calibration_metrics = dplyr::select(calibration_metrics, -c("scke","Scke"))

calibration_metrics_long = calibration_metrics %>% tidyr::pivot_longer(!Model, names_to = "Metric", values_to = "Value")
calibration_metrics_long = as.data.frame(calibration_metrics_long)

calibration_metrics_long <- summarySE(calibration_metrics_long, measurevar="Value", groupvars=c("Model", "Metric"))
calibration_metrics_long_skce = dplyr::filter(calibration_metrics_long, Metric=="SKCE")
calibration_metrics_long = dplyr::filter(calibration_metrics_long, !Metric=="SKCE")

calibration_metrics_long$Model = factor(calibration_metrics_long$Model, levels = c("Uncalibrated", "L2 Dirichlet Calibration", "Penalized Multinomial Logistic"))
calibration_metrics_long_skce$Model = factor(calibration_metrics_long_skce$Model, levels = c("Uncalibrated", "L2 Dirichlet Calibration","Penalized Multinomial Logistic"))

calibration_metrics_long$Metric = factor(calibration_metrics_long$Metric, levels = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE",  "Multiclass Brier Score"))



acrg_calibration_metrics_plot = ggplot(calibration_metrics_long, aes(fill=Model, y=Value, x=Metric)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(mapping = aes(ymin=Value-ci,ymax=Value+ci),
                 position=position_dodge(0.9), width=.3, color = "black", size = 0.5) +
    ylim(0,1) +
  ggtitle("ACRG Calibration Metrics") + 
  scale_fill_manual(values = c("skyblue3", "purple", "orange")) + 
  theme_classic() +
                theme(axis.text.x = element_text(colour="black", size = 12,angle = 45, hjust=1)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 10),
                      legend.text = element_text(color = "black", size = 10),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
acrg_calibration_metrics_plot

ggsave("acrg_calibration_metrics_plot.svg", acrg_calibration_metrics_plot, width=5, height=4)
write.csv(calibration_metrics_long, file = "calibration_metrics_long_acrg.csv")


acrg_calibration_skce_plot = ggplot(calibration_metrics_long_skce, aes(fill=Model, y=Value, x=Metric)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(mapping = aes(ymin=Value-ci,ymax=Value+ci),
                 position=position_dodge(0.9), width=.3, color = "black", size = 0.5) +
    ylim(0,0.013) +
    ggtitle("ACRG Calibration SKCE Metric") + 
    scale_fill_manual(values = c("skyblue3", "purple", "orange")) + 
    theme_classic() +
                theme(axis.text.x = element_text(colour="black", size = 12,angle = 45, hjust=1)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 10),
                      legend.text = element_text(color = "black", size = 10),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
acrg_calibration_skce_plot

ggsave("acrg_calibration_skce_plot.svg", acrg_calibration_skce_plot, width=5, height=4)

write.csv(calibration_metrics_long_skce, file = "calibration_metrics_long_skce_acrg.csv")


write.csv(calibration_metrics, file = "acrg_calibration_metrics_data.csv")

```


