---
title: "Calibration TCGA"
author: "Daniel Skubleny"
date: "22/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Calibration packages
```{r}
#PAPER = https://proceedings.neurips.cc/paper/2019/file/1c336b8080f82bcc2cd2499b4c57261d-Paper.pdf

library(devtools)
devtools::install_github("devmotion/rcalibration")
```
```{r}
library(rcalibration)
library(JuliaCall)
library(extraDistr)
```
```{r}
julia_setup(JULIA_HOME = "/Applications/Julia-1.5.app/Contents/Resources/julia/bin/", verbose = TRUE, install = TRUE,force = FALSE, useRCall = TRUE, rebuild = FALSE)
#Need to run "import Pkg; Pkg.add("CalibrationErrorsDistributions")" in terminal with Julia open for calerrors() and import Pkg; Pkg.add("CalibrationTests") for caltests() and import Pkg; Pkg.add("CalibrationErrors") for calece()

#may need to call Pkg.update()

#BElow: r crahses with version 1.6 or 1.7???
#julia_setup(JULIA_HOME = "/Applications/Julia-1.7.app/Contents/Resources/julia/bin/", verbose = TRUE, install = TRUE,force = FALSE, useRCall = TRUE, rebuild = FALSE)
#Need to run "import Pkg; Pkg.add("CalibrationErrorsDistributions")" in terminal with Julia open for calerrors() and import Pkg; Pkg.add("CalibrationTests") for caltests() and import Pkg; Pkg.add("CalibrationErrors") for calece()

#Pkg.add(Pkg.PackageSpec(;name="CalibrationErrors", version="0.6", ignore.compat=TRUE))
#Pkg.rm("CalibrationErrorsDistributions")
#Pkg.rm("CalibrationTests")
#Pkg.rm("CalibrationErrors")

```
```{r}
#Installs dependencies
#rcalibration::install()
ca <- rcalibration::load()

###SO WITH NEW UPDTE YOU JUST USE ca
```
```{r}
#ce <- calerrors() this is old. 
#ct <- caltests()

#C maybe just use ca instead
ce <- ca$CalibrationErrors() 
ct <- caltests()


skce <- ca$UnbiasedSKCE(ca$tensor(ca$ExponentialKernel(), ca$WhiteKernel()))
kernel <- ca$tensor(ca$ExponentialKernel(metric=ca$TotalVariation()), ca$WhiteKernel())

skce <- ce$UnbiasedSKCE(ce$tensor(ce$ExponentialKernel(), ce$WhiteKernel()))
kernel <- ct$tensor(ct$ExponentialKernel(metric=ct$TotalVariation()), ct$WhiteKernel())


ece_uniform = ca$calibrationerror(ca$ECE(ca$UniformBinning(10)), predictions, labels)
```
```{r}
#NOTE: Need to code factors as integers --- convert to numeric first then to integer/ 
#Need to code predictions as numeric but use RowVecs from julia. 

predictions= data_dir_uncal$EMT
outcomes=as.numeric(data_dir_uncal$EMT_subtype)
outcomes = as.integer(outcomes)

skce$.(ce$RowVecs(predictions), outcomes)

test <- ct$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
ct$pvalue(test)
```
#For ACRG calibration 
```{r}
#ACRG uncal
set.seed(1234)
predictions= as.matrix(data_dir_uncal[,1:4])
outcomes = as.numeric(data_dir_uncal$true_class)
outcomes = as.integer(outcomes)
skce_acrg_uncal <- ca$AsymptoticSKCETest(kernel, ca$RowVecs(predictions), outcomes)
skce_acrg_uncal_pval = ca$pvalue(skce_acrg_uncal)

skce_acrg_uncal_weak = ct$DistributionFreeSKCETest(skce,ce$RowVecs(predictions), outcomes)
skce_acrg_uncal_weak_pval = ct$pvalue(skce_acrg_uncal_weak)


#ACRG dirichlet logloss
set.seed(1234)
predictions= as.matrix(data_dir_cal_final[,1:4])
outcomes = as.numeric(data_dir_cal_final$true_class)
outcomes = as.integer(outcomes)
skce_acrg_dir <- ct$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_acrg_dir_pval = ct$pvalue(skce_acrg_dir)

skce_acrg_dir_weak = ct$DistributionFreeSKCETest(skce,ce$RowVecs(predictions), outcomes)
skce_acrg_dir_weak_pval = ct$pvalue(skce_acrg_dir_weak)

#ACRG multinomial logloss
set.seed(1234)
predictions= as.matrix(data_multinom_cal_final[,1:4])
outcomes = as.numeric(data_multinom_cal_final$true_class)
outcomes = as.integer(outcomes)

skce_acrg_multinom <- ct$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_acrg_multinom_pval = ct$pvalue(skce_acrg_multinom)

skce_acrg_multinom_weak = ct$DistributionFreeSKCETest(skce,ce$RowVecs(predictions), outcomes)
skce_acrg_multinom_weak_pval = ct$pvalue(skce_acrg_multinom_weak)

#ACRG dirichlet accuracy 
set.seed(1234)
predictions= as.matrix(data_dir_cal_final_acc[,1:4])
outcomes = as.numeric(data_dir_cal_final_acc$true_class)
outcomes = as.integer(outcomes)

skce_acrg_dir_acc <- ct$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_acrg_dir_acc_pval = ct$pvalue(skce_acrg_dir_acc)

skce_acrg_dir_acc_weak = ct$DistributionFreeSKCETest(skce,ce$RowVecs(predictions), outcomes)
skce_acrg_dir_acc_weak_pval = ct$pvalue(skce_acrg_dir_acc_weak)

#ACRG multinomial accuracy
set.seed(1234)
predictions= as.matrix(data_multinom_cal_final_acc[,1:4])
outcomes = as.numeric(data_multinom_cal_final_acc$true_class)
outcomes = as.integer(outcomes)
skce_acrg_multinom_acc <- ct$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_acrg_multinom_acc_pval = ct$pvalue(skce_acrg_multinom_acc)

skce_acrg_multinom_acc_weak = ct$DistributionFreeSKCETest(skce,ce$RowVecs(predictions), outcomes)
skce_acrg_multinom_acc_weak_pval = ct$pvalue(skce_acrg_multinom_acc_weak)

```

#For TCGA calibration 
```{r}

#TCGA uncal
set.seed(99)
predictions= as.matrix(data_dir_uncal[,1:4])
outcomes = as.factor(data_dir_uncal$true_class)
outcomes = as.numeric(outcomes)
outcomes = as.integer(outcomes)
skce_tcga_uncal <- ca$AsymptoticSKCETest(kernel, ca$RowVecs(predictions), outcomes)
skce_tcga_uncal_pval = ca$pvalue(skce_tcga_uncal)
skce_tcga_uncal_pval
#TCGA dirichlet logloss

predictions= as.matrix(data_dir_cal_final[,1:4])
outcomes = as.factor(data_dir_cal_final$true_class)
outcomes = as.numeric(outcomes)
outcomes = as.integer(outcomes)

skce_tcga_dir <- ca$AsymptoticSKCETest(kernel, ca$RowVecs(predictions), outcomes)
skce_tcga_dir_pval = ca$pvalue(skce_tcga_dir)
skce_tcga_dir_pval
#TCGA multinomial logloss
predictions= as.matrix(data_multinom_cal_final[,1:4])
outcomes = as.factor(data_multinom_cal_final$true_class)
outcomes = as.numeric(outcomes)
outcomes = as.integer(outcomes)

skce_tcga_multinom <- ca$AsymptoticSKCETest(kernel, ca$RowVecs(predictions), outcomes)
skce_tcga_multinom_pval = ca$pvalue(skce_tcga_multinom)
skce_tcga_multinom_pval
#TCGA dirichlet accuracy 
predictions= as.matrix(data_dir_cal_final_acc[,1:4])
outcomes = as.factor(data_dir_cal_final_acc$true_class)
outcomes = as.numeric(outcomes)
outcomes = as.integer(outcomes)

skce_tcga_dir_acc <- ca$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_tcga_dir_acc_pval = ca$pvalue(skce_tcga_dir_acc)
skce_tcga_dir_acc_pval
#TCGA multinomial accuracy
predictions= as.matrix(data_multinom_cal_final_acc[,1:4])
outcomes = as.factor(data_multinom_cal_final_acc$true_class)
outcomes = as.numeric(outcomes)
outcomes = as.integer(outcomes)
skce_tcga_multinom_acc <- ca$AsymptoticSKCETest(kernel, ce$RowVecs(predictions), outcomes)
skce_tcga_multinom_acc_pval = ca$pvalue(skce_tcga_multinom_acc)
skce_tcga_multinom_acc_pval

```

#For TME calibration 
```{r}
#Because this is a binary problem I need to present my predictions data as a vector and outcomes as a boolean variable. 

#In summary all models are calibrated in with the weak distribution-free SKCE test. However, they are all uncalibrated in the strong sense. The regularized binomial model optimizing logloss provides statistical significantly better point estimates of SKCE compared to the uncalibrated model. Thus we will used the best calibrated model with post-hoc calibration. 

#TEST FOR SKCE between uncalibrated and logloss binomial regression and for ECE between uncalibrated and logloss binomial
t.test(skce_uncal,skce_dir)
t.test(uncal_metrics$conf_ece_uncal,dirichlet_metrics$conf_ece_dir)


#TME uncal
set.seed(1234)
predictions= data_dir_uncal$High
outcomes = data_dir_uncal$true_class=="High"
skce$.(predictions, outcomes)
skce_tme_uncal <- ct$AsymptoticSKCETest(kernel, predictions, outcomes)
skce_tme_uncal
skce_tme_uncal_pval = ct$pvalue(skce_tme_uncal)

skce_tme_uncal_weak = ct$DistributionFreeSKCETest(skce,predictions, outcomes)
skce_tme_uncal_weak_pval = ct$pvalue(skce_tme_uncal_weak)

#TME dirichlet logloss
set.seed(1234)
predictions= data_dir_cal_final$High
outcomes = data_dir_cal_final$true_class=="High"
skce$.(predictions, outcomes)
skce_tme_dir <- ct$AsymptoticSKCETest(kernel, predictions, outcomes)
skce_tme_dir
skce_tme_dir_pval = ct$pvalue(skce_tme_dir)

skce_tme_dir_weak = ct$DistributionFreeSKCETest(skce,predictions, outcomes)
skce_tme_dir_weak_pval = ct$pvalue(skce_tme_dir_weak)

#TME dirichlet accuracy 
set.seed(1234)
predictions= data_dir_cal_final_acc$High
outcomes = data_dir_cal_final_acc$true_class=="High"
skce$.(predictions, outcomes)
skce_tme_dir_acc <- ct$AsymptoticSKCETest(kernel, predictions, outcomes)
skce_tme_dir_acc
skce_tme_dir_acc_pval = ct$pvalue(skce_tme_dir_acc)

skce_tme_dir_acc_weak = ct$DistributionFreeSKCETest(skce,predictions, outcomes)
skce_tme_dir_acc_weak_pval = ct$pvalue(skce_tme_dir_acc_weak)

```

#Plan
```{r}
#Plan is to have calibration metrics (conf-MCE, conf-ECE, cw-ECE, multiclass brier and cw-brier) for each fold for the basic uncalibrated pseudo-probabilities and 3 other models (1 = dirichlet calibrated with multinom and decay, 2 = multinomial glmnet with ElasticNet regularization (tuned for lambda and alpha), 3 = dirichlet with L2 regularization (tuned for lambda). We will use logloss as a metric in keeping with the dirichlet paper 
```
#CV1////////
```{r}
trainData1 = subtype_edata[trainRowNumbers$Resample01,]
testData1 = subtype_edata[-trainRowNumbers$Resample01,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData1[, 2:9285])
y= trainData1$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData1[, 2:9285])
y.test = testData1$SUBTYPE
y.test = as.factor(y.test)
```
```{r}
#Inner fold train = x.lasso
x.lassoTCGA1 
#Inner fold test = x.lasso.test
x.lasso.testTCGA1 
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_1_train = dplyr::select(trainData1, "SUBTYPE")
cal_1_train = predict(lasso.lasso.model1,newdata = x.lassoTCGA1, type="prob")
cal_1_train_class = predict(lasso.lasso.model1,newdata = x.lassoTCGA1, type="raw")
class_1_train = tibble::rownames_to_column(class_1_train, "patient_id")
cal_1_train = tibble::rownames_to_column(cal_1_train, "patient_id")
cal_data1_train = merge(class_1_train,cal_1_train, by="patient_id")
cal_data1_train = tibble::column_to_rownames(cal_data1_train, "patient_id")

train_prob1 = cal_1_train[,2:5]
train_prob1 = as.data.frame(log(train_prob1))
```
#Uncalibrated
```{r}
#Outer fold test data
class_1 = dplyr::select(testData1, "SUBTYPE")
cal_1 = predict(lasso.lasso.model1,newdata = x.lasso.testTCGA1, type="prob")
cal_1_class = predict(lasso.lasso.model1,newdata = x.lasso.testTCGA1, type="raw")
class_1 = tibble::rownames_to_column(class_1, "patient_id")
cal_1 = tibble::rownames_to_column(cal_1, "patient_id")
cal_data1 = merge(class_1,cal_1, by="patient_id")
cal_data1 = tibble::column_to_rownames(cal_data1, "patient_id")

test_prob1 = cal_1[,2:5]
test_prob1 = as.data.frame(log(test_prob1)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal1 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_1[,2:5]
data_dir_cal$true_class = class_1[,2]
data_dir_cal$pred_class = cal_1_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal1 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal1plotdata = conf_ece_dir
cw_MSI_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal1 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal1plotdata = conf_ece_dir
cw_CIN_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal1 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal1plotdata = conf_ece_dir
cw_EBV_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal1 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal1plotdata = conf_ece_dir
cw_GS_ece_uncal1 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal1 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal1_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal1 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal1 = max(absolute_diff)
```
```{r}
acc_uncal1 = confusionMatrix(as.factor(class_1[,2]), as.factor(cal_1_class))

cw_uncal_ece1 = 0.25*(cw_MSI_ece_uncal1 + 
                 cw_CIN_ece_uncal1 + 
                 cw_EBV_ece_uncal1 + 
                 cw_GS_ece_uncal1)

cw_uncal_mce1 = max(c(cw_MSI_mce_uncal1, 
               cw_CIN_mce_uncal1 ,
               cw_EBV_mce_uncal1, 
               cw_GS_mce_uncal1))
dirichlet_cal_prob = (cal_1[,2:5])/rowSums(cal_1[,2:5])
brier.uncal_prob1 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_1[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_1_class = predict(dirichlet_cal,newdata = test_prob1, type="raw")
dirichlet_cal_1_prob = predict(dirichlet_cal,newdata = test_prob1, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_1_prob
data_dir_cal$true_class = class_1[,2]
data_dir_cal$pred_class = dirichlet_cal_1_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal1 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir1plotdata = conf_ece_dir
cw_MSI_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir1 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir1plotdata = conf_ece_dir
cw_CIN_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir1 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir1plotdata = conf_ece_dir
cw_EBV_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir1 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir1plotdata = conf_ece_dir
cw_GS_ece_dir1 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir1 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir1_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir1 <- weighted.mean(absolute_diff, weight)
conf_mce_dir1 = max(absolute_diff)
```
```{r}
acc_dir1 = confusionMatrix(as.factor(class_1[,2]), as.factor(dirichlet_cal_1_class))


cw_dir_ece1 = 0.25*(cw_MSI_ece_dir1 + 
                 cw_CIN_ece_dir1 + 
                 cw_EBV_ece_dir1 + 
                 cw_GS_ece_dir1)

cw_dir_mce1 = max(c(cw_MSI_mce_dir1, 
               cw_CIN_mce_dir1 ,
               cw_EBV_mce_dir1, 
               cw_GS_mce_dir1))
#Brier
dirichlet_cal_prob = (dirichlet_cal_1_prob)/rowSums(dirichlet_cal_1_prob)
brier.dirichlet_cal_prob1 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_1[,2]))
```


#CV2////////
```{r}
trainData2 = subtype_edata[trainRowNumbers$Resample02,]
testData2 = subtype_edata[-trainRowNumbers$Resample02,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData2[, 2:9285])
y= trainData2$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData2[, 2:9285])
y.test = testData2$SUBTYPE
y.test = as.factor(y.test)
```
```{r}
#Inner fold train = x.lasso
x.lassoTCGA2
#Inner fold test = x.lasso.test
x.lasso.testTCGA2
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_2_train = dplyr::select(trainData2, "SUBTYPE")
cal_2_train = predict(lasso.lasso.model2,newdata = x.lassoTCGA2, type="prob")
cal_2_train_class = predict(lasso.lasso.model2,newdata = x.lassoTCGA2, type="raw")
class_2_train = tibble::rownames_to_column(class_2_train, "patient_id")
cal_2_train = tibble::rownames_to_column(cal_2_train, "patient_id")
cal_data2_train = merge(class_2_train,cal_2_train, by="patient_id")
cal_data2_train = tibble::column_to_rownames(cal_data2_train, "patient_id")

train_prob2 = cal_2_train[,2:5]
train_prob2 = as.data.frame(log(train_prob2))
```
#Uncalibrated
```{r}
#Outer fold test data
class_2 = dplyr::select(testData2, "SUBTYPE")
cal_2 = predict(lasso.lasso.model2,newdata = x.lasso.testTCGA2, type="prob")
cal_2_class = predict(lasso.lasso.model2,newdata = x.lasso.testTCGA2, type="raw")
class_2 = tibble::rownames_to_column(class_2, "patient_id")
cal_2 = tibble::rownames_to_column(cal_2, "patient_id")
cal_data2 = merge(class_2,cal_2, by="patient_id")
cal_data2 = tibble::column_to_rownames(cal_data2, "patient_id")

test_prob2 = cal_2[,2:5]
test_prob2 = as.data.frame(log(test_prob2)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob2,as.factor(class_2_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal2 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_2[,2:5]
data_dir_cal$true_class = class_2[,2]
data_dir_cal$pred_class = cal_2_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal2 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal2plotdata = conf_ece_dir
cw_MSI_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal2 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal2plotdata = conf_ece_dir
cw_CIN_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal2 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal2plotdata = conf_ece_dir
cw_EBV_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal2 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal2plotdata = conf_ece_dir
cw_GS_ece_uncal2 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal2 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal2_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal2 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal2 = max(absolute_diff)
```
```{r}
acc_uncal2 = confusionMatrix(as.factor(class_2[,2]), as.factor(cal_2_class))

cw_uncal_ece2 = 0.25*(cw_MSI_ece_uncal2 + 
                 cw_CIN_ece_uncal2 + 
                 cw_EBV_ece_uncal2 + 
                 cw_GS_ece_uncal2)

cw_uncal_mce2 = max(c(cw_MSI_mce_uncal2, 
               cw_CIN_mce_uncal2 ,
               cw_EBV_mce_uncal2, 
               cw_GS_mce_uncal2))
dirichlet_cal_prob = (cal_2[,2:5])/rowSums(cal_2[,2:5])
brier.uncal_prob2 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_2[,2]))
```





#Dirichlet predictions
```{r}
dirichlet_cal_2_class = predict(dirichlet_cal,newdata = test_prob2, type="raw")
dirichlet_cal_2_prob = predict(dirichlet_cal,newdata = test_prob2, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_2_prob
data_dir_cal$true_class = class_2[,2]
data_dir_cal$pred_class = dirichlet_cal_2_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal2 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir2plotdata = conf_ece_dir
cw_MSI_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir2 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir2plotdata = conf_ece_dir
cw_CIN_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir2 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir2plotdata = conf_ece_dir
cw_EBV_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir2 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir2plotdata = conf_ece_dir
cw_GS_ece_dir2 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir2 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir1_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir2 <- weighted.mean(absolute_diff, weight)
conf_mce_dir2 = max(absolute_diff)
```
```{r}
acc_dir2 = confusionMatrix(as.factor(class_2[,2]), as.factor(dirichlet_cal_2_class))


cw_dir_ece2 = 0.25*(cw_MSI_ece_dir2 + 
                 cw_CIN_ece_dir2 + 
                 cw_EBV_ece_dir2 + 
                 cw_GS_ece_dir2)

cw_dir_mce2 = max(c(cw_MSI_mce_dir2, 
               cw_CIN_mce_dir2 ,
               cw_EBV_mce_dir2, 
               cw_GS_mce_dir2))
#Brier
dirichlet_cal_prob = (dirichlet_cal_2_prob)/rowSums(dirichlet_cal_2_prob)
brier.dirichlet_cal_prob2 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_2[,2]))
```


#CV3///////////
```{r}
trainData3 = subtype_edata[trainRowNumbers$Resample03,]
testData3 = subtype_edata[-trainRowNumbers$Resample03,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData3[, 2:9285])
y= trainData3$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData3[, 2:9285])
y.test = testData3$SUBTYPE
y.test = as.factor(y.test)
```
```{r}
#Inner fold train = x.lasso
x.lassoTCGA3
#Inner fold test = x.lasso.test
x.lasso.testTCGA3
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_3_train = dplyr::select(trainData3, "SUBTYPE")
cal_3_train = predict(lasso.lasso.model3,newdata = x.lassoTCGA3, type="prob")
cal_3_train_class = predict(lasso.lasso.model3,newdata = x.lassoTCGA3, type="raw")
class_3_train = tibble::rownames_to_column(class_3_train, "patient_id")
cal_3_train = tibble::rownames_to_column(cal_3_train, "patient_id")
cal_data3_train = merge(class_3_train,cal_3_train, by="patient_id")
cal_data3_train = tibble::column_to_rownames(cal_data3_train, "patient_id")

train_prob3 = cal_3_train[,2:5]
train_prob3 = as.data.frame(log(train_prob3))
```
#Uncalibrated
```{r}
#Outer fold test data
class_3 = dplyr::select(testData3, "SUBTYPE")
cal_3 = predict(lasso.lasso.model3,newdata = x.lasso.testTCGA3, type="prob")
cal_3_class = predict(lasso.lasso.model3,newdata = x.lasso.testTCGA3, type="raw")
class_3 = tibble::rownames_to_column(class_3, "patient_id")
cal_3 = tibble::rownames_to_column(cal_3, "patient_id")
cal_data3 = merge(class_3,cal_3, by="patient_id")
cal_data3 = tibble::column_to_rownames(cal_data3, "patient_id")

test_prob3 = cal_3[,2:5]
test_prob3 = as.data.frame(log(test_prob3)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob3,as.factor(class_3_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal3 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_3[,2:5]
data_dir_cal$true_class = class_3[,2]
data_dir_cal$pred_class = cal_3_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal3 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal3plotdata = conf_ece_dir
cw_MSI_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal3 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal3plotdata = conf_ece_dir
cw_CIN_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal3 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal3plotdata = conf_ece_dir
cw_EBV_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal3 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal3plotdata = conf_ece_dir
cw_GS_ece_uncal3 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal3 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal3_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal3 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal3 = max(absolute_diff)
```
```{r}
acc_uncal3 = confusionMatrix(as.factor(class_3[,2]), as.factor(cal_3_class))

cw_uncal_ece3 = 0.25*(cw_MSI_ece_uncal3 + 
                 cw_CIN_ece_uncal3 + 
                 cw_EBV_ece_uncal3 + 
                 cw_GS_ece_uncal3)

cw_uncal_mce3 = max(c(cw_MSI_mce_uncal3, 
               cw_CIN_mce_uncal3 ,
               cw_EBV_mce_uncal3, 
               cw_GS_mce_uncal3))
dirichlet_cal_prob = (cal_3[,2:5])/rowSums(cal_3[,2:5])
brier.uncal_prob3 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_3[,2]))
```

#Dirichlet predictions
```{r}
dirichlet_cal_3_class = predict(dirichlet_cal,newdata = test_prob3, type="raw")
dirichlet_cal_3_prob = predict(dirichlet_cal,newdata = test_prob3, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_3_prob
data_dir_cal$true_class = class_3[,2]
data_dir_cal$pred_class = dirichlet_cal_3_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal3 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir3plotdata = conf_ece_dir
cw_MSI_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir3 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir3plotdata = conf_ece_dir
cw_CIN_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir3 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir3plotdata = conf_ece_dir
cw_EBV_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir3 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir3plotdata = conf_ece_dir
cw_GS_ece_dir3 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir3 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir3_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir3 <- weighted.mean(absolute_diff, weight)
conf_mce_dir3 = max(absolute_diff)
```
```{r}
acc_dir3 = confusionMatrix(as.factor(class_3[,2]), as.factor(dirichlet_cal_3_class))


cw_dir_ece3 = 0.25*(cw_MSI_ece_dir3 + 
                 cw_CIN_ece_dir3 + 
                 cw_EBV_ece_dir3 + 
                 cw_GS_ece_dir3)

cw_dir_mce3 = max(c(cw_MSI_mce_dir3, 
               cw_CIN_mce_dir3 ,
               cw_EBV_mce_dir3, 
               cw_GS_mce_dir3))
#Brier
dirichlet_cal_prob = (dirichlet_cal_3_prob)/rowSums(dirichlet_cal_3_prob)
brier.dirichlet_cal_prob3 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_3[,2]))
```


#CV4////////////////
```{r}
trainData4 = subtype_edata[trainRowNumbers$Resample04,]
testData4 = subtype_edata[-trainRowNumbers$Resample04,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData4[, 2:9285])
y= trainData4$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData4[, 2:9285])
y.test = testData4$SUBTYPE
y.test = as.factor(y.test)
```
```{r}
#Inner fold train = x.lasso
x.lassoTCGA4 
#Inner fold test = x.lasso.test
x.lasso.testTCGA4
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_4_train = dplyr::select(trainData4, "SUBTYPE")
cal_4_train = predict(lasso.lasso.model4,newdata = x.lassoTCGA4, type="prob")
cal_4_train_class = predict(lasso.lasso.model4,newdata = x.lassoTCGA4, type="raw")
class_4_train = tibble::rownames_to_column(class_4_train, "patient_id")
cal_4_train = tibble::rownames_to_column(cal_4_train, "patient_id")
cal_data4_train = merge(class_4_train,cal_4_train, by="patient_id")
cal_data4_train = tibble::column_to_rownames(cal_data4_train, "patient_id")

train_prob4 = cal_4_train[,2:5]
train_prob4 = as.data.frame(log(train_prob4))
```
#Uncalibrated
```{r}
#Outer fold test data
class_4 = dplyr::select(testData4, "SUBTYPE")
cal_4 = predict(lasso.lasso.model4,newdata = x.lasso.testTCGA4, type="prob")
cal_4_class = predict(lasso.lasso.model4,newdata = x.lasso.testTCGA4, type="raw")
class_4 = tibble::rownames_to_column(class_4, "patient_id")
cal_4 = tibble::rownames_to_column(cal_4, "patient_id")
cal_data4 = merge(class_4,cal_4, by="patient_id")
cal_data4 = tibble::column_to_rownames(cal_data4, "patient_id")

test_prob4 = cal_4[,2:5]
test_prob4 = as.data.frame(log(test_prob4)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob4,as.factor(class_4_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal4 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_4[,2:5]
data_dir_cal$true_class = class_4[,2]
data_dir_cal$pred_class = cal_4_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal4 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal4plotdata = conf_ece_dir
cw_MSI_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal4 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal4plotdata = conf_ece_dir
cw_CIN_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal4 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal4plotdata = conf_ece_dir
cw_EBV_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal4 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal4plotdata = conf_ece_dir
cw_GS_ece_uncal4 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal4 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal4_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal4 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal4 = max(absolute_diff)
```
```{r}
acc_uncal4 = confusionMatrix(as.factor(class_4[,2]), as.factor(cal_4_class))

cw_uncal_ece4 = 0.25*(cw_MSI_ece_uncal4 + 
                 cw_CIN_ece_uncal4 + 
                 cw_EBV_ece_uncal4 + 
                 cw_GS_ece_uncal4)

cw_uncal_mce4 = max(c(cw_MSI_mce_uncal4, 
               cw_CIN_mce_uncal4 ,
               cw_EBV_mce_uncal4, 
               cw_GS_mce_uncal4))
dirichlet_cal_prob = (cal_4[,2:5])/rowSums(cal_4[,2:5])
brier.uncal_prob4 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_4[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_4_class = predict(dirichlet_cal,newdata = test_prob4, type="raw")
dirichlet_cal_4_prob = predict(dirichlet_cal,newdata = test_prob4, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_4_prob
data_dir_cal$true_class = class_4[,2]
data_dir_cal$pred_class = dirichlet_cal_4_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal4 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir4plotdata = conf_ece_dir
cw_MSI_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir4 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir4plotdata = conf_ece_dir
cw_CIN_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir4 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir4plotdata = conf_ece_dir
cw_EBV_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir4 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir4plotdata = conf_ece_dir
cw_GS_ece_dir4 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir4 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir4_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir4 <- weighted.mean(absolute_diff, weight)
conf_mce_dir4 = max(absolute_diff)
```
```{r}
acc_dir4 = confusionMatrix(as.factor(class_4[,2]), as.factor(dirichlet_cal_4_class))


cw_dir_ece4 = 0.25*(cw_MSI_ece_dir4 + 
                 cw_CIN_ece_dir4 + 
                 cw_EBV_ece_dir4 + 
                 cw_GS_ece_dir4)

cw_dir_mce4 = max(c(cw_MSI_mce_dir4, 
               cw_CIN_mce_dir4 ,
               cw_EBV_mce_dir4, 
               cw_GS_mce_dir4))
#Brier
dirichlet_cal_prob = (dirichlet_cal_4_prob)/rowSums(dirichlet_cal_4_prob)
brier.dirichlet_cal_prob4 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_4[,2]))
```



#CV5////////////////
```{r}
trainData5 = subtype_edata[trainRowNumbers$Resample05,]
testData5 = subtype_edata[-trainRowNumbers$Resample05,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData5[, 2:9285])
y= trainData5$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData5[, 2:9285])
y.test = testData5$SUBTYPE
y.test = as.factor(y.test)
```


```{r}
#Train data from model after feature selection
set.seed(99)
class_5_train = dplyr::select(trainData5, "SUBTYPE")
cal_5_train = predict(lasso.lasso.model5,newdata = x.lassoTCGA5, type="prob")
cal_5_train_class = predict(lasso.lasso.model5,newdata = x.lassoTCGA5, type="raw")
class_5_train = tibble::rownames_to_column(class_5_train, "patient_id")
cal_5_train = tibble::rownames_to_column(cal_5_train, "patient_id")
cal_data5_train = merge(class_5_train,cal_5_train, by="patient_id")
cal_data5_train = tibble::column_to_rownames(cal_data5_train, "patient_id")

train_prob5 = cal_5_train[,2:5]
train_prob5 = as.data.frame(log(train_prob5))
```
#Uncalibrated
```{r}
#Outer fold test data
class_5 = dplyr::select(testData5, "SUBTYPE")
cal_5 = predict(lasso.lasso.model5,newdata = x.lasso.testTCGA5, type="prob")
cal_5_class = predict(lasso.lasso.model5,newdata = x.lasso.testTCGA5, type="raw")
class_5 = tibble::rownames_to_column(class_5, "patient_id")
cal_5 = tibble::rownames_to_column(cal_5, "patient_id")
cal_data5 = merge(class_5,cal_5, by="patient_id")
cal_data5 = tibble::column_to_rownames(cal_data5, "patient_id")

test_prob5 = cal_5[,2:5]
test_prob5 = as.data.frame(log(test_prob5)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob5,as.factor(class_5_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal5 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_5[,2:5]
data_dir_cal$true_class = class_5[,2]
data_dir_cal$pred_class = cal_5_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal5 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal5plotdata = conf_ece_dir
cw_MSI_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal5 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal5plotdata = conf_ece_dir
cw_CIN_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal5 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal5plotdata = conf_ece_dir
cw_EBV_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal5 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal5plotdata = conf_ece_dir
cw_GS_ece_uncal5 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal5 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal5_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal5 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal5 = max(absolute_diff)
```
```{r}
acc_uncal5 = confusionMatrix(as.factor(class_5[,2]), as.factor(cal_5_class))

cw_uncal_ece5 = 0.25*(cw_MSI_ece_uncal5 + 
                 cw_CIN_ece_uncal5 + 
                 cw_EBV_ece_uncal5 + 
                 cw_GS_ece_uncal5)

cw_uncal_mce5 = max(c(cw_MSI_mce_uncal5, 
               cw_CIN_mce_uncal5 ,
               cw_EBV_mce_uncal5, 
               cw_GS_mce_uncal5))
dirichlet_cal_prob = (cal_5[,2:5])/rowSums(cal_5[,2:5])
brier.uncal_prob5 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_5[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_5_class = predict(dirichlet_cal,newdata = test_prob5, type="raw")
dirichlet_cal_5_prob = predict(dirichlet_cal,newdata = test_prob5, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_5_prob
data_dir_cal$true_class = class_5[,2]
data_dir_cal$pred_class = dirichlet_cal_5_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal5 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir5plotdata = conf_ece_dir
cw_MSI_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir5 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir5plotdata = conf_ece_dir
cw_CIN_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir5 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir5plotdata = conf_ece_dir
cw_EBV_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir5 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir5plotdata = conf_ece_dir
cw_GS_ece_dir5 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir5 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir5_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir5 <- weighted.mean(absolute_diff, weight)
conf_mce_dir5 = max(absolute_diff)
```
```{r}
acc_dir5 = confusionMatrix(as.factor(class_5[,2]), as.factor(dirichlet_cal_5_class))


cw_dir_ece5 = 0.25*(cw_MSI_ece_dir5 + 
                 cw_CIN_ece_dir5 + 
                 cw_EBV_ece_dir5 + 
                 cw_GS_ece_dir5)

cw_dir_mce5 = max(c(cw_MSI_mce_dir5, 
               cw_CIN_mce_dir5 ,
               cw_EBV_mce_dir5, 
               cw_GS_mce_dir5))
#Brier
dirichlet_cal_prob = (dirichlet_cal_5_prob)/rowSums(dirichlet_cal_5_prob)
brier.dirichlet_cal_prob5 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_5[,2]))
```


#CV6////////////////
```{r}
trainData6 = subtype_edata[trainRowNumbers$Resample06,]
testData6 = subtype_edata[-trainRowNumbers$Resample06,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData6[, 2:9285])
y= trainData6$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData6[, 2:9285])
y.test = testData6$SUBTYPE
y.test = as.factor(y.test)
```


```{r}
#Train data from model after feature selection
set.seed(99)
class_6_train = dplyr::select(trainData6, "SUBTYPE")
cal_6_train = predict(lasso.lasso.model6,newdata = x.lassoTCGA6, type="prob")
cal_6_train_class = predict(lasso.lasso.model6,newdata = x.lassoTCGA6, type="raw")
class_6_train = tibble::rownames_to_column(class_6_train, "patient_id")
cal_6_train = tibble::rownames_to_column(cal_6_train, "patient_id")
cal_data6_train = merge(class_6_train,cal_6_train, by="patient_id")
cal_data6_train = tibble::column_to_rownames(cal_data6_train, "patient_id")

train_prob6 = cal_6_train[,2:5]
train_prob6 = as.data.frame(log(train_prob6))
```
#Uncalibrated
```{r}
#Outer fold test data
class_6 = dplyr::select(testData6, "SUBTYPE")
cal_6 = predict(lasso.lasso.model6,newdata = x.lasso.testTCGA6, type="prob")
cal_6_class = predict(lasso.lasso.model6,newdata = x.lasso.testTCGA6, type="raw")
class_6 = tibble::rownames_to_column(class_6, "patient_id")
cal_6 = tibble::rownames_to_column(cal_6, "patient_id")
cal_data6 = merge(class_6,cal_6, by="patient_id")
cal_data6 = tibble::column_to_rownames(cal_data6, "patient_id")

test_prob6 = cal_6[,2:5]
test_prob6 = as.data.frame(log(test_prob6)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob6,as.factor(class_6_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal6 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_6[,2:5]
data_dir_cal$true_class = class_6[,2]
data_dir_cal$pred_class = cal_6_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal6 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal6plotdata = conf_ece_dir
cw_MSI_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal6 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal6plotdata = conf_ece_dir
cw_CIN_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal6 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal6plotdata = conf_ece_dir
cw_EBV_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal6 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal6plotdata = conf_ece_dir
cw_GS_ece_uncal6 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal6 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal6_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal6 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal6 = max(absolute_diff)
```
```{r}
acc_uncal6 = confusionMatrix(as.factor(class_6[,2]), as.factor(cal_6_class))

cw_uncal_ece6 = 0.25*(cw_MSI_ece_uncal6 + 
                 cw_CIN_ece_uncal6 + 
                 cw_EBV_ece_uncal6 + 
                 cw_GS_ece_uncal6)

cw_uncal_mce6 = max(c(cw_MSI_mce_uncal6, 
               cw_CIN_mce_uncal6 ,
               cw_EBV_mce_uncal6, 
               cw_GS_mce_uncal6))
dirichlet_cal_prob = (cal_6[,2:5])/rowSums(cal_6[,2:5])
brier.uncal_prob6 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_6[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_6_class = predict(dirichlet_cal,newdata = test_prob6, type="raw")
dirichlet_cal_6_prob = predict(dirichlet_cal,newdata = test_prob6, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_6_prob
data_dir_cal$true_class = class_6[,2]
data_dir_cal$pred_class = dirichlet_cal_6_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal6 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir6plotdata = conf_ece_dir
cw_MSI_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir6 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir6plotdata = conf_ece_dir
cw_CIN_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir6 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir6plotdata = conf_ece_dir
cw_EBV_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir6 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir6plotdata = conf_ece_dir
cw_GS_ece_dir6 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir6 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir6_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir6 <- weighted.mean(absolute_diff, weight)
conf_mce_dir6 = max(absolute_diff)
```
```{r}
acc_dir6 = confusionMatrix(as.factor(class_6[,2]), as.factor(dirichlet_cal_6_class))


cw_dir_ece6 = 0.25*(cw_MSI_ece_dir6 + 
                 cw_CIN_ece_dir6 + 
                 cw_EBV_ece_dir6 + 
                 cw_GS_ece_dir6)

cw_dir_mce6 = max(c(cw_MSI_mce_dir6, 
               cw_CIN_mce_dir6 ,
               cw_EBV_mce_dir6, 
               cw_GS_mce_dir6))
#Brier
dirichlet_cal_prob = (dirichlet_cal_6_prob)/rowSums(dirichlet_cal_6_prob)
brier.dirichlet_cal_prob6 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_6[,2]))
```


#CV7////////////////
```{r}
trainData7 = subtype_edata[trainRowNumbers$Resample07,]
testData7 = subtype_edata[-trainRowNumbers$Resample07,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData7[, 2:9285])
y= trainData7$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData7[, 2:9285])
y.test = testData7$SUBTYPE
y.test = as.factor(y.test)
```


```{r}
#Train data from model after feature selection
set.seed(99)
class_7_train = dplyr::select(trainData7, "SUBTYPE")
cal_7_train = predict(lasso.lasso.model7,newdata = x.lassoTCGA7, type="prob")
cal_7_train_class = predict(lasso.lasso.model7,newdata = x.lassoTCGA7, type="raw")
class_7_train = tibble::rownames_to_column(class_7_train, "patient_id")
cal_7_train = tibble::rownames_to_column(cal_7_train, "patient_id")
cal_data7_train = merge(class_7_train,cal_7_train, by="patient_id")
cal_data7_train = tibble::column_to_rownames(cal_data7_train, "patient_id")

train_prob7 = cal_7_train[,2:5]
train_prob7 = as.data.frame(log(train_prob7))
```
#Uncalibrated
```{r}
#Outer fold test data
class_7 = dplyr::select(testData7, "SUBTYPE")
cal_7 = predict(lasso.lasso.model7,newdata = x.lasso.testTCGA7, type="prob")
cal_7_class = predict(lasso.lasso.model7,newdata = x.lasso.testTCGA7, type="raw")
class_7 = tibble::rownames_to_column(class_7, "patient_id")
cal_7 = tibble::rownames_to_column(cal_7, "patient_id")
cal_data7 = merge(class_7,cal_7, by="patient_id")
cal_data7 = tibble::column_to_rownames(cal_data7, "patient_id")

test_prob7 = cal_7[,2:5]
test_prob7 = as.data.frame(log(test_prob7)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal7 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_7[,2:5]
data_dir_cal$true_class = class_7[,2]
data_dir_cal$pred_class = cal_7_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal7 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal7plotdata = conf_ece_dir
cw_MSI_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal7 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal7plotdata = conf_ece_dir
cw_CIN_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal7 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal7plotdata = conf_ece_dir
cw_EBV_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal7 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal7plotdata = conf_ece_dir
cw_GS_ece_uncal7 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal7 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal7_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal7 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal7 = max(absolute_diff)
```
```{r}
acc_uncal7 = confusionMatrix(as.factor(class_7[,2]), as.factor(cal_7_class))

cw_uncal_ece7 = 0.25*(cw_MSI_ece_uncal7 + 
                 cw_CIN_ece_uncal7 + 
                 cw_EBV_ece_uncal7 + 
                 cw_GS_ece_uncal7)

cw_uncal_mce7 = max(c(cw_MSI_mce_uncal7, 
               cw_CIN_mce_uncal7 ,
               cw_EBV_mce_uncal7, 
               cw_GS_mce_uncal7))
dirichlet_cal_prob = (cal_7[,2:5])/rowSums(cal_7[,2:5])
brier.uncal_prob7 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_7[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_7_class = predict(dirichlet_cal,newdata = test_prob7, type="raw")
dirichlet_cal_7_prob = predict(dirichlet_cal,newdata = test_prob7, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_7_prob
data_dir_cal$true_class = class_7[,2]
data_dir_cal$pred_class = dirichlet_cal_7_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal7 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir7plotdata = conf_ece_dir
cw_MSI_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir7 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir7plotdata = conf_ece_dir
cw_CIN_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir7 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir7plotdata = conf_ece_dir
cw_EBV_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir7 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir7plotdata = conf_ece_dir
cw_GS_ece_dir7 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir7 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir7_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir7 <- weighted.mean(absolute_diff, weight)
conf_mce_dir7 = max(absolute_diff)
```
```{r}
acc_dir7 = confusionMatrix(as.factor(class_7[,2]), as.factor(dirichlet_cal_7_class))


cw_dir_ece7 = 0.25*(cw_MSI_ece_dir7 + 
                 cw_CIN_ece_dir7 + 
                 cw_EBV_ece_dir7 + 
                 cw_GS_ece_dir7)

cw_dir_mce7 = max(c(cw_MSI_mce_dir7, 
               cw_CIN_mce_dir7 ,
               cw_EBV_mce_dir7, 
               cw_GS_mce_dir7))
#Brier
dirichlet_cal_prob = (dirichlet_cal_7_prob)/rowSums(dirichlet_cal_7_prob)
brier.dirichlet_cal_prob7 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_7[,2]))
```


#CV8////////////////
```{r}
trainData8 = subtype_edata[trainRowNumbers$Resample08,]
testData8 = subtype_edata[-trainRowNumbers$Resample08,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData8[, 2:9285])
y= trainData8$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData8[, 2:9285])
y.test = testData8$SUBTYPE
y.test = as.factor(y.test)
```


```{r}
#Train data from model after feature selection
set.seed(99)
class_8_train = dplyr::select(trainData8, "SUBTYPE")
cal_8_train = predict(lasso.lasso.model8,newdata = x.lassoTCGA8, type="prob")
cal_8_train_class = predict(lasso.lasso.model8,newdata = x.lassoTCGA8, type="raw")
class_8_train = tibble::rownames_to_column(class_8_train, "patient_id")
cal_8_train = tibble::rownames_to_column(cal_8_train, "patient_id")
cal_data8_train = merge(class_8_train,cal_8_train, by="patient_id")
cal_data8_train = tibble::column_to_rownames(cal_data8_train, "patient_id")

train_prob8 = cal_8_train[,2:5]
train_prob8 = as.data.frame(log(train_prob8))
```
#Uncalibrated
```{r}
#Outer fold test data
class_8 = dplyr::select(testData8, "SUBTYPE")
cal_8 = predict(lasso.lasso.model8,newdata = x.lasso.testTCGA8, type="prob")
cal_8_class = predict(lasso.lasso.model8,newdata = x.lasso.testTCGA8, type="raw")
class_8 = tibble::rownames_to_column(class_8, "patient_id")
cal_8 = tibble::rownames_to_column(cal_8, "patient_id")
cal_data8 = merge(class_8,cal_8, by="patient_id")
cal_data8 = tibble::column_to_rownames(cal_data8, "patient_id")

test_prob8 = cal_8[,2:5]
test_prob8 = as.data.frame(log(test_prob8)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob8,as.factor(class_8_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal8 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_8[,2:5]
data_dir_cal$true_class = class_8[,2]
data_dir_cal$pred_class = cal_8_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal8 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal8plotdata = conf_ece_dir
cw_MSI_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal8 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal8plotdata = conf_ece_dir
cw_CIN_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal8 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal8plotdata = conf_ece_dir
cw_EBV_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal8 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal8plotdata = conf_ece_dir
cw_GS_ece_uncal8 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal8 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal4_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal8 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal8 = max(absolute_diff)
```
```{r}
acc_uncal8 = confusionMatrix(as.factor(class_8[,2]), as.factor(cal_8_class))

cw_uncal_ece8 = 0.25*(cw_MSI_ece_uncal8 + 
                 cw_CIN_ece_uncal8 + 
                 cw_EBV_ece_uncal8 + 
                 cw_GS_ece_uncal8)

cw_uncal_mce8 = max(c(cw_MSI_mce_uncal8, 
               cw_CIN_mce_uncal8 ,
               cw_EBV_mce_uncal8, 
               cw_GS_mce_uncal8))
dirichlet_cal_prob = (cal_8[,2:5])/rowSums(cal_8[,2:5])
brier.uncal_prob8 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_8[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_8_class = predict(dirichlet_cal,newdata = test_prob8, type="raw")
dirichlet_cal_8_prob = predict(dirichlet_cal,newdata = test_prob8, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_8_prob
data_dir_cal$true_class = class_8[,2]
data_dir_cal$pred_class = dirichlet_cal_8_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal8 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir8plotdata = conf_ece_dir
cw_MSI_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir8 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir8plotdata = conf_ece_dir
cw_CIN_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir8 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir8plotdata = conf_ece_dir
cw_EBV_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir8 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir8plotdata = conf_ece_dir
cw_GS_ece_dir8 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir8 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir8_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir8 <- weighted.mean(absolute_diff, weight)
conf_mce_dir8 = max(absolute_diff)
```
```{r}
acc_dir8 = confusionMatrix(as.factor(class_8[,2]), as.factor(dirichlet_cal_8_class))


cw_dir_ece8 = 0.25*(cw_MSI_ece_dir8 + 
                 cw_CIN_ece_dir8 + 
                 cw_EBV_ece_dir8 + 
                 cw_GS_ece_dir8)

cw_dir_mce8 = max(c(cw_MSI_mce_dir8, 
               cw_CIN_mce_dir8 ,
               cw_EBV_mce_dir8, 
               cw_GS_mce_dir8))
#Brier
dirichlet_cal_prob = (dirichlet_cal_8_prob)/rowSums(dirichlet_cal_8_prob)
brier.dirichlet_cal_prob8 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_8[,2]))
```


#CV9////////////////
```{r}
trainData9 = subtype_edata[trainRowNumbers$Resample09,]
testData9 = subtype_edata[-trainRowNumbers$Resample09,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData9[, 2:9285])
y= trainData9$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData9[, 2:9285])
y.test = testData9$SUBTYPE
y.test = as.factor(y.test)
```

```{r}
#Train data from model after feature selection
set.seed(99)
class_9_train = dplyr::select(trainData9, "SUBTYPE")
cal_9_train = predict(lasso.lasso.model9,newdata = x.lassoTCGA9, type="prob")
cal_9_train_class = predict(lasso.lasso.model9,newdata = x.lassoTCGA9, type="raw")
class_9_train = tibble::rownames_to_column(class_9_train, "patient_id")
cal_9_train = tibble::rownames_to_column(cal_9_train, "patient_id")
cal_data9_train = merge(class_9_train,cal_9_train, by="patient_id")
cal_data9_train = tibble::column_to_rownames(cal_data9_train, "patient_id")

train_prob9 = cal_9_train[,2:5]
train_prob9 = as.data.frame(log(train_prob9))
```
#Uncalibrated
```{r}
#Outer fold test data
class_9 = dplyr::select(testData9, "SUBTYPE")
cal_9 = predict(lasso.lasso.model9,newdata = x.lasso.testTCGA9, type="prob")
cal_9_class = predict(lasso.lasso.model9,newdata = x.lasso.testTCGA9, type="raw")
class_9 = tibble::rownames_to_column(class_9, "patient_id")
cal_9 = tibble::rownames_to_column(cal_9, "patient_id")
cal_data9 = merge(class_9,cal_9, by="patient_id")
cal_data9 = tibble::column_to_rownames(cal_data9, "patient_id")

test_prob9 = cal_9[,2:5]
test_prob9 = as.data.frame(log(test_prob9)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob9,as.factor(class_9_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal9 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_9[,2:5]
data_dir_cal$true_class = class_9[,2]
data_dir_cal$pred_class = cal_9_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal9 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal9plotdata = conf_ece_dir
cw_MSI_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal9 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal9plotdata = conf_ece_dir
cw_CIN_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal9 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal9plotdata = conf_ece_dir
cw_EBV_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal9 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal9plotdata = conf_ece_dir
cw_GS_ece_uncal9 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal9 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal9_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal9 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal9 = max(absolute_diff)
```
```{r}
acc_uncal9 = confusionMatrix(as.factor(class_9[,2]), as.factor(cal_9_class))

cw_uncal_ece9 = 0.25*(cw_MSI_ece_uncal9 + 
                 cw_CIN_ece_uncal9 + 
                 cw_EBV_ece_uncal9 + 
                 cw_GS_ece_uncal9)

cw_uncal_mce9 = max(c(cw_MSI_mce_uncal9, 
               cw_CIN_mce_uncal9 ,
               cw_EBV_mce_uncal9, 
               cw_GS_mce_uncal9))
dirichlet_cal_prob = (cal_9[,2:5])/rowSums(cal_9[,2:5])
brier.uncal_prob9 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_9[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_9_class = predict(dirichlet_cal,newdata = test_prob9, type="raw")
dirichlet_cal_9_prob = predict(dirichlet_cal,newdata = test_prob9, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_9_prob
data_dir_cal$true_class = class_9[,2]
data_dir_cal$pred_class = dirichlet_cal_9_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal9 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir9plotdata = conf_ece_dir
cw_MSI_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir9 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir9plotdata = conf_ece_dir
cw_CIN_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir9 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir9plotdata = conf_ece_dir
cw_EBV_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir9 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir9plotdata = conf_ece_dir
cw_GS_ece_dir9 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir9 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir9_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir9 <- weighted.mean(absolute_diff, weight)
conf_mce_dir9 = max(absolute_diff)
```
```{r}
acc_dir9 = confusionMatrix(as.factor(class_9[,2]), as.factor(dirichlet_cal_9_class))


cw_dir_ece9 = 0.25*(cw_MSI_ece_dir9 + 
                 cw_CIN_ece_dir9 + 
                 cw_EBV_ece_dir9 + 
                 cw_GS_ece_dir9)

cw_dir_mce9 = max(c(cw_MSI_mce_dir9, 
               cw_CIN_mce_dir9 ,
               cw_EBV_mce_dir9, 
               cw_GS_mce_dir9))
#Brier
dirichlet_cal_prob = (dirichlet_cal_9_prob)/rowSums(dirichlet_cal_9_prob)
brier.dirichlet_cal_prob9 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_9[,2]))
```


#CV10////////////////
```{r}
trainData10 = subtype_edata[trainRowNumbers$Resample10,]
testData10 = subtype_edata[-trainRowNumbers$Resample10,]
```
```{r}
#Make our test and train data
x=data.matrix(trainData10[, 2:9285])
y= trainData10$SUBTYPE
y = as.factor(y)
x.test= data.matrix(testData10[, 2:9285])
y.test = testData10$SUBTYPE
y.test = as.factor(y.test)
```


```{r}
#Train data from model after feature selection
set.seed(99)
class_10_train = dplyr::select(trainData10, "SUBTYPE")
cal_10_train = predict(lasso.lasso.model10,newdata = x.lassoTCGA10, type="prob")
cal_10_train_class = predict(lasso.lasso.model10,newdata = x.lassoTCGA10, type="raw")
class_10_train = tibble::rownames_to_column(class_10_train, "patient_id")
cal_10_train = tibble::rownames_to_column(cal_10_train, "patient_id")
cal_data10_train = merge(class_10_train,cal_10_train, by="patient_id")
cal_data10_train = tibble::column_to_rownames(cal_data10_train, "patient_id")

train_prob10 = cal_10_train[,2:5]
train_prob10 = as.data.frame(log(train_prob10))
```
#Uncalibrated
```{r}
#Outer fold test data
class_10 = dplyr::select(testData10, "SUBTYPE")
cal_10 = predict(lasso.lasso.model10,newdata = x.lasso.testTCGA10, type="prob")
cal_10_class = predict(lasso.lasso.model10,newdata = x.lasso.testTCGA10, type="raw")
class_10 = tibble::rownames_to_column(class_10, "patient_id")
cal_10 = tibble::rownames_to_column(cal_10, "patient_id")
cal_data10 = merge(class_10,cal_10, by="patient_id")
cal_data10 = tibble::column_to_rownames(cal_data10, "patient_id")

test_prob10 = cal_10[,2:5]
test_prob10 = as.data.frame(log(test_prob10)) #log transformed input to calibration models
```
#Dirichlet logloss
```{r}
set.seed(99)
dirichlet_cal = caret::train(train_prob1,as.factor(class_1_train[,2]),'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
dirichlet_cal10 = dirichlet_cal
```


####ORGANIZE DATA CV1
#Organize data output for Uncalibrated
```{r}
data_dir_cal = cal_10[,2:5]
data_dir_cal$true_class = class_10[,2]
data_dir_cal$pred_class = cal_10_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_uncal10 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_uncal10plotdata = conf_ece_dir
cw_MSI_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_uncal10 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_uncal10plotdata = conf_ece_dir
cw_CIN_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_uncal10 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_uncal10plotdata = conf_ece_dir
cw_EBV_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_uncal10 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_uncal10plotdata = conf_ece_dir
cw_GS_ece_uncal10 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_uncal10 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal10_plotdata = conf_ece_dir
```
#####Uncalibrated metrics
```{r}
conf_ece_uncal10 <- weighted.mean(absolute_diff, weight)
conf_mce_uncal10 = max(absolute_diff)
```
```{r}
acc_uncal10 = confusionMatrix(as.factor(class_10[,2]), as.factor(cal_10_class))

cw_uncal_ece10 = 0.25*(cw_MSI_ece_uncal10 + 
                 cw_CIN_ece_uncal10 + 
                 cw_EBV_ece_uncal10 + 
                 cw_GS_ece_uncal10)

cw_uncal_mce10 = max(c(cw_MSI_mce_uncal10, 
               cw_CIN_mce_uncal10 ,
               cw_EBV_mce_uncal10, 
               cw_GS_mce_uncal10))
dirichlet_cal_prob = (cal_10[,2:5])/rowSums(cal_10[,2:5])
brier.uncal_prob10 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_10[,2]))
```


#Dirichlet predictions
```{r}
dirichlet_cal_10_class = predict(dirichlet_cal,newdata = test_prob10, type="raw")
dirichlet_cal_10_prob = predict(dirichlet_cal,newdata = test_prob10, type="prob")
```
#####Organize data output for Dirichlet
```{r}
data_dir_cal = dirichlet_cal_10_prob
data_dir_cal$true_class = class_10[,2]
data_dir_cal$pred_class = dirichlet_cal_10_class
```
```{r}
data_dir_cal = as.data.frame(data_dir_cal)
colnames(data_dir_cal)= c("STAD_CIN", "STAD_EBV", "STAD_GS", "STAD_MSI", "true_class", "pred_class")
data_dir_cal$correct = (data_dir_cal$true_class == data_dir_cal$pred_class)

data_dir_cal$STAD_CIN_bin = cut(data_dir_cal$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_EBV_bin = cut(data_dir_cal$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_GS_bin = cut(data_dir_cal$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
data_dir_cal$STAD_MSI_bin = cut(data_dir_cal$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))

data_dir_cal$CIN_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "STAD_CIN", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$CIN_subtype = as.factor(data_dir_cal$CIN_subtype)
data_dir_cal$CIN_subtype <- factor(data_dir_cal$CIN_subtype, levels = c("STAD_CIN", "Other"))

data_dir_cal$MSI_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "Other", "STAD_MSI" = "STAD_MSI"))
data_dir_cal$MSI_subtype = as.factor(data_dir_cal$MSI_subtype)
data_dir_cal$MSI_subtype <- factor(data_dir_cal$MSI_subtype, levels = c("STAD_MSI", "Other"))

data_dir_cal$EBV_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "STAD_EBV", "STAD_GS" = "Other", "STAD_MSI" = "Other"))
data_dir_cal$EBV_subtype = as.factor(data_dir_cal$EBV_subtype)
data_dir_cal$EBV_subtype <- factor(data_dir_cal$EBV_subtype, levels = c("STAD_EBV", "Other"))

data_dir_cal$GS_subtype = str_replace_all(data_dir_cal$true_class, c("STAD_CIN" = "Other", "STAD_EBV" = "Other", "STAD_GS" = "STAD_GS", "STAD_MSI" = "Other"))
data_dir_cal$GS_subtype = as.factor(data_dir_cal$GS_subtype)
data_dir_cal$GS_subtype <- factor(data_dir_cal$GS_subtype, levels = c("STAD_GS", "Other"))
```
```{r}
data_dir_cal10 = data_dir_cal
```
#####cw_MSI
```{r}
cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_MSI_ece_dir10plotdata = conf_ece_dir
cw_MSI_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_MSI_mce_dir10 = max(absolute_diff)
```
#####cw_CIN
```{r}
cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_CIN_ece_dir10plotdata = conf_ece_dir
cw_CIN_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_CIN_mce_dir10 = max(absolute_diff)
```
#####cw_EBV
```{r}
cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_EBV_ece_dir10plotdata = conf_ece_dir
cw_EBV_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_EBV_mce_dir10 = max(absolute_diff)
```
#####cw_GS
```{r}
cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
cw_GS_ece_dir10plotdata = conf_ece_dir
cw_GS_ece_dir10 <- weighted.mean(absolute_diff, weight)
cw_GS_mce_dir10 = max(absolute_diff)
```
####conf_ece/conf_mce
```{r}
conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
dir10_plotdata = conf_ece_dir
```
####Dirichlet metrics
```{r}
conf_ece_dir10 <- weighted.mean(absolute_diff, weight)
conf_mce_dir10 = max(absolute_diff)
```
```{r}
acc_dir10 = confusionMatrix(as.factor(class_10[,2]), as.factor(dirichlet_cal_10_class))


cw_dir_ece10 = 0.25*(cw_MSI_ece_dir10 + 
                 cw_CIN_ece_dir10 + 
                 cw_EBV_ece_dir10 + 
                 cw_GS_ece_dir10)

cw_dir_mce10 = max(c(cw_MSI_mce_dir10, 
               cw_CIN_mce_dir10 ,
               cw_EBV_mce_dir10, 
               cw_GS_mce_dir10))
#Brier
dirichlet_cal_prob = (dirichlet_cal_10_prob)/rowSums(dirichlet_cal_10_prob)
brier.dirichlet_cal_prob10 = multiclass.Brier(dirichlet_cal_prob,as.factor(class_10[,2]))
```


#Compile Dirichlet
```{r}
conf_ece_dir = mget(ls(pattern = 'conf_ece_dir\\d+'))
conf_ece_dir = data.frame(matrix(unlist(conf_ece_dir), nrow=length(conf_ece_dir), byrow=TRUE))  
colnames(conf_ece_dir) <- c("conf_ece_dir")

conf_mce_dir = mget(ls(pattern = 'conf_mce_dir\\d+'))
conf_mce_dir = data.frame(matrix(unlist(conf_mce_dir), nrow=length(conf_mce_dir), byrow=TRUE))  
colnames(conf_mce_dir) <- c("conf_mce_dir")

cw_dir_ece = mget(ls(pattern = 'cw_dir_ece\\d+'))
cw_dir_ece = data.frame(matrix(unlist(cw_dir_ece), nrow=length(cw_dir_ece), byrow=TRUE))  
colnames(cw_dir_ece) <- c("cw_ece_dir")

cw_dir_mce = mget(ls(pattern = 'cw_dir_mce\\d+'))
cw_dir_mce = data.frame(matrix(unlist(cw_dir_mce), nrow=length(cw_dir_mce), byrow=TRUE))  
colnames(cw_dir_mce) <- c("cw_mce_dir")

brier_dirichlet = mget(ls(pattern = 'brier.dirichlet_cal_prob\\d+'))
brier_dirichlet = data.frame(matrix(unlist(brier_dirichlet), nrow=length(brier_dirichlet), byrow=TRUE))  
colnames(brier_dirichlet) <- c("brier_dirichlet")

total_list <- lapply(mget(ls(pattern = 'acc_dir\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
dirichlet_accuracy <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(dirichlet_accuracy) <- c("Accuracy", "Kappa")

dirichlet_metrics = data.frame(dirichlet_accuracy, conf_ece_dir, conf_mce_dir, cw_dir_ece, cw_dir_mce, brier_dirichlet)

data_dir_cal_final = mget(ls(pattern = 'data_dir_cal\\d+'))
data_dir_cal_final = do.call(rbind, data_dir_cal_final)
```
```{r}
mean = lapply(dirichlet_metrics, mean)
sd = lapply(dirichlet_metrics, sd)

dirichlet_metrics_mean = melt(mean)
dirichlet_metrics_sd = melt(sd)
```
#Compile Uncal
```{r}
conf_ece_uncal = mget(ls(pattern = 'conf_ece_uncal\\d+'))
conf_ece_uncal = data.frame(matrix(unlist(conf_ece_uncal), nrow=length(conf_ece_uncal), byrow=TRUE))  
colnames(conf_ece_uncal) <- c("conf_ece_uncal")

conf_mce_uncal = mget(ls(pattern = 'conf_mce_uncal\\d+'))
conf_mce_uncal = data.frame(matrix(unlist(conf_mce_uncal), nrow=length(conf_mce_uncal), byrow=TRUE))  
colnames(conf_mce_uncal) <- c("conf_mce_uncal")

cw_uncal_ece = mget(ls(pattern = 'cw_uncal_ece\\d+'))
cw_uncal_ece = data.frame(matrix(unlist(cw_uncal_ece), nrow=length(cw_uncal_ece), byrow=TRUE))  
colnames(cw_uncal_ece) <- c("cw_ece_uncal")

cw_uncal_mce = mget(ls(pattern = 'cw_uncal_mce\\d+'))
cw_uncal_mce = data.frame(matrix(unlist(cw_uncal_mce), nrow=length(cw_uncal_mce), byrow=TRUE))  
colnames(cw_uncal_mce) <- c("cw_mce_uncal")

brier_uncal = mget(ls(pattern = 'brier.uncal_prob\\d+'))
brier_uncal = data.frame(matrix(unlist(brier_uncal), nrow=length(brier_uncal), byrow=TRUE))  
colnames(brier_uncal) <- c("brier_uncal")

total_list <- lapply(mget(ls(pattern = 'acc_uncal\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
uncal_accuracy <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(uncal_accuracy) <- c("Accuracy", "Kappa")

uncal_metrics = data.frame(uncal_accuracy, conf_ece_uncal, conf_mce_uncal, cw_uncal_ece, cw_uncal_mce, brier_uncal)

data_dir_uncal = mget(ls(pattern = 'data_dir_uncal\\d+'))
data_dir_uncal = do.call(rbind, data_dir_uncal)
```
```{r}
mean = lapply(uncal_metrics, mean)
sd = lapply(uncal_metrics, sd)

uncal_metrics_mean = melt(mean)
uncal_metrics_sd = melt(sd)
```



#SKCE per fold uncal
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_uncal1[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal1$true_class))
outcomes = as.integer(outcomes)
skce_uncal1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal2[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal2$true_class))
outcomes = as.integer(outcomes)
skce_uncal2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal3[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal3$true_class))
outcomes = as.integer(outcomes)
skce_uncal3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal4[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal4$true_class))
outcomes = as.integer(outcomes)
skce_uncal4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal5[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal5$true_class))
outcomes = as.integer(outcomes)
skce_uncal5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal6[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal6$true_class))
outcomes = as.integer(outcomes)
skce_uncal6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal7[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal7$true_class))
outcomes = as.integer(outcomes)
skce_uncal7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal8[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal8$true_class))
outcomes = as.integer(outcomes)
skce_uncal8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal9[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal9$true_class))
outcomes = as.integer(outcomes)
skce_uncal9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_uncal10[,1:4])
outcomes = as.numeric(as.factor(data_dir_uncal10$true_class))
outcomes = as.integer(outcomes)
skce_uncal10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_uncal = mget(ls(pattern = 'skce_uncal\\d+'))
skce_uncal = data.frame(matrix(unlist(skce_uncal), nrow=length(skce_uncal), byrow=TRUE))  
colnames(skce_uncal) <- c("skce_uncal")

skce_uncal_summary <- summarySE(skce_uncal, measurevar="skce_uncal")
```
#SKCE per fold dir logloss
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal1$true_class))
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal2$true_class))
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal3$true_class))
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal4$true_class))
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal5$true_class))
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal6$true_class))
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal7$true_class))
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal8$true_class))
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal9$true_class))
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal10$true_class))
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_dir = mget(ls(pattern = 'skce_dir\\d+'))
skce_dir = data.frame(matrix(unlist(skce_dir), nrow=length(skce_dir), byrow=TRUE))  
colnames(skce_dir) <- c("skce_dir")

skce_dir_summary <- summarySE(skce_dir, measurevar="skce_dir")

```

#SKCE per fold multinom logloss
```{r}
set.seed(1234)
predictions= as.matrix(data_dir_cal1[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal1$true_class))
outcomes = as.integer(outcomes)
skce_dir1 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal2[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal2$true_class))
outcomes = as.integer(outcomes)
skce_dir2 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal3[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal3$true_class))
outcomes = as.integer(outcomes)
skce_dir3 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal4[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal4$true_class))
outcomes = as.integer(outcomes)
skce_dir4 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal5[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal5$true_class))
outcomes = as.integer(outcomes)
skce_dir5 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal6[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal6$true_class))
outcomes = as.integer(outcomes)
skce_dir6 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal7[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal7$true_class))
outcomes = as.integer(outcomes)
skce_dir7 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal8[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal8$true_class))
outcomes = as.integer(outcomes)
skce_dir8 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal9[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal9$true_class))
outcomes = as.integer(outcomes)
skce_dir9 = skce$.(ce$RowVecs(predictions), outcomes)

set.seed(1234)
predictions= as.matrix(data_dir_cal10[,1:4])
outcomes = as.numeric(as.factor(data_dir_cal10$true_class))
outcomes = as.integer(outcomes)
skce_dir10 = skce$.(ce$RowVecs(predictions), outcomes)

skce_multinom = mget(ls(pattern = 'skce_dir\\d+'))
skce_multinom = data.frame(matrix(unlist(skce_multinom), nrow=length(skce_multinom), byrow=TRUE))  
colnames(skce_multinom) <- c("skce_multinom")

skce_multinom_summary <- summarySE(skce_multinom, measurevar="skce_multinom")

```
#Plots conf Uncal
```{r}
data_dir_cal = data_dir_uncal

conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal_plotdata_final = conf_ece_dir
```
```{r}
bin = as.factor(levels(uncal_plotdata_final$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
uncal_plotdata_final = left_join(plot_data, uncal_plotdata_final)
uncal_plotdata_final$weight[is.na(uncal_plotdata_final$weight)] <- 0

conf_plotdata_final = ggplot(uncal_plotdata_final, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(uncal_plotdata_final$weight*30), colour ="salmon") + theme_classic()
conf_plotdata_final
```
#####plot cw_MSI
```{r}
data_dir_cal = data_dir_uncal

cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_msi_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_msi_uncaldata_final
```
##### plot cw_CIN
```{r}
data_dir_cal = data_dir_uncal

cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_cin_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_cin_uncaldata_final
```
#####plot cw_EBV
```{r}
data_dir_cal = data_dir_uncal

cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_ebv_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_ebv_uncaldata_final
```
##### plot cw_GS
```{r}
data_dir_cal = data_dir_uncal

cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_gs_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_gs_uncaldata_final
```



#Plots dirichlet
```{r}
data_dir_cal = data_dir_cal_final

conf_ece =  cbind(data_dir_cal[c("true_class","pred_class", "correct")], MaxScore = do.call(pmax, c(data_dir_cal[,1:4], na.rm = TRUE)))
conf_ece$bin = cut(conf_ece$MaxScore, breaks=c(seq(from = 0, to = 1, by = 0.1)))

conf = conf_ece %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(MaxScore))) NA_real_ else mean(MaxScore, na.rm = TRUE),n = n()) 

acc = as.data.frame(table(conf_ece$bin,conf_ece$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]

conf_ece_dir = merge(conf,acc, by="bin")
```
```{r}
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
uncal_plotdata_final = conf_ece_dir
```
```{r}
bin = as.factor(levels(uncal_plotdata_final$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
uncal_plotdata_final = left_join(plot_data, uncal_plotdata_final)
uncal_plotdata_final$weight[is.na(uncal_plotdata_final$weight)] <- 0

conf_plotdata_final = ggplot(uncal_plotdata_final, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(uncal_plotdata_final$weight*30), colour ="salmon") + theme_classic()
conf_plotdata_final
```
#####plot cw_MSI
```{r}
data_dir_cal = data_dir_cal_final

cw_MSI = dplyr::select(data_dir_cal, c("STAD_MSI", "true_class", "MSI_subtype"))
cw_MSI$correct = (cw_MSI$true_class == cw_MSI$MSI_subtype)
cw_MSI$bin = cut(cw_MSI$STAD_MSI, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_MSI %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_MSI))) NA_real_ else mean(STAD_MSI, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_MSI$bin,cw_MSI$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_msi_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_msi_uncaldata_final
```
##### plot cw_CIN
```{r}
data_dir_cal = data_dir_cal_final

cw_CIN = dplyr::select(data_dir_cal, c("STAD_CIN", "true_class", "CIN_subtype"))
cw_CIN$correct = (cw_CIN$true_class == cw_CIN$CIN_subtype)
cw_CIN$bin = cut(cw_CIN$STAD_CIN, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_CIN %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_CIN))) NA_real_ else mean(STAD_CIN, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_CIN$bin,cw_CIN$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_cin_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_cin_uncaldata_final
```
#####plot cw_EBV
```{r}
data_dir_cal = data_dir_cal_final

cw_EBV = dplyr::select(data_dir_cal, c("STAD_EBV", "true_class", "EBV_subtype"))
cw_EBV$correct = (cw_EBV$true_class == cw_EBV$EBV_subtype)
cw_EBV$bin = cut(cw_EBV$STAD_EBV, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_EBV %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_EBV))) NA_real_ else mean(STAD_EBV, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_EBV$bin,cw_EBV$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_ebv_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_ebv_uncaldata_final
```
##### plot cw_GS
```{r}
data_dir_cal = data_dir_cal_final

cw_GS = dplyr::select(data_dir_cal, c("STAD_GS", "true_class", "GS_subtype"))
cw_GS$correct = (cw_GS$true_class == cw_GS$GS_subtype)
cw_GS$bin = cut(cw_GS$STAD_GS, breaks=c(seq(from = 0, to = 1, by = 0.1)))
conf = cw_GS %>%
  group_by(bin) %>%
  dplyr::summarize(confidence = if(all(is.na(STAD_GS))) NA_real_ else mean(STAD_GS, na.rm = TRUE),n = n()) 
acc = as.data.frame(table(cw_GS$bin,cw_GS$correct))
colnames(acc)= c("bin", "correct", "freq")
acc = dcast(acc, bin~ correct, value.var="freq")
acc$sum = acc[,2] + acc[,3]
acc$accuracy = acc[,3] / acc[,4]
conf_ece_dir = merge(conf,acc, by="bin")
absolute_diff = abs(conf_ece_dir$confidence-conf_ece_dir$accuracy)
weight <- c(conf_ece_dir$n)/sum(conf_ece_dir$n)
conf_ece_dir$weight = weight
```
```{r}
bin = as.factor(levels(conf_ece_dir$bin))
midpoint = c(seq(from = 0.05, to = 0.95, by = 0.1))
plot_data = data.frame(bin,midpoint)
conf_ece_dir = left_join(plot_data, conf_ece_dir)
conf_ece_dir$weight[is.na(conf_ece_dir$weight)] <- 0

cw_gs_uncaldata_final = ggplot(conf_ece_dir, aes(x=midpoint, y=accuracy, fill)) +
      geom_bar(stat="identity", fill="blue", colour="black", size = 0.6 , width = 0.1, position=position_dodge(0.5)) +
   scale_x_continuous(limits= c(0,1),labels=c(seq(from = 0, to = 1, by = 0.1)), breaks=c(seq(from = 0, to = 1, by = 0.1))) + 
   geom_abline(intercept = 0, slope = 1, size=1.3,linetype = "dashed", colour = "darkgray") +
  geom_linerange(aes(ymin = accuracy, ymax = midpoint), size = sqrt(conf_ece_dir$weight*30), colour ="salmon") + theme_classic()
cw_gs_uncaldata_final
```


```{r}
ggplot(data_dir_uncal) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

ggplot(data_dir_cal_final) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

ggplot(data_multinom_cal_final) +
              geom_histogram(aes(x=STAD_CIN, fill="#e9ecef", alpha=0.6, position = 'identity')) +
              geom_histogram(aes(x=STAD_MSI, fill="blue", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_EBV, fill="red", alpha=0.6, position = 'identity'))+ 
              geom_histogram(aes(x=STAD_GS, fill="green", alpha=0.6, position = 'identity'))

```


#Base cal plots
```{r}
x = c(data_dir_uncal$STAD_CIN, data_dir_uncal$STAD_EBV, data_dir_uncal$STAD_MSI, data_dir_uncal$STAD_GS)
y = c(data_dir_uncal$CIN_subtype, data_dir_uncal$EBV_subtype, data_dir_uncal$MSI_subtype, data_dir_uncal$GS_subtype)
y = ifelse(grepl("2", y, ignore.case = T), "TRUE", "FALSE")
df = data.frame(x,y)

cal_obj_all <- calibration(as.factor(df$y) ~ df$x , data = df, cuts = 10)
plot(cal_obj_all, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_CIN <- calibration(as.factor(data_dir_uncal$CIN_subtype) ~ data_dir_uncal$STAD_CIN , data = data_dir_uncal, class="STAD_CIN", cuts = 10)
plot(cal_obj_CIN, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_EBV <- calibration(as.factor(data_dir_uncal$EBV_subtype) ~ data_dir_uncal$STAD_EBV , data = data_dir_uncal, class="STAD_EBV", cuts = 10)
plot(cal_obj_EBV, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSI <- calibration(as.factor(data_dir_uncal$MSI_subtype) ~ data_dir_uncal$STAD_MSI , data = data_dir_uncal, class="STAD_MSI", cuts = 10)
plot(cal_obj_MSI, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_GS <- calibration(as.factor(data_dir_uncal$GS_subtype) ~ data_dir_uncal$STAD_GS , data = data_dir_uncal, class="STAD_GS", cuts = 10)
plot(cal_obj_GS, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_combined = rbind(cal_obj_GS$data, cal_obj_MSI$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_EBV$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_CIN$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_all$data)


g = ggplot(cal_obj_combined[41:50,], aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
      stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")

tcga_uncal_plot = g + geom_smooth(cal_obj_combined[1:40,],mapping = aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("TCGA Base Model Calibration Plot")  +
    scale_colour_manual(name = NULL, labels = c("CIN","EBV","GS","MSI","Mean Class \nCalibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 15)) +
                theme(axis.text.y = element_text(colour="black",size = 15)) + 
                theme(plot.title = element_text(colour="black", size=15,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =15, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=15)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.8,0.26),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
tcga_uncal_plot

ggsave("tcga_uncal_plot.svg", tcga_uncal_plot, width=5, height=4)


```
#Dirichlet cal plots
```{r}
x = c(data_dir_cal_final$STAD_CIN, data_dir_cal_final$STAD_EBV, data_dir_cal_final$STAD_MSI, data_dir_cal_final$STAD_GS)
y = c(data_dir_cal_final$CIN_subtype, data_dir_cal_final$EBV_subtype, data_dir_cal_final$MSI_subtype, data_dir_cal_final$GS_subtype)
y = ifelse(grepl("2", y, ignore.case = T), "TRUE", "FALSE")
df = data.frame(x,y)

cal_obj_all <- calibration(as.factor(df$y) ~ df$x , data = df, cuts = 10)
plot(cal_obj_all, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_CIN <- calibration(as.factor(data_dir_cal_final$CIN_subtype) ~ data_dir_cal_final$STAD_CIN , data = data_dir_cal_final, class="STAD_CIN", cuts = 10)
plot(cal_obj_CIN, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_EBV <- calibration(as.factor(data_dir_cal_final$EBV_subtype) ~ data_dir_cal_final$STAD_EBV , data = data_dir_cal_final, class="STAD_EBV", cuts = 10)
plot(cal_obj_EBV, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_MSI <- calibration(as.factor(data_dir_cal_final$MSI_subtype) ~ data_dir_cal_final$STAD_MSI , data = data_dir_cal_final, class="STAD_MSI", cuts = 10)
plot(cal_obj_MSI, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))
cal_obj_GS <- calibration(as.factor(data_dir_cal_final$GS_subtype) ~ data_dir_cal_final$STAD_GS , data = data_dir_cal_final, class="STAD_GS", cuts = 10)
plot(cal_obj_GS, type = "l", auto.key = list(columns = 1,
                                          lines = TRUE,
                                          points = TRUE))

cal_obj_combined = rbind(cal_obj_GS$data, cal_obj_MSI$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_EBV$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_CIN$data)
cal_obj_combined = rbind(cal_obj_combined, cal_obj_all$data)


g = ggplot(cal_obj_combined[41:50,], aes(x = midpoint ,y = Percent, colour = "Mean Class Calibration")) +
     geom_smooth(size=1.5, se=FALSE,fill = "blue", alpha = 0.1) +
      stat_smooth(geom='ribbon', aes(ymin = ifelse(..ymin.. < 0, 0, ..ymin..),ymax = ifelse(..ymax.. > 100, 100, ..ymax..)), alpha = 0.1,fill = "blue",linetype = 0) +
     geom_abline(intercept=0, linetype= "dashed")

tcga_dir_plot = g + geom_smooth(cal_obj_combined[1:40,],mapping = aes(x = midpoint ,y = Percent, colour=calibModelVar),size=1, se=FALSE,linetype = "solid", alpha = 0.8, span=0.75) +
    ylim(0,100) +
    xlab("Mean Predicted Value") +
    ylab("Observed Event Percentage") +
    ggtitle("TCGA L2 Dirichlet Calibration  Plot")  +
    scale_colour_manual(name = NULL, labels = c("CIN","EBV","GS","MSI","Mean Class \nCalibration [95% CI]"), values = c("#F39B7FFF", "#91D1C2FF", "#4DBBD5FF", "#E64B35FF","blue")) +
    theme_classic() +
                theme(panel.grid.major.y = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.y = element_line(colour = "gray", size = 0.1)) +
                theme(panel.grid.major.x = element_line(colour = "gray", size = 0.15)) +
                theme(panel.grid.minor.x = element_line(colour = "gray", size = 0.1)) +
                theme(axis.text.x = element_text(colour="black", size = 15)) +
                theme(axis.text.y = element_text(colour="black",size = 15)) + 
                theme(plot.title = element_text(colour="black", size=15,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =15, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=15)) +
                theme(legend.title = element_text(color = "black", size = 12),
                      legend.text = element_text(color = "black", size = 12),
                      legend.position = c(0.8,0.26),
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
tcga_dir_plot


ggsave("tcga_dir_plot.svg", tcga_dir_plot, width=5, height=4)

```


#Calibration_metrics_mean
```{r}
uncal_metrics_mean$model = "Uncalibrated"
uncal_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

dirichlet_metrics_mean$model = "Dirichlet Logloss"
dirichlet_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")

multinom_metrics_mean$model = "Multinomial Logistic Logloss"
multinom_metrics_mean$Metric = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")


calibration_metrics_mean = rbind(uncal_metrics_mean[,c(1,3:4)],dirichlet_metrics_mean[,c(1,3:4)],multinom_metrics_mean[,c(1,3:4)])

calibration_metrics_mean = dcast(calibration_metrics_mean, Metric~model, value.var="value")
```

#Calibration metrics 
```{r}
colnames(uncal_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
uncal_metrics$Model = "Uncalibrated"
uncal_metrics$SKCE = skce_uncal$skce_uncal

colnames(dirichlet_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
dirichlet_metrics$Model = "L2 Dirichlet Calibration"
dirichlet_metrics$SKCE = skce_dir$skce_dir

colnames(multinom_metrics) = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score")
multinom_metrics$Model = "Penalized Multinomial Logistic"
multinom_metrics$SKCE = skce_multinom$skce_multinom

calibration_metrics = rbind(uncal_metrics,dirichlet_metrics,multinom_metrics)
```
```{r}
library(tableone)
write.csv(calibration_metrics, file = "tcga_calibration_metrics_data.csv")


tcga_calibrated_table = CreateTableOne(vars = c("Accuracy", "Kappa", "SKCE","Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score"), strata = c("Model"), data = calibration_metrics)

print(tcga_calibrated_table, contDigits = 4, quote = TRUE, noSpaces = TRUE)

tcga_calibrated_table_tab <- print(tcga_calibrated_table,  contDigits = 4,quote = FALSE, noSpaces = TRUE, printToggle = FALSE, missing = TRUE, smd=TRUE)
write.csv(tcga_calibrated_table_tab, file = "tcga_calibrated_table_tab.csv")


tbl_summary(calibration_metrics,
            by = "Model",
             percent = "column", 
             include=c("Accuracy","Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE", "Multiclass Brier Score", "SKCE")) %>% add_p()
 


#Ttests

pairwise.t.test(calibration_metrics$Accuracy, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$Kappa, calibration_metrics$Model, p.adj = "BH")

pairwise.t.test(calibration_metrics$`Confidence ECE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Confidence MCE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Class-wise ECE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Class-wise MCE`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$`Multiclass Brier Score`, calibration_metrics$Model, p.adj = "BH")
pairwise.t.test(calibration_metrics$SKCE, calibration_metrics$Model, p.adj = "BH")





```

#Summary calibration metrics 
```{r}

summary(calibration_metrics)

calibration_metrics_long_boxplot = calibration_metrics %>% tidyr::pivot_longer(!Model, names_to = "Metric", values_to = "Value")
ggplot(calibration_metrics_long_boxplot, aes(fill=Model, y=Value, x=Metric)) + geom_boxplot()

calibration_metrics_long = calibration_metrics %>% tidyr::pivot_longer(!Model, names_to = "Metric", values_to = "Value")
calibration_metrics_long = as.data.frame(calibration_metrics_long)

calibration_metrics_long <- summarySE(calibration_metrics_long, measurevar="Value", groupvars=c("Model", "Metric"))
calibration_metrics_long_skce = dplyr::filter(calibration_metrics_long, Metric=="SKCE")
calibration_metrics_long = dplyr::filter(calibration_metrics_long, !Metric=="SKCE")

calibration_metrics_long$Model = factor(calibration_metrics_long$Model, levels = c("Uncalibrated", "L2 Dirichlet Calibration", "Penalized Multinomial Logistic"))
calibration_metrics_long_skce$Model = factor(calibration_metrics_long_skce$Model, levels = c("Uncalibrated", "L2 Dirichlet Calibration","Penalized Multinomial Logistic"))

calibration_metrics_long$Metric = factor(calibration_metrics_long$Metric, levels = c("Accuracy", "Kappa", "Confidence ECE", "Confidence MCE", "Class-wise ECE", "Class-wise MCE",  "Multiclass Brier Score"))



tcga_calibration_metrics_plot = ggplot(calibration_metrics_long, aes(fill=Model, y=Value, x=Metric)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(mapping = aes(ymin=Value-ci,ymax=Value+ci),
                 position=position_dodge(0.9), width=.3, color = "black", size = 0.5) +
    ylim(0,1) +
  ggtitle("TCGA Calibration Metrics") + 
  scale_fill_manual(values = c("skyblue3", "purple", "orange")) + 
  theme_classic() +
                theme(axis.text.x = element_text(colour="black", size = 12,angle = 45, hjust=1)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 10),
                      legend.text = element_text(color = "black", size = 10),
                      legend.position = "bottom",
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
tcga_calibration_metrics_plot

ggsave("tcga_calibration_metrics_plot.svg", tcga_calibration_metrics_plot, width=5, height=4)

write.csv(calibration_metrics_long, file = "calibration_metrics_long_tcga.csv")

tcga_calibration_skce_plot = ggplot(calibration_metrics_long_skce, aes(fill=Model, y=Value, x=Metric)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(mapping = aes(ymin=Value-ci,ymax=Value+ci),
                 position=position_dodge(0.9), width=.3, color = "black", size = 0.5) +
    ylim(-0.00025,0.013) +
    ggtitle("TCGA Calibration SKCE Metric") + 
    scale_fill_manual(values = c("skyblue3", "purple", "orange")) + 
    theme_classic() +
                theme(axis.text.x = element_text(colour="black", size = 12,angle = 45, hjust=1)) +
                theme(axis.text.y = element_text(colour="black",size = 12)) + 
                theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
                theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
                theme(axis.title.y = element_text(colour="black", size=12)) +
                theme(legend.title = element_text(color = "black", size = 10),
                      legend.text = element_text(color = "black", size = 10),
                      legend.position = "bottom",
                      legend.background = element_rect(size=NULL, linetype=NULL,colour =NULL, fill=alpha("white",0.7))) + 
    guides(colour = guide_legend(name = NULL)) 
tcga_calibration_skce_plot

ggsave("tcga_calibration_skce_plot.svg", tcga_calibration_skce_plot, width=5, height=4)

write.csv(calibration_metrics_long_skce, file = "calibration_metrics_long_skce_tcga.csv")


```


