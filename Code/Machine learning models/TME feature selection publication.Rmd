---
title: "TME Classification"
author: "Daniel Skubleny"
date: "04/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

General plan:
1. Reduce TME datasets to commongenes
2. Using FSQN make the datasets have similar distribution 
3. Compile the dataset into the larger final dataset 
4. Assess models using prior nested CV with internal feature selection and hyperparamter tuning 


TME datasets = ACRG, TCGA, Singapore, China(Shanghai), Korea Yonsei University
I need to check if the TCGA data contains the same patients. My TCGA dataset has 376. They included 374. 

```{r}
library(FSQN)
```
```{r}
#Data sets - reduce to commongenes and transpose for FSQN

#ACRG
TME_ACRG = subtype_ACRG
TME_ACRG = TME_ACRG[,2:9285]
#NEED TO REMOVE SUBTYPE COLUMN and transpose prior to FSQN

#TCGA
log_edata_fullTCGA <- subset(log_edata_fullTCGA, rownames(log_edata_fullTCGA) %in% as.matrix(commongenes))
TME_TCGA = t(log_edata_fullTCGA)

#Singapore 
subtype_sing <- subset(edata_sing, rownames(edata_sing) %in% as.matrix(commongenes))
TME_sing = t(subtype_sing)

#Samsung 
subtype_SMC <- subset(edata_SMC, rownames(edata_SMC) %in% as.matrix(commongenes))
TME_SMC = t(subtype_SMC)

#Shanghai
subtype_shanghai <- subset(edata_shanghai, rownames(edata_shanghai) %in% as.matrix(commongenes))
TME_shanghai = t(subtype_shanghai)

#Yonsei
subtype_yonsei <- subset(edata_yonsei, rownames(edata_yonsei) %in% as.matrix(commongenes))
TME_yonsei = t(subtype_yonsei)
```

```{r}
#TCGA FSQN to ACRG as reference due to predominate data derived from affymetrix platform and that TME clusters were established ACRG.
set.seed(99)
target = as.matrix(TME_ACRG)
test = as.matrix(TME_TCGA)
fsqn_tme_TCGA = quantileNormalizeByFeature(test, target)
density = t(fsqn_tme_TCGA)
```

```{r}
data = t(TME_ACRG)
colramp = colorRampPalette(c(3,"white",2))(20)
plot(density(data[,1]),col=colramp[1],lwd=1,ylim=c(0,.30))
for(i in 2:200){lines(density(data[,i]),lwd=1,col=colramp[i])}
```

```{r}
plot(density(density[,1]),col=colramp[1],lwd=1,ylim=c(0,.30))
for(i in 2:376){lines(density(density[,i]),lwd=1,col=colramp[i])}
```

```{r}
#Illustrate the modification of TCGA distribution to match ACRG
plot(density(density),col=colramp[1],lwd=1,ylim=c(0,.30),xlim=c(0,18))
lines(density(as.matrix(log_TCGA)))
```

```{r}
#FSQN for remaining datasets
set.seed(99)
target = as.matrix(TME_ACRG)
test = as.matrix(TME_sing)
fsqn_tme_sing = quantileNormalizeByFeature(test, target)

test = as.matrix(TME_SMC)
fsqn_tme_SMC = quantileNormalizeByFeature(test, target)

test = as.matrix(TME_shanghai)
fsqn_tme_shanghai = quantileNormalizeByFeature(test, target)

test = as.matrix(TME_yonsei)
fsqn_tme_yonsei = quantileNormalizeByFeature(test, target)
```

```{r}
#Add study id to data frames for PCA to examine efficacy of FSQN
fsqn_tme_TCGA = as.data.frame(fsqn_tme_TCGA)
fsqn_tme_TCGA$study = 'TCGA'
fsqn_tme_TCGA = fsqn_tme_TCGA[c(9285, 1:9284)]
```
```{r}
TME_ACRG = as.data.frame(TME_ACRG)
TME_ACRG$study = 'ACRG'
TME_ACRG = TME_ACRG[c(9285, 1:9284)]
```
```{r}
fsqn_tme_sing = as.data.frame(fsqn_tme_sing)
fsqn_tme_sing$study = 'Singapore'
fsqn_tme_sing = fsqn_tme_sing[c(9285, 1:9284)]
```
```{r}
fsqn_tme_SMC = as.data.frame(fsqn_tme_SMC)
fsqn_tme_SMC$study = 'SMC'
fsqn_tme_SMC = fsqn_tme_SMC[c(9285, 1:9284)]
```
```{r}
fsqn_tme_shanghai = as.data.frame(fsqn_tme_shanghai)
fsqn_tme_shanghai$study = 'Shanghai'
fsqn_tme_shanghai = fsqn_tme_shanghai[c(9285, 1:9284)]
```
```{r}
fsqn_tme_yonsei = as.data.frame(fsqn_tme_yonsei)
fsqn_tme_yonsei$study = 'Yonsei'
fsqn_tme_yonsei = fsqn_tme_yonsei[c(9285, 1:9284)]
```

```{r}
#Combine into full dataframe with all patients 
tme = rbind(fsqn_tme_TCGA, TME_ACRG)
tme = rbind(tme, fsqn_tme_sing)
tme = rbind(tme, fsqn_tme_SMC)
tme = rbind(tme, fsqn_tme_shanghai)
tme = rbind(tme, fsqn_tme_yonsei)
```

#PCA for studies before and after FSQN
```{r}
#Create combined data frame prior to FSQN
tme_batch = rbind(TME_TCGA, TME_ACRG[,2:9285])
tme_batch = rbind(tme_batch, TME_sing)
tme_batch = rbind(tme_batch, TME_SMC)
tme_batch = rbind(tme_batch, TME_shanghai)
tme_batch = rbind(tme_batch, TME_yonsei)
tme_batch = t(tme_batch)
tme_batch = as.data.frame(tme_batch)
```


```{r}
#PCA to assess for batch effects
tme_study = dplyr::select(tme, c("study"))
tme_pca = dplyr::select(tme, -c("study"))
tme_pca = t(tme_pca)
tme_pca =  as.data.frame(tme_pca)
```
```{r}
#PCA to assess for batch effects
tme_batch[,1:ncol(tme_batch)] = lapply(1:ncol(tme_batch),function(x) as.numeric(tme_batch[[x]]))
tme_batch = (tme_batch) - rowMeans(tme_batch)
svd_batch = svd(tme_batch)
plot(svd_batch$v[,1],svd_batch$v[,2],xlab="PC1",ylab="PC2",col=as.factor(tme_study$study))
#Here we can see that there is significant grouping by study.
```
```{r}
tme_pca[,1:ncol(tme_pca)] = lapply(1:ncol(tme_pca),function(x) as.numeric(tme_pca[[x]]))
tme_pca = (tme_pca) - rowMeans(tme_pca)
svd_fsqn = svd(tme_pca)
plot(svd_fsqn$v[,1],svd_fsqn$v[,2],xlab="PC1",ylab="PC2",col=as.factor(tme_study$study))
#Here we can see that there is no clear variation attributable to the study - aka no platform specific effects after FSQN
```


```{r}
#Import reference classifications
library(readxl)
tmescore <- read_excel("~/Documents/PhD/Gastric cancer genomic Data/TME Score/204325_4_supp_5320157_pmcfmm.xlsx", sheet = "S12")
```
```{r}
#Clean data sheet
colnames(tmescore) <- tmescore[1,]
tmescore = tmescore[-1,]
tmescore_subset = dplyr::select(tmescore, c("ID","TMEscore_binary"))
```
```{r}
#Slice or subset out the TCGA data from the data frame.
tmescore_tcgafix = dplyr::slice(tmescore_subset, 562:935)
```
```{r}
#Modify TCGA ID to match the id in our data frame and make compatible with R.
df = as.data.frame(tmescore_tcgafix[,"ID"])
df = df$ID = str_replace_all(df$ID, c("-" = "."))
#Add this stirng to end of TCGA labels to make them compatabile.
df = sapply(df, paste, ".01", sep="")
tmescore_tcgafix$newID = df
#Remove the old ID label. Rename the new label as ID. Reorder columns.
tmescore_tcgafix = dplyr::select(tmescore_tcgafix, -c("ID",))
colnames(tmescore_tcgafix)[which(names(tmescore_tcgafix) == "newID")] <- "ID"
tmescore_tcgafix = tmescore_tcgafix[c(2, 1)]
#Remove old TCGA labels and replace with the updated labels
tmescore_subset = tmescore_subset[-c(562:935),]
tmescore_subset = rbind(tmescore_subset, tmescore_tcgafix)
#Merge data frames to allow classification.
tme = tibble::rownames_to_column(tme, "ID")
tme = merge(tmescore_subset,tme, by.x="ID")
tme = tme %>% tibble::column_to_rownames("ID") # Make the first column the row name
table(dim(tme))
table(tme$study)
dim(tmescore)
View(tme)
```

```{r}
#PCA per high vs low.
tme_principlecomponent = tme[,-c(1:2)]
tme_principlecomponent = (tme_principlecomponent) - rowMeans(tme_principlecomponent)
svd_tme_principalcomponent = svd(tme_principalcomponent)
plot(svd_tme_principalcomponent$v[,1],svd_tme_principalcomponent$v[,2],xlab="PC1",ylab="PC2",col=as.factor(tme$TMEscore_binary))
```
### THIS IS WHERE I NEED TO ESTABLISH MY NESTED CV. 

```{r}
subtype_tme = as.data.frame(tme)
#Create 80/20% data split at random

#Convert numeric columns to numeric
subtype_tme[,3:ncol(subtype_tme)] = lapply(3:ncol(subtype_tme),function(x) as.numeric(subtype_tme[[x]]))
```
```{r}
set.seed(99)
trainRowNumbers_tme = createDataPartition(subtype_tme$TMEscore_binary, p=0.8,list=FALSE,times = 10)
trainRowNumbers_tme = as.data.frame(trainRowNumbers_tme)
```

#/////CV fold 1 for lasso features/////
```{r}
trainData_tme1 = subtype_tme[trainRowNumbers_tme$Resample01,]
testData_tme1 = subtype_tme[-trainRowNumbers_tme$Resample01,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme1[, 3:9286])
y= trainData_tme1$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme1[, 3:9286])
y.test = testData_tme1$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model1 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso1 = confusionMatrix(table.lasso.tme)
full.tme.lasso1
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull1 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull1
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme1 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme1 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model1 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme1 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme1
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso1 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso1
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model1 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme1 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme1
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso1 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso1
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model1 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme1 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme1
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme1 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme1
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model1 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme1 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme1
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso1 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso1
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model1 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme1 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme1
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso1 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso1
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model1 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme1 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme1
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso1 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso1
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model1 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme1 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme1
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso1 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso1
```

#/////CV fold 2 for lasso features/////
```{r}
trainData_tme2 = subtype_tme[trainRowNumbers_tme$Resample02,]
testData_tme2 = subtype_tme[-trainRowNumbers_tme$Resample02,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme2[, 3:9286])
y= trainData_tme2$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme2[, 3:9286])
y.test = testData_tme2$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model2 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso2 = confusionMatrix(table.lasso.tme)
full.tme.lasso2
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull2 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull2
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme2 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme2 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model2 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme2 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme2
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso2 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso2
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model2 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme2 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme2
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso2 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso2
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model2 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme2 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme2
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme2 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme2
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model2 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme2 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme2
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso2 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso2
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model2 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme2 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme2
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso2 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso2
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model2 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme2 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme2
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso2 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso2
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model2 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme2 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme2
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso2 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso2
```

#/////CV fold 3 for lasso features/////
```{r}
trainData_tme3 = subtype_tme[trainRowNumbers_tme$Resample03,]
testData_tme3 = subtype_tme[-trainRowNumbers_tme$Resample03,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme3[, 3:9286])
y= trainData_tme3$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme3[, 3:9286])
y.test = testData_tme3$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model3 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso3 = confusionMatrix(table.lasso.tme)
full.tme.lasso3
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull3 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull3
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme3 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme3 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model3 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme3 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme3
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso3 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso3
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model3 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme3 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme3
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso3 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso3
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model3 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme3 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme3
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme3 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme3
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model3 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme3 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme3
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso3 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso3
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model3 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme3 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme3
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso3 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso3
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model3 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme3 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme3
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso3 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso3
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model3 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme3 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme3
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso3 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso3
```

#/////CV fold 4 for lasso features/////
```{r}
trainData_tme4 = subtype_tme[trainRowNumbers_tme$Resample04,]
testData_tme4 = subtype_tme[-trainRowNumbers_tme$Resample04,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme4[, 3:9286])
y= trainData_tme4$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme4[, 3:9286])
y.test = testData_tme4$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model4 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso4 = confusionMatrix(table.lasso.tme)
full.tme.lasso4
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull4 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull4
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme4 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme4 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model4 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme4 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme4
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso4= multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso4
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model4 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme4 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme4
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso4 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso4
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model4 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme4 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme4
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme4 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme4
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model4 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme4 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme4
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso4 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso4
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model4 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme4 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme4
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso4 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso4
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model4 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme4 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme4
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso4 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso4
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model4 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme4 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme4
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso4 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso4
```

#/////CV fold 5 for lasso features/////
```{r}
trainData_tme5 = subtype_tme[trainRowNumbers_tme$Resample05,]
testData_tme5 = subtype_tme[-trainRowNumbers_tme$Resample05,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme5[, 3:9286])
y= trainData_tme5$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme5[, 3:9286])
y.test = testData_tme5$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model5 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso5 = confusionMatrix(table.lasso.tme)
full.tme.lasso5
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull5 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull5
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme5 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme5 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model5 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme5 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme5
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso5 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso5
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model5 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme5 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme5
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso5 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso5
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model5 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme5 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme5
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme5 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme5
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model5 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme5 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme5
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso5 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso5
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model5 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme5 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme5
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso5 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso5
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model5 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme5 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme5
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso5 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso5
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model5 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme5 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme5
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso5 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso5
```

#/////CV fold 6 for lasso features/////
```{r}
trainData_tme6= subtype_tme[trainRowNumbers_tme$Resample06,]
testData_tme6 = subtype_tme[-trainRowNumbers_tme$Resample06,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme6[, 3:9286])
y= trainData_tme6$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme6[, 3:9286])
y.test = testData_tme6$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model6 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso6 = confusionMatrix(table.lasso.tme)
full.tme.lasso6
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull6 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull6
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme6 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme6 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model6 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme6 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme6
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso6 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso6
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model6 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme6 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme6
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso6 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso6
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model6 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme6 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme6
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme6 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme6
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model6 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme6 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme6
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso6 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso6
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model6 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme6 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme6
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso6 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso6
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model6 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme6 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme6
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso6 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso6
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model6 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme6 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme6
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso6 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso6
```

#/////CV fold 7 for lasso features/////
```{r}
trainData_tme7 = subtype_tme[trainRowNumbers_tme$Resample07,]
testData_tme7 = subtype_tme[-trainRowNumbers_tme$Resample07,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme7[, 3:9286])
y= trainData_tme7$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme7[, 3:9286])
y.test = testData_tme7$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model7 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso7 = confusionMatrix(table.lasso.tme)
full.tme.lasso7
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull7 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull7
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme7 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme7 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model7 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme7 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme7
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso7 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso7
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model7 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme7 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme7
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso7 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso7
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model7 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme7 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme7
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme7 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme7
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model7 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme7 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme7
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso7 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso7
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model7 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme7 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme7
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso7 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso7
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model7 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme7 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme7
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso7 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso7
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model7 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme7 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme7
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso7 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso7
```

#/////CV fold 8 for lasso features/////
```{r}
trainData_tme8 = subtype_tme[trainRowNumbers_tme$Resample08,]
testData_tme8 = subtype_tme[-trainRowNumbers_tme$Resample08,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme8[, 3:9286])
y= trainData_tme8$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme8[, 3:9286])
y.test = testData_tme8$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model8 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso8 = confusionMatrix(table.lasso.tme)
full.tme.lasso8
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull8 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull8
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme8 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme8 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model8 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme8 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme8
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso8 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso8
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model8 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme8 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme8
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso8 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso8
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model8 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme8 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme8
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme8 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme8
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model8 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme8 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme8
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso8 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso8
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model8 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme8 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme8
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso8 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso8
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model8 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme8 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme8
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso8 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso8
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model8 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme8 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme8
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso8 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso8
```

#/////CV fold 9 for lasso features/////
```{r}
trainData_tme9 = subtype_tme[trainRowNumbers_tme$Resample09,]
testData_tme9 = subtype_tme[-trainRowNumbers_tme$Resample09,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme9[, 3:9286])
y= trainData_tme9$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme9[, 3:9286])
y.test = testData_tme9$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model9 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso9 = confusionMatrix(table.lasso.tme)
full.tme.lasso9
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull9 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull9
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme9 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme9 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model9 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme9 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme9
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso9 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso9
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model9 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme9 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme9
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso9 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso9
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model9 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme9 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme9
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme9 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme9
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model9 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme9 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme9
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso9 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso9
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model9 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme9 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme9
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso9 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso9
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model9 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme9 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme9
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso9 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso9
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model9 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme9 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme9
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso9 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso9
```

#/////CV fold 10 for lasso features/////
```{r}
trainData_tme10 = subtype_tme[trainRowNumbers_tme$Resample10,]
testData_tme10 = subtype_tme[-trainRowNumbers_tme$Resample10,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme10[, 3:9286])
y= trainData_tme10$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme10[, 3:9286])
y.test = testData_tme10$TMEscore_binary
y.test = as.factor(y.test)
```
# glmNET LASSO - Optimal performance on individual classification (Grouped data assessment not shown)
```{r}
set.seed(99)
lasso.10fold = cv.glmnet(x,y,family="multinomial", nfolds=10)
lasso.tme.model10 = lasso.10fold
predict.lasso.tme = predict(lasso.10fold,x.test, type="class")
u = union(predict.lasso.tme, y.test)
table.lasso.tme <- table(factor(predict.lasso.tme, u), factor(y.test, u))
full.tme.lasso10 = confusionMatrix(table.lasso.tme)
full.tme.lasso10
```
```{r}
#Brier Score for Lasso
brier.lasso.tme = predict(lasso.10fold, x.test, type="response")
brier.lasso.tme = (brier.lasso.tme)/rowSums(brier.lasso.tme)
brier.lasso.tmefull10 = multiclass.Brier(brier.lasso.tme,y.test)
brier.lasso.tmefull10
```
#Extract features
```{r}
coef.lasso.10fold = coef(lasso.10fold, s="lambda.min")
```
```{r}
featuresextracted.lasso = as.data.frame(x) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso = as.matrix(featuresextracted.lasso)

x.lassotme10 = x.lasso

featuresextracted.lasso.test = as.data.frame(x.test) %>% dplyr::select(coef.lasso.10fold[["High"]]@i,coef.lasso.10fold[["Low"]]@i)
x.lasso.test = as.matrix(featuresextracted.lasso.test)

x.lasso.testtme10 = x.lasso.test
```
#LASSO with LASSO features
```{r}
set.seed(99)
lasso.lasso.tme = caret::train(x.lasso,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.lasso.tme.model10 = lasso.lasso.tme
predict.lasso.lasso.tme = predict(lasso.lasso.tme,x.lasso.test)
table.lasso.lasso.tme = table(predict.lasso.lasso.tme,y.test)
lasso.lasso.tme10 = confusionMatrix(table.lasso.lasso.tme, mode = "everything")
lasso.lasso.tme10
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.lasso = predict(lasso.lasso.tme, x.lasso.test, type="prob")
brier.lasso.tme.lasso = (brier.lasso.tme.lasso)/rowSums(brier.lasso.tme.lasso)
brier.lasso.tme.lasso10 = multiclass.Brier(brier.lasso.tme.lasso,y.test)
brier.lasso.tme.lasso10
```
#NB with Lasso 
```{r}
set.seed(99)
nb.lasso.tme = caret::train(x.lasso,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.lasso.tme.model10 = nb.lasso
predict.nb.lasso.tme = predict(nb.lasso.tme$finalModel,x.lasso.test)
table.nb.lasso.tme = table(predict.nb.lasso.tme,y.test)
nb.lasso.tme10 = confusionMatrix(table.nb.lasso.tme)
nb.lasso.tme10
```
```{r}
#Brier Score
brier.nb.tme.lasso = predict(nb.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nb.tme.lasso = (brier.nb.tme.lasso)/rowSums(brier.nb.tme.lasso)
brier.nb.tme.lasso10 = multiclass.Brier(brier.nb.tme.lasso,y.test)
brier.nb.tme.lasso10
```
#RF with Lasso
```{r}
set.seed(99)
rf.lasso.tme = caret::train(x.lasso,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.lasso.tme.model10 = rf.lasso.tme
predict.rf.lasso.tme = predict(rf.lasso.tme,x.lasso.test)
table.rf.lasso.tme = table(predict.rf.lasso.tme,y.test)
rf.lasso.tme10 = confusionMatrix(table.rf.lasso.tme)
rf.lasso.tme10
```
```{r}
#Brier Score
brier.rf.ACRG.tme = predict(rf.lasso.tme,newdata = x.lasso.test, type="prob")
brier.rf.ACRG.tme = (brier.rf.ACRG.tme)/rowSums(brier.rf.ACRG.tme)
brier.rf.ACRG.tme10 = multiclass.Brier(brier.rf.ACRG.tme,y.test)
brier.rf.ACRG.tme10
```
#GBM with Lasso
```{r}
set.seed(99)
gbm.lasso.tme = caret::train(x.lasso,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.lasso.tme.model10 = gbm.lasso.tme
predict.gbm.lasso.tme = predict(gbm.lasso.tme,x.lasso.test)
table.gbm.lasso.tme = table(predict.gbm.lasso.tme,y.test)
gbm.lasso.tme10 = confusionMatrix(table.gbm.lasso.tme)
gbm.lasso.tme10
```
```{r}
#Brier Score
brier.gbm.tme.lasso = predict(gbm.lasso.tme,newdata = x.lasso.test, type="prob")
brier.gbm.tme.lasso = (brier.gbm.tme.lasso)/rowSums(brier.gbm.tme.lasso)
brier.gbm.tme.lasso10 = multiclass.Brier(brier.gbm.tme.lasso,y.test)
brier.gbm.tme.lasso10
```
#KNN with Lasso
```{r}
set.seed(99)
knn.lasso.tme = caret::train(x.lasso,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.lasso.tme.model10 = knn.lasso.tme
predict.knn.lasso.tme = predict(knn.lasso.tme,x.lasso.test)
table.knn.lasso.tme = table(predict.knn.lasso.tme,y.test)
knn.lasso.tme10 = confusionMatrix(table.knn.lasso.tme)
knn.lasso.tme10
```
```{r}
#Brier Score
brier.knn.tme.lasso = predict(knn.lasso.tme,newdata = x.lasso.test, type="prob")
brier.knn.tme.lasso = (brier.knn.tme.lasso)/rowSums(brier.knn.tme.lasso)
brier.knn.tme.lasso10 = multiclass.Brier(brier.knn.tme.lasso,y.test)
brier.knn.tme.lasso10
```
#SVM with Lasso
```{r}
set.seed(99)
svm.lasso.tme = caret::train(x.lasso,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.lasso.tme.model10 = svm.lasso.tme
predict.svm.lasso.tme = predict(svm.lasso.tme,x.lasso.test)
table.svm.lasso.tme = table(predict.svm.lasso.tme,y.test)
svm.lasso.tme10 = confusionMatrix(table.svm.lasso.tme)
svm.lasso.tme10
```
```{r}
#Brier Score
brier.svm.tme.lasso = predict(svm.lasso.tme,newdata = x.lasso.test, type = "prob")
brier.svm.tme.lasso = (brier.svm.tme.lasso)/rowSums(brier.svm.tme.lasso)
brier.svm.tme.lasso10 = multiclass.Brier(brier.svm.tme.lasso,y.test)
brier.svm.tme.lasso10
```
#NNET with Lasso
```{r}
set.seed(99)
nnet.lasso.tme = caret::train(x.lasso,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.lasso.tme.model10 = nnet.lasso.tme
predict.nnet.lasso.tme = predict(nnet.lasso.tme,x.lasso.test)
table.nnet.lasso.tme = table(predict.nnet.lasso.tme,y.test)
nnet.lasso.tme10 = confusionMatrix(table.nnet.lasso.tme)
nnet.lasso.tme10
```
```{r}
#Brier Score
brier.nnet.tme.lasso = predict(nnet.lasso.tme,newdata = x.lasso.test, type="prob")
brier.nnet.tme.lasso = (brier.nnet.tme.lasso)/rowSums(brier.nnet.tme.lasso)
brier.nnet.tme.lasso10 = multiclass.Brier(brier.nnet.tme.lasso,y.test)
brier.nnet.tme.lasso10
```

#END LASSO

#START GBM 

#/////GBM 1 CV fold for GBM features/////
```{r}
trainData_tme1 = subtype_tme[trainRowNumbers_tme$Resample01,]
testData_tme1 = subtype_tme[-trainRowNumbers_tme$Resample01,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme1[, 3:9286])
y= trainData_tme1$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme1[, 3:9286])
y.test = testData_tme1$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model1 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme1 = confusionMatrix(table.gbm.feature)
full.gbm.tme1
```
```{r}
#Brier Score
brier.gbm.tme = predict(full.gbm.tme.model1,newdata = data.matrix(testData_tme1[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme1 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme1$TMEscore_binary))
brier.gbm.tme1
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model1)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top501 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train1 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test1 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model1 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme1 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme1
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme1 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme1
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model1 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme1 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme1 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme1
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model1 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme1 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme1 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme1
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model1 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme1 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme1 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme1
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model1 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme1 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme1 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme1
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model1 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme1 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme1 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme1
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model1 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme1 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme1
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme1 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme1
```

#/////GBM 2 CV fold for GBM features/////
```{r}
trainData_tme2 = subtype_tme[trainRowNumbers_tme$Resample02,]
testData_tme2 = subtype_tme[-trainRowNumbers_tme$Resample02,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme2[, 3:9286])
y= trainData_tme2$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme2[, 3:9286])
y.test = testData_tme2$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model2 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme2 = confusionMatrix(table.gbm.feature)
full.gbm.tme2
```
```{r}
#Brier Score
brier.gbm.tme = predict(full.gbm.tme.model2,newdata = data.matrix(testData_tme2[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme2 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme2$TMEscore_binary))
brier.gbm.tme2
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model2)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top502 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train2 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test2 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model2 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme2 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme2
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme2 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme2
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model2 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme2 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme2 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme2
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model2 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme2 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme2 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme2
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model2 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme2 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme2 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme2
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model2 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme2 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme2 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme2
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model2 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme2 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme2 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme2
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model2 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme2 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme2
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme2 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme2
```

#/////GBM 3 CV fold for GBM features/////
```{r}
trainData_tme3 = subtype_tme[trainRowNumbers_tme$Resample03,]
testData_tme3 = subtype_tme[-trainRowNumbers_tme$Resample03,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme3[, 3:9286])
y= trainData_tme3$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme3[, 3:9286])
y.test = testData_tme3$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model3 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme3 = confusionMatrix(table.gbm.feature)
full.gbm.tme3
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model3,newdata = data.matrix(testData_tme3[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme3 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme3$TMEscore_binary))
brier.gbm.tme3
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model3)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top503 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train3 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test3 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model3 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme3 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme3
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme3 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme3
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model3 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme3 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme3 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme3
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model3 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme3 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme3 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme3
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model3 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme3 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme3 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme3
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model3 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme3 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme3 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme3
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model3 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme3 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme3 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme3
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model3 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme3 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme3
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme3 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme3
```

#/////GBM 4 CV fold for GBM features/////
```{r}
trainData_tme4 = subtype_tme[trainRowNumbers_tme$Resample04,]
testData_tme4 = subtype_tme[-trainRowNumbers_tme$Resample04,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme4[, 3:9286])
y= trainData_tme4$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme4[, 3:9286])
y.test = testData_tme4$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model4 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme4 = confusionMatrix(table.gbm.feature)
full.gbm.tme4
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model4,newdata = data.matrix(testData_tme4[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme4 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme4$TMEscore_binary))
brier.gbm.tme4
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model4)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top504 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train4 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test4 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model4 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme4 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme4
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme4 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme4
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model4 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme4 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme4 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme4
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model4 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme4 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme4 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme4
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model4 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme4 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme4= multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme4
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model4 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme4 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme4 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme4
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model4 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme4 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme4 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme4
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model4 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme4 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme4
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme4 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme4
```

#/////GBM 5 CV fold for GBM features/////
```{r}
trainData_tme5 = subtype_tme[trainRowNumbers_tme$Resample05,]
testData_tme5 = subtype_tme[-trainRowNumbers_tme$Resample05,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme5[, 3:9286])
y= trainData_tme5$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme5[, 3:9286])
y.test = testData_tme5$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model5 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme5 = confusionMatrix(table.gbm.feature)
full.gbm.tme5
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model5,newdata = data.matrix(testData_tme5[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme5 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme5$TMEscore_binary))
brier.gbm.tme5
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model5)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top505 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train5 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test5 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model5 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme5 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme5
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme5 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme5
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model5 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme5 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme5 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme5
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model5 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme5 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme5 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme5
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model5 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme5 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme5 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme5
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model5 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme5 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme5 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme5
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model5 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme5 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme5 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme5
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model5 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme5 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme5
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme5 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme5
```

#/////GBM 6 CV fold for GBM features/////
```{r}
trainData_tme6 = subtype_tme[trainRowNumbers_tme$Resample06,]
testData_tme6 = subtype_tme[-trainRowNumbers_tme$Resample06,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme6[, 3:9286])
y= trainData_tme6$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme6[, 3:9286])
y.test = testData_tme6$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model6 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme6 = confusionMatrix(table.gbm.feature)
full.gbm.tme6
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model6,newdata = data.matrix(testData_tme6[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme6 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme6$TMEscore_binary))
brier.gbm.tme6
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model6)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top506 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train6 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test6 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model6 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme6 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme6
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme6 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme6
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model6 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme6 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme6 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme6
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model6 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme6 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme6 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme6
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model6 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme6 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme6 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme6
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model6 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme6 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme6 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme6
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model6 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme6 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme6 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme6
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model6 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme6 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme6
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme6 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme6
```

#/////GBM 7 CV fold for GBM features/////
```{r}
trainData_tme7= subtype_tme[trainRowNumbers_tme$Resample07,]
testData_tme7 = subtype_tme[-trainRowNumbers_tme$Resample07,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme7[, 3:9286])
y= trainData_tme7$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme7[, 3:9286])
y.test = testData_tme7$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model7 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme7 = confusionMatrix(table.gbm.feature)
full.gbm.tme7
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model7,newdata = data.matrix(testData_tme7[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme7 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme7$TMEscore_binary))
brier.gbm.tme7
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model7)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top507 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train7 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test7 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model7 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme7 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme7
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme7 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme7
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model7 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme7 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme7 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme7
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model7 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme7 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme7 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme7
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model7= gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme7 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme7 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme7
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model7 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme7= confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme7 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme7
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model7 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme7 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme7 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme7
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model7 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme7 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme7
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme7 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme7
```

#/////GBM 8 CV fold for GBM features/////
```{r}
trainData_tme8 = subtype_tme[trainRowNumbers_tme$Resample08,]
testData_tme8 = subtype_tme[-trainRowNumbers_tme$Resample08,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme8[, 3:9286])
y= trainData_tme8$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme8[, 3:9286])
y.test = testData_tme8$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model8 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme8 = confusionMatrix(table.gbm.feature)
full.gbm.tme8
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model8,newdata = data.matrix(testData_tme8[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme8 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme8$TMEscore_binary))
brier.gbm.tme8
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model8)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top508 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train8 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test8 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model8 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme8 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme8
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme8 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme8
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model8 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme8 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme8 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme8
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model8 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme8 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme8 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme8
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model8 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme8 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme8 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme8
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model8 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme8 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme8 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme8
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model8 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme8 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme8 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme8
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model8 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme8 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme8
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme8 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme8
```

#/////GBM 9 CV fold for GBM features/////
```{r}
trainData_tme9 = subtype_tme[trainRowNumbers_tme$Resample09,]
testData_tme9 = subtype_tme[-trainRowNumbers_tme$Resample09,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme9[, 3:9286])
y= trainData_tme9$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme9[, 3:9286])
y.test = testData_tme9$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model9 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme9 = confusionMatrix(table.gbm.feature)
full.gbm.tme9
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model9,newdata = data.matrix(testData_tme9[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme9 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme9$TMEscore_binary))
brier.gbm.tme9
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model9)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top509 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train9 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test9 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model9 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme9 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme9
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme9 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme9
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model9 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme9 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme9 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme9
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model9 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme9 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme9 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme9
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model9 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme9= confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme9 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme9
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model9 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme9 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme9 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme9
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model9 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme9 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme9 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme9
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model9 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme9 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme9
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme9 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme9
```

#/////GBM 10 CV fold for GBM features/////
```{r}
trainData_tme10 = subtype_tme[trainRowNumbers_tme$Resample10,]
testData_tme10 = subtype_tme[-trainRowNumbers_tme$Resample10,]
#Make our test and train data
```
```{r}
x= data.matrix(trainData_tme10[, 3:9286])
y= trainData_tme10$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme10[, 3:9286])
y.test = testData_tme10$TMEscore_binary
y.test = as.factor(y.test)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
full.gbm.tme.model10 = gbm.feature
predict.gbm.feature = predict(gbm.feature, newdata = x.test)
table.gbm.feature = table(predict.gbm.feature, y.test)
full.gbm.tme10 = confusionMatrix(table.gbm.feature)
full.gbm.tme10
```
```{r}
brier.gbm.tme = predict(full.gbm.tme.model10,newdata = data.matrix(testData_tme10[, 3:9286]), type = "prob")
brier.gbm.tme = (brier.gbm.tme)/rowSums(brier.gbm.tme)
brier.gbm.tme10 = multiclass.Brier(brier.gbm.tme,as.factor(testData_tme10$TMEscore_binary))
brier.gbm.tme10
```
# Variable importance according to random forest with all features
```{r}
gbm_features_tme = varImp(full.gbm.tme.model10)
gbm.tme.top50 = gbm_features_tme$importance %>% filter(rank(desc(gbm_features_tme$importance))<=50)
gbm.tme.top5010 = gbm.tme.top50
```
```{r}
plot(gbm_features_tme, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.top50)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train10 = gbm.tme.train

gbm.tme.test = as.data.frame(x.test) %>% dplyr::select(all_of(rntop50))
gbm.tme.test10 = gbm.tme.test
```
#LASSO with GBM
```{r}
set.seed(99)
lasso.gbm.tme = caret::train(gbm.tme.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.gbm.tme.model10 = lasso.gbm.tme
predict.lasso.gbm.tme = predict(lasso.gbm.tme,gbm.tme.test)
table.lasso.gbm.tme = table(predict.lasso.gbm.tme,y.test)
lasso.gbm.tme10 = confusionMatrix(table.lasso.gbm.tme, mode = "everything")
lasso.gbm.tme10
```
```{r}
#Brier Score for Lasso
brier.lasso.gbm.tme = predict(lasso.gbm.tme, gbm.tme.test, type="prob")
brier.lasso.gbm.tme = (brier.lasso.gbm.tme)/rowSums(brier.lasso.gbm.tme)
brier.lasso.gbm.tme10 = multiclass.Brier(brier.lasso.gbm.tme,y.test)
brier.lasso.gbm.tme10
```
#Naive Bayes with GBM features
```{r,warning=FALSE}
set.seed(99)
nb.gbm.tme = caret::train(gbm.tme.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.gbm.tme.model10 = nb.gbm.tme
predict.nb.gbm.tme = predict(nb.gbm.tme,gbm.tme.test)
table.nb.gbm.tme = table(predict.nb.gbm.tme,y.test)
nb.gbm.tme10 = confusionMatrix(table.nb.gbm.tme)
nb.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.nb.gbm.tme = predict(nb.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nb.gbm.tme = (brier.nb.gbm.tme)/rowSums(brier.nb.gbm.tme)
brier.nb.gbm.tme10 = multiclass.Brier(brier.nb.gbm.tme,y.test)
brier.nb.gbm.tme10
```

#RF with GBM features
```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.gbm.tme.model10 = rf.gbm.tme
predict.rf.gbm.tme = predict(rf.gbm.tme,gbm.tme.test)
table.rf.gbm.tme = table(predict.rf.gbm.tme,y.test)
rf.gbm.tme10 = confusionMatrix(table.rf.gbm.tme)
rf.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.rf.gbm.tme = predict(rf.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.rf.gbm.tme = (brier.rf.gbm.tme)/rowSums(brier.rf.gbm.tme)
brier.rf.gbm.tme10 = multiclass.Brier(brier.rf.gbm.tme,y.test)
brier.rf.gbm.tme10
```

#GBM with GBM features
```{r}
set.seed(99)
gbm.gbm.tme = caret::train(gbm.tme.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.gbm.tme.model10 = gbm.gbm.tme
predict.gbm.gbm.tme = predict(gbm.gbm.tme,gbm.tme.test)
table.gbm.gbm.tme = table(predict.gbm.gbm.tme,y.test)
gbm.gbm.tme10 = confusionMatrix(table.gbm.gbm.tme)
gbm.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.gbm.gbm.tme = predict(gbm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.gbm.gbm.tme = (brier.gbm.gbm.tme)/rowSums(brier.gbm.gbm.tme)
brier.gbm.gbm.tme10 = multiclass.Brier(brier.gbm.gbm.tme,y.test)
brier.gbm.gbm.tme10
```

#KNN with GBM features
```{r}
set.seed(99)
knn.gbm.tme = caret::train(gbm.tme.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.gbm.tme.model10 = knn.gbm.tme
predict.knn.gbm.tme = predict(knn.gbm.tme,gbm.tme.test)
table.knn.gbm.tme = table(predict.knn.gbm.tme,y.test)
knn.gbm.tme10 = confusionMatrix(table.knn.gbm.tme)
knn.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.knn.gbm.tme = predict(knn.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.knn.gbm.tme = (brier.knn.gbm.tme)/rowSums(brier.knn.gbm.tme)
brier.knn.gbm.tme10 = multiclass.Brier(brier.knn.gbm.tme,y.test)
brier.knn.gbm.tme10
```
#SVM with GBM features
```{r}
set.seed(99)
svm.gbm.tme = caret::train(gbm.tme.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.gbm.tme.model10 = svm.gbm.tme
predict.svm.gbm.tme = predict(svm.gbm.tme,gbm.tme.test)
table.svm.gbm.tme = table(predict.svm.gbm.tme,y.test)
svm.gbm.tme10 = confusionMatrix(table.svm.gbm.tme)
svm.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.svm.gbm.tme = predict(svm.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.svm.gbm.tme = (brier.svm.gbm.tme)/rowSums(brier.svm.gbm.tme)
brier.svm.gbm.tme10 = multiclass.Brier(brier.svm.gbm.tme,y.test)
brier.svm.gbm.tme10
```
#Neural Net
```{r}
set.seed(99)
nnet.gbm.tme = caret::train(gbm.tme.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.gbm.tme.model10 = nnet.gbm.tme
predict.nnet.gbm.tme = predict(nnet.gbm.tme,gbm.tme.test)
table.nnet.gbm.tme = table(predict.nnet.gbm.tme,y.test)
nnet.gbm.tme10 = confusionMatrix(table.nnet.gbm.tme)
nnet.gbm.tme10
```
```{r,warning=FALSE}
#Brier Score
brier.nnet.gbm.tme = predict(nnet.gbm.tme,newdata = gbm.tme.test, type="prob")
brier.nnet.gbm.tme = (brier.nnet.gbm.tme)/rowSums(brier.nnet.gbm.tme)
brier.nnet.gbm.tme10 = multiclass.Brier(brier.nnet.gbm.tme,y.test)
brier.nnet.gbm.tme10
```
#END GBM
#START SVM 


```{r}
subtype_tme = as.data.frame(tme)
#Create 80/20% data split at random

#Convert numeric columns to numeric
subtype_tme[,3:ncol(subtype_tme)] = lapply(3:ncol(subtype_tme),function(x) as.numeric(subtype_tme[[x]]))
```
```{r}
set.seed(99)
trainRowNumbers_tme = createDataPartition(subtype_tme$TMEscore_binary, p=0.8,list=FALSE,times = 10)
trainRowNumbers_tme = as.data.frame(trainRowNumbers_tme)
```

#/////SVM 1 CV fold for GBM features/////
```{r}
trainData_tme1 = subtype_tme[trainRowNumbers_tme$Resample01,]
testData_tme1 = subtype_tme[-trainRowNumbers_tme$Resample01,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme1[, 3:9286])
y= trainData_tme1$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme1[, 3:9286])
y.test = testData_tme1$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model1 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme1 = confusionMatrix(table.svm.tme)
full.svm.tme1
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme1 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme1
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme1 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme1 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model1 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme1 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme1
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm1 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm1
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model1 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme1 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme1
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm1 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm1
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model1 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme1 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme1
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm1 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm1
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model1 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme1 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme1
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm1 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm1
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model1 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme1 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme1
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm1 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm1
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model1 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme1 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme1
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm1 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm1
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model1 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme1 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme1
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm1 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm1
```



#/////SVM 2 CV fold for GBM features/////
```{r}
trainData_tme2 = subtype_tme[trainRowNumbers_tme$Resample02,]
testData_tme2 = subtype_tme[-trainRowNumbers_tme$Resample02,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme2[, 3:9286])
y= trainData_tme2$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme2[, 3:9286])
y.test = testData_tme2$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model2 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme2 = confusionMatrix(table.svm.tme)
full.svm.tme2
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme2 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme2
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme1 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme1 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model2 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme2 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme2
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm2 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm2
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model2 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme2 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme2
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm2 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm2
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model2 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme2 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme2
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm2 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm2
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model2 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme2 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme2
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm2 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm2
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model2 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme2 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme2
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm2 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm2
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model2 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme2 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme2
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm2 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm2
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model2 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme2 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme2
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm2 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm2
```


#/////SVM 3 CV fold for GBM features/////
```{r}
trainData_tme3 = subtype_tme[trainRowNumbers_tme$Resample03,]
testData_tme3 = subtype_tme[-trainRowNumbers_tme$Resample03,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme3[, 3:9286])
y= trainData_tme3$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme3[, 3:9286])
y.test = testData_tme3$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model3 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme3 = confusionMatrix(table.svm.tme)
full.svm.tme3
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme3 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme3
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme3 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme3 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model3 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme3 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme3
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm3 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm3
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model3 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme3 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme3
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm3 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm3
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model3 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme3 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme3
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm3 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm3
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model3 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme3 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme3
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm3 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm3
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model3 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme3 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme3
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm3 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm3
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model3 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme3 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme3
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm3 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm3
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model3 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme3 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme3
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm3 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm3
```


#/////SVM 4 CV fold for GBM features/////
```{r}
trainData_tme4 = subtype_tme[trainRowNumbers_tme$Resample04,]
testData_tme4 = subtype_tme[-trainRowNumbers_tme$Resample04,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme4[, 3:9286])
y= trainData_tme4$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme4[, 3:9286])
y.test = testData_tme4$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model4 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme4 = confusionMatrix(table.svm.tme)
full.svm.tme4
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme4 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme4
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme4 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme4 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model4 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme4 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme4
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm4 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm4
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model4 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme4 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme4
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm4 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm4
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model4 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme4 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme4
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm4 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm4
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model4 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme4 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme4
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm4 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm4
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model4 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme4 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme4
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm4 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm4
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model4 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme4 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme4
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm4 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm4
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model4 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme4 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme4
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm4 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm4
```


#/////SVM 5 CV fold for GBM features/////
```{r}
trainData_tme5 = subtype_tme[trainRowNumbers_tme$Resample05,]
testData_tme5 = subtype_tme[-trainRowNumbers_tme$Resample05,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme5[, 3:9286])
y= trainData_tme5$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme5[, 3:9286])
y.test = testData_tme5$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model5 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme5 = confusionMatrix(table.svm.tme)
full.svm.tme5
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme5 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme5
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme5 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme5 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model5 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme5 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme5
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm5 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm5
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model5 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme5 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme5
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm5 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm5
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model5 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme5 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme5
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm5 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm5
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model5 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme5= confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme5
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm5 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm5
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model5 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme5 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme5
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm5 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm5
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model5 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme5 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme5
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm5 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm5
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model5 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme5 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme5
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm5 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm5
```


#/////SVM 6 CV fold for GBM features/////
```{r}
trainData_tme6 = subtype_tme[trainRowNumbers_tme$Resample06,]
testData_tme6 = subtype_tme[-trainRowNumbers_tme$Resample06,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme6[, 3:9286])
y= trainData_tme6$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme6[, 3:9286])
y.test = testData_tme6$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model6 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme6 = confusionMatrix(table.svm.tme)
full.svm.tme6
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme6 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme6
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme6 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme6 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model6 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme6 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme6
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm6 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm6
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model6 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme6 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme6
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm6 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm6
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model6 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme6 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme6
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm6 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm6
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model6 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme6 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme6
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm6 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm6
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model6 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme6= confusionMatrix(table.knn.svm.tme)
knn.svm.tme6
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm6 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm6
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model6 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme6 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme6
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm6 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm6
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model6 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme6 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme6
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm6 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm6
```


#/////SVM 7 CV fold for GBM features/////
```{r}
trainData_tme7 = subtype_tme[trainRowNumbers_tme$Resample07,]
testData_tme7 = subtype_tme[-trainRowNumbers_tme$Resample07,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme7[, 3:9286])
y= trainData_tme7$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme7[, 3:9286])
y.test = testData_tme7$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model7 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme7 = confusionMatrix(table.svm.tme)
full.svm.tme7
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme7 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme7
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme7 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme7 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model7 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme7 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme7
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm7 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm7
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model7 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme7 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme7
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm7 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm7
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model7 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme7 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme7
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm7 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm7
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model7 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme7 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme7
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm7 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm7
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model7 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme7 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme7
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm7 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm7
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model7 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme7 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme7
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm7 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm7
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model7 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme7 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme7
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm7 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm7
```


#/////SVM 8 CV fold for GBM features/////
```{r}
trainData_tme8 = subtype_tme[trainRowNumbers_tme$Resample08,]
testData_tme8 = subtype_tme[-trainRowNumbers_tme$Resample08,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme8[, 3:9286])
y= trainData_tme8$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme8[, 3:9286])
y.test = testData_tme8$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model8 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme8 = confusionMatrix(table.svm.tme)
full.svm.tme8
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme8 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme8
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme8 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme8 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model8 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme8 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme8
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm8 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm8
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model8 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme8 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme8
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm8 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm8
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model8 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme8 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme8
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm8 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm8
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model8 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme8 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme8
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm8 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm8
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model8 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme8 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme8
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm8 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm8
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model8 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme8 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme8
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm8 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm8
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model8 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme8 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme8
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm8 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm8
```


#/////SVM 9 CV fold for GBM features/////
```{r}
trainData_tme9 = subtype_tme[trainRowNumbers_tme$Resample09,]
testData_tme9 = subtype_tme[-trainRowNumbers_tme$Resample09,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme9[, 3:9286])
y= trainData_tme9$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme9[, 3:9286])
y.test = testData_tme9$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model9 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme9 = confusionMatrix(table.svm.tme)
full.svm.tme9
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme9 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme9
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme9 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme9 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model9 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme9 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme9
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm9 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm9
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model9 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme9 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme9
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm9 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm9
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model9 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme9 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme9
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm9 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm9
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model9 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme9 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme9
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm9 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm9
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model9 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme9 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme9
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm9 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm9
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model9 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme9 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme9
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm9 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm9
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model9 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme9 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme9
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm9 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm9
```

#/////SVM 10 CV fold for GBM features/////
```{r}
trainData_tme10 = subtype_tme[trainRowNumbers_tme$Resample10,]
testData_tme10 = subtype_tme[-trainRowNumbers_tme$Resample10,]
```
```{r}
#Make our test and train data
x= data.matrix(trainData_tme10[, 3:9286])
y= trainData_tme10$TMEscore_binary
y = as.factor(y)
x.test= data.matrix(testData_tme10[, 3:9286])
y.test = testData_tme10$TMEscore_binary
y.test = as.factor(y.test)
```
#SVM for feature selection
```{r}
set.seed(99)
svm.tme = caret::train(x,y,'svmLinear2',trControl=trainControl(method='cv',number=10,classProbs = TRUE))
svm.tme.model10 = svm.tme
predict.svm.tme = predict(svm.tme,x.test)
table.svm.tme = table(predict.svm.tme,y.test)
full.svm.tme10 = confusionMatrix(table.svm.tme)
full.svm.tme10
```
```{r}
#Brier Score
brier.svm.tme = predict(svm.tme,newdata = x.test, type = "prob")
brier.svm.tme = (brier.svm.tme)/rowSums(brier.svm.tme)
brier.svm.tme10 = multiclass.Brier(brier.svm.tme,y.test)
brier.svm.tme10
```
#Top features 
```{r}
svm.features = varImp(svm.tme)
svm.features = svm.features$importance
High.svm = dplyr::select(svm.features, "High")
High.svm = High.svm %>% filter(rank(desc(High.svm))<=15)
Low.svm = dplyr::select(svm.features, "Low")
Low.svm = Low.svm %>% filter(rank(desc(Low.svm))<=15)
High.svm = row.names(High.svm)
Low.svm = row.names(Low.svm)
```
```{r}
#Combine top features and remove duplicated
svm.topfeatures = append(High.svm,Low.svm)
svm.topfeatures=as.data.frame(svm.topfeatures)
svm.topfeatures = svm.topfeatures[!duplicated(svm.topfeatures),]
svm.train =as.data.frame(x) %>% dplyr::select(all_of((svm.topfeatures)))
svm.train.tme10 = svm.train
svm.test = as.data.frame(x.test) %>% dplyr::select(all_of(svm.topfeatures))
svm.test.tme10 = svm.test
```
#LASSO with SVM
```{r}
set.seed(99)
lasso.svm.tme = caret::train(svm.train,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
lasso.svm.tme.model10 = lasso.svm.tme
predict.lasso.svm.tme = predict(lasso.svm.tme,svm.test)
table.lasso.svm.tme = table(predict.lasso.svm.tme,y.test)
lasso.svm.tme10 = confusionMatrix(table.lasso.svm.tme, mode = "everything")
lasso.svm.tme10
```
```{r}
#Brier Score for Lasso
brier.lasso.tme.svm = predict(lasso.svm.tme, svm.test, type="prob")
brier.lasso.tme.svm = (brier.lasso.tme.svm)/rowSums(brier.lasso.tme.svm)
brier.lasso.tme.svm10 = multiclass.Brier(brier.lasso.tme.svm,y.test)
brier.lasso.tme.svm10
```
#NB with SVM
```{r}
set.seed(99)
nb.svm.tme = caret::train(svm.train,y,'naive_bayes',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
nb.svm.tme.model10 = nb.svm.tme
predict.nb.svm.tme = predict(nb.svm.tme$finalModel,svm.test)
table.nb.svm.tme = table(predict.nb.svm.tme,y.test)
nb.svm.tme10 = confusionMatrix(table.nb.svm.tme)
nb.svm.tme10
```
```{r}
#Brier Score
brier.nb.tme.svm = predict(nb.svm.tme,newdata = svm.test, type="prob")
brier.nb.tme.svm = (brier.nb.tme.svm)/rowSums(brier.nb.tme.svm)
brier.nb.tme.svm10 = multiclass.Brier(brier.nb.tme.svm,y.test)
brier.nb.tme.svm10
```
#RF with SVM
```{r}
set.seed(99)
rf.svm.tme = caret::train(svm.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
rf.svm.tme.model10 = rf.svm.tme
predict.rf.svm.tme= predict(rf.svm.tme,svm.test)
table.rf.svm.tme = table(predict.rf.svm.tme,y.test)
rf.svm.tme10 = confusionMatrix(table.rf.svm.tme)
rf.svm.tme10
```
```{r}
#Brier Score
brier.rf.tme.svm = predict(rf.svm.tme,newdata = svm.test, type="prob")
brier.rf.tme.svm = (brier.rf.tme.svm)/rowSums(brier.rf.tme.svm)
brier.rf.tme.svm10 = multiclass.Brier(brier.rf.tme.svm,y.test)
brier.rf.tme.svm10
```
#GBM with SVM
```{r}
set.seed(99)
gbm.svm.tme = caret::train(svm.train,y,'gbm',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
gbm.svm.tme.model10 = gbm.svm.tme
predict.gbm.svm.tme = predict(gbm.svm.tme,svm.test)
table.gbm.svm.tme = table(predict.gbm.svm.tme,y.test)
gbm.svm.tme10 = confusionMatrix(table.gbm.svm.tme)
gbm.svm.tme10
```
```{r}
#Brier Score
brier.gbm.tme.svm = predict(gbm.svm.tme,newdata = svm.test, type="prob")
brier.gbm.tme.svm = (brier.gbm.tme.svm)/rowSums(brier.gbm.tme.svm)
brier.gbm.tme.svm10 = multiclass.Brier(brier.gbm.tme.svm,y.test)
brier.gbm.tme.svm10
```
#KNN with SVM
```{r}
set.seed(99)
knn.svm.tme = caret::train(svm.train,y,'knn',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(k=c(3,6,9,12,15)))
knn.svm.tme.model10 = knn.svm.tme
predict.knn.svm.tme = predict(knn.svm.tme,svm.test)
table.knn.svm.tme = table(predict.knn.svm.tme,y.test)
knn.svm.tme10 = confusionMatrix(table.knn.svm.tme)
knn.svm.tme10
```
```{r}
#Brier Score
brier.knn.tme.svm = predict(knn.svm.tme,newdata = svm.test, type = "prob")
brier.knn.tme.svm = (brier.knn.tme.svm)/rowSums(brier.knn.tme.svm)
brier.knn.tme.svm10 = multiclass.Brier(brier.knn.tme.svm,y.test)
brier.knn.tme.svm10
```
#SVM with SVM
```{r}
set.seed(99)
svm.svm.tme = caret::train(svm.train,y,'svmLinear2',trControl=trainControl(method='repeatedcv',number=5, repeats = 3,classProbs = TRUE))
svm.svm.tme.model10 = svm.svm.tme
predict.svm.svm.tme = predict(svm.svm.tme,svm.test)
table.svm.svm.tme = table(predict.svm.svm.tme,y.test)
svm.svm.tme10 = confusionMatrix(table.svm.svm.tme)
svm.svm.tme10
```
```{r}
#Brier Score
brier.svm.tme.svm = predict(svm.svm.tme,newdata = svm.test, type = "prob")
brier.svm.tme.svm = (brier.svm.tme.svm)/rowSums(brier.svm.tme.svm)
brier.svm.tme.svm10 = multiclass.Brier(brier.svm.tme.svm,y.test)
brier.svm.tme.svm10
```
#NNET with SVM
```{r}
set.seed(99)
nnet.svm.tme = caret::train(svm.train,y,'nnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3),tuneGrid = expand.grid(decay = c(1,0.5,0,1e-1,1e-4),size = c(1, 3, 5, 7)))
nnet.svm.tme.model10 = nnet.svm.tme
predict.nnet.svm.tme = predict(nnet.svm.tme,svm.test)
table.nnet.svm.tme = table(predict.nnet.svm.tme,y.test)
nnet.svm.tme10 = confusionMatrix(table.nnet.svm.tme)
nnet.svm.tme10
```
```{r}
#Brier Score
brier.nnet.tme.svm = predict(nnet.svm.tme,newdata = svm.test, type="prob")
brier.nnet.tme.svm = (brier.nnet.tme.svm)/rowSums(brier.nnet.tme.svm)
brier.nnet.tme.svm10 = multiclass.Brier(brier.nnet.tme.svm,y.test)
brier.nnet.tme.svm10
```


#END SVM

#Final Model GBM features

```{r}
x= data.matrix(subtype_tme[, 3:9286])
y= subtype_tme$TMEscore_binary
y = as.factor(y)
```
# GBM feature selection 
```{r}
set.seed(99)
gbm.feature.final = caret::train(x,y,'gbm',trControl=trainControl(method='cv',number=10, savePredictions = "final"))
```
# Variable importance according to random forest with all features
```{r}
gbm_features_final = varImp(gbm.feature.final)
gbm.tme.final = gbm_features_final$importance %>% filter(rank(desc(gbm_features_final$importance))<=50)
```
```{r}
plot(gbm_features_final, top=20)
```
#Data set with extracted top 50 features from gbm
```{r}
rntop50 = row.names(gbm.tme.final)

gbm.tme.train =as.data.frame(x) %>% dplyr::select(all_of((rntop50)))
gbm.tme.train.final = gbm.tme.train
TME_target_distribution=gbm.tme.train.final
```

```{r}
set.seed(99)
rf.gbm.tme = caret::train(gbm.tme.train,y,'rf',trControl=trainControl(method='repeatedcv',number=5, repeats = 3))
tme.final = rf.gbm.tme
```

#Final calibration model - L2 regularized binomial logistic regression optimizing logloss. 
```{r}
final_probs = predict(tme.final,newdata = gbm.tme.train, type="prob")
final_probs[final_probs == 0] <- 2.225074e-308

set.seed(99)
tme.final_calibration = caret::train(final_probs,y,'glmnet',trControl=trainControl(method='repeatedcv',number=5, repeats = 3, classProbs=TRUE, summaryFunction=mnLogLoss), metric = "logLoss",tuneGrid = expand.grid(alpha= 0 , lambda =c(1e-9,1e-8,1e-7,1e-6,1e-5,1e-4,1e-3,1e-2,1e-1, 0, 1, 10, 100)))
tme.final_calibration
```


```{r}
library(xlsx)
write.xlsx(rntop50,file = "TME final features.xlsx", sheetName = "TME features")
```

#Compile Model Metrics
#Lasso compile
```{r}
#Full lasso
total_list <- lapply(mget(ls(pattern = 'full.tme.lasso\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models1 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models1) <- c("Accuracy", "Kappa")
tme_models1$Brier_score = mget(ls(pattern = 'brier.lasso.tmefull\\d+'))
tme_models1$Model <- 'Full Elastic Net'
tme_models1$FS <- 'Full'
remove(total_list)


#Lasso lasso
total_list <- lapply(mget(ls(pattern = 'lasso.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models2 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models2) <- c("Accuracy", "Kappa")
tme_models2$Brier_score = mget(ls(pattern = 'brier.lasso.tme.lasso\\d+'))
tme_models2$Model <- 'Elastic Net Elastic Net'
tme_models2$FS <- 'Elastic Net'
remove(total_list)

#NB lasso
total_list <- lapply(mget(ls(pattern = 'nb.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models3 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models3) <- c("Accuracy", "Kappa")
tme_models3$Brier_score = mget(ls(pattern = 'brier.nb.tme.lasso\\d+'))
tme_models3$Model <- 'NB Elastic Net'
tme_models3$FS <- 'Elastic Net'
remove(total_list)

#RF lasso
total_list <- lapply(mget(ls(pattern = 'rf.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models4 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models4) <- c("Accuracy", "Kappa")
tme_models4$Brier_score = mget(ls(pattern = 'brier.rf.ACRG.tme\\d+'))
tme_models4$Model <- 'RF Elastic Net'
tme_models4$FS <- 'Elastic Net'
remove(total_list)


#GBM lasso
total_list <- lapply(mget(ls(pattern = 'gbm.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models5 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models5) <- c("Accuracy", "Kappa")
tme_models5$Brier_score = mget(ls(pattern = 'brier.gbm.tme.lasso\\d+'))
tme_models5$Model <- 'GBM Elastic Net'
tme_models5$FS <- 'Elastic Net'
remove(total_list)

#KNN lasso
total_list <- lapply(mget(ls(pattern = 'knn.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models6 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models6) <- c("Accuracy", "Kappa")
tme_models6$Brier_score = mget(ls(pattern = 'brier.knn.tme.lasso\\d+'))
tme_models6$Model <- 'KNN Elastic Net'
tme_models6$FS <- 'Elastic Net'
remove(total_list)

#SVM lasso
total_list <- lapply(mget(ls(pattern = 'svm.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models7 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models7) <- c("Accuracy", "Kappa")
tme_models7$Brier_score = mget(ls(pattern = 'brier.svm.tme.lasso\\d+'))
tme_models7$Model <- 'SVM Elastic Net'
tme_models7$FS <- 'Elastic Net'
remove(total_list)

#NNET lasso
total_list <- lapply(mget(ls(pattern = 'nnet.lasso.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models8 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models8) <- c("Accuracy", "Kappa")
tme_models8$Brier_score = mget(ls(pattern = 'brier.nnet.tme.lasso\\d+'))
tme_models8$Model <- 'NNET Elastic Net'
tme_models8$FS <- 'Elastic Net'
remove(total_list)
```
#GBM compile
```{r}
#GBM feature selection
total_list <- lapply(mget(ls(pattern = 'full.gbm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models9 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models9) <- c("Accuracy", "Kappa")
tme_models9$Brier_score = mget(ls(pattern = 'brier.gbm.tme\\d+'))
tme_models9$Model <- 'Full GBM'
tme_models9$FS <- 'Full'
remove(total_list)

#Lasso GBM selection
total_list <- mget(ls(pattern = 'lasso.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models10 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models10) <- c("Accuracy", "Kappa")
tme_models10$Brier_score = mget(ls(pattern = 'brier.lasso.gbm.tme\\d+'))
tme_models10$Model <- 'Elastic Net GBM'
tme_models10$FS <- 'GBM'
tme_models10 = dplyr::select(tme_models10, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#NB GBM
total_list <- mget(ls(pattern = 'nb.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models11 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models11) <- c("Accuracy", "Kappa")
tme_models11$Brier_score = mget(ls(pattern = 'brier.nb.gbm.tme\\d+'))
tme_models11$Model <- 'NB GBM'
tme_models11$FS <- 'GBM'
tme_models11 = dplyr::select(tme_models11, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#RF GBM
total_list <- mget(ls(pattern = 'rf.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models12 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models12) <- c("Accuracy", "Kappa")
tme_models12$Brier_score = mget(ls(pattern = 'brier.rf.gbm.tme\\d+'))
tme_models12$Model <- 'RF GBM'
tme_models12$FS <- 'GBM'
tme_models12 = dplyr::select(tme_models12, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#GBM GBM
total_list <- mget(ls(pattern = 'gbm.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models13 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models13) <- c("Accuracy", "Kappa")
tme_models13$Brier_score = mget(ls(pattern = 'brier.gbm.gbm.tme\\d+'))
tme_models13$Model <- 'GBM GBM'
tme_models13$FS <- 'GBM'
tme_models13 = dplyr::select(tme_models13, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#KNN GBM
total_list <- mget(ls(pattern = 'knn.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models14 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models14) <- c("Accuracy", "Kappa")
tme_models14$Brier_score = mget(ls(pattern = 'brier.knn.gbm.tme\\d+'))
tme_models14$Model <- 'KNN GBM'
tme_models14$FS <- 'GBM'
tme_models14 = dplyr::select(tme_models14, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#SVM GBM
total_list <- mget(ls(pattern = 'svm.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models15 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models15) <- c("Accuracy", "Kappa")
tme_models15$Brier_score = mget(ls(pattern = 'brier.svm.gbm.tme\\d+'))
tme_models15$Model <- 'SVM GBM'
tme_models15$FS <- 'GBM'
tme_models15 = dplyr::select(tme_models15, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)

#NNET GBM
total_list <- mget(ls(pattern = 'nnet.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','overall')
total_list = total_list[-c(1:10)]
tme_models16 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models16) <- c("Accuracy", "Kappa")
tme_models16$Brier_score = mget(ls(pattern = 'brier.nnet.gbm.tme\\d+'))
tme_models16$Model <- 'NNET GBM'
tme_models16$FS <- 'GBM'
tme_models16 = dplyr::select(tme_models16, c("Accuracy", "Kappa", "Brier_score", "Model", "FS"))
remove(total_list)
```
#SVM compile
```{r}
#SVM feature selection
total_list <- lapply(mget(ls(pattern = 'full.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models17 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models17) <- c("Accuracy", "Kappa")
tme_models17$Brier_score = mget(ls(pattern = 'brier.svm.tme\\d+'))
tme_models17$Model <- 'Full SVM'
tme_models17$FS <- 'Full'
remove(total_list)


#Lasso SVM selection
total_list <- lapply(mget(ls(pattern = 'lasso.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models18 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models18) <- c("Accuracy", "Kappa")
tme_models18$Brier_score = mget(ls(pattern = 'brier.lasso.tme.svm\\d+'))
tme_models18$Model <- 'Elastic Net SVM'
tme_models18$FS <- 'SVM'
remove(total_list)


#NB SVM
total_list <- lapply(mget(ls(pattern = 'nb.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models19 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models19) <- c("Accuracy", "Kappa")
tme_models19$Brier_score = mget(ls(pattern = 'brier.nb.tme.svm\\d+'))
tme_models19$Model <- 'NB SVM'
tme_models19$FS <- 'SVM'
remove(total_list)

#RF SVM
total_list <- lapply(mget(ls(pattern = 'rf.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models20 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models20) <- c("Accuracy", "Kappa")
tme_models20$Brier_score = mget(ls(pattern = 'brier.rf.tme.svm\\d+'))
tme_models20$Model <- 'RF SVM'
tme_models20$FS <- 'SVM'
remove(total_list)


#GBM SVM
total_list <- lapply(mget(ls(pattern = 'gbm.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models21 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models21) <- c("Accuracy", "Kappa")
tme_models21$Brier_score = mget(ls(pattern = 'brier.gbm.tme.svm\\d+'))
tme_models21$Model <- 'GBM SVM'
tme_models21$FS <- 'SVM'
remove(total_list)

#KNN SVM
total_list <- lapply(mget(ls(pattern = 'knn.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models22 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models22) <- c("Accuracy", "Kappa")
tme_models22$Brier_score = mget(ls(pattern = 'brier.knn.tme.svm\\d+'))
tme_models22$Model <- 'KNN SVM'
tme_models22$FS <- 'SVM'
remove(total_list)

#SVM SVM
total_list <- lapply(mget(ls(pattern = 'svm.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models23 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models23) <- c("Accuracy", "Kappa")
tme_models23$Brier_score = mget(ls(pattern = 'brier.svm.tme.svm\\d+'))
tme_models23$Model <- 'SVM SVM'
tme_models23$FS <- 'SVM'
remove(total_list)

#NNET GBM
total_list <- lapply(mget(ls(pattern = 'nnet.svm.tme\\d+')), function(x) {
         data <- x$overall
         data[setdiff(names(data), c("AccuracyLower","AccuracyUpper", "AccuracyNull", "AccuracyPValue", "McnemarPValue" ))]
})
tme_models24 <- data.frame(matrix(unlist(total_list), nrow=length(total_list), byrow=TRUE))
colnames(tme_models24) <- c("Accuracy", "Kappa")
tme_models24$Brier_score = mget(ls(pattern = 'brier.nnet.tme.svm\\d+'))
tme_models24$Model <- 'NNET SVM'
tme_models24$FS <- 'SVM'
remove(total_list)

total_list <- mget(ls(pattern = 'tme_models\\d+'))
compile_tme_model_svm = do.call(rbind, total_list)
compile_tme_model_svm$Brier_score = unlist(compile_tme_model_svm$Brier_score)

write.csv(compile_tme_model_svm,file = "compile_tme_model_svm.csv")

```
```{r}
#Compile Elastic net/lasso and GBM
total_list <- mget(ls(pattern = 'tme_models\\d+'))
compile_tme_models = do.call(rbind, total_list)
compile_tme_models$Brier_score = unlist(compile_tme_models$Brier_score)

write.csv(compile_tme_models,file = "compile_tme_models.csv")
```
#Complile ACRG data

#Plots

```{r}
#compile tcga models
total_list <- mget(ls(pattern = 'tme_models\\d+'))
compile_tme_models = do.call(rbind, total_list)
compile_tme_models$Brier_score = unlist(compile_tme_models$Brier_score)

compile_tme_models_long = melt(compile_tme_models, id.vars=c("Model", "FS"))



ggplot(compile_tme_models_long, aes(x=Model, y=value, fill=variable)) + 
    geom_boxplot() +
  geom_jitter( size=2, alpha=0.1) +
  ylim(c(0,1)) + 
  facet_wrap(~variable)

ggplot(compile_tme_models, aes(x=reorder(Model, -Accuracy), y=Accuracy, fill=FS)) + 
    geom_boxplot() +
  geom_jitter( size=2, alpha=0.1) +
  ylim(c(0,1)) 


library(Rmisc)

patient_model_data_accuracy <- summarySE(compile_acrg_model, measurevar="Accuracy", groupvars="Model")
patient_model_data_kappa <- summarySE(compile_acrg_model, measurevar="Kappa", groupvars="Model")
patient_model_data_brier <- summarySE(compile_acrg_model, measurevar="Brier_score", groupvars="Model")

colnames(patient_model_data_accuracy)[which(names(patient_model_data_accuracy) == "Accuracy")] <- "Value"
colnames(patient_model_data_kappa)[which(names(patient_model_data_kappa) == "Kappa")] <- "Value"
colnames(patient_model_data_brier)[which(names(patient_model_data_brier) == "Brier_score")] <- "Value"

patient_model_data_accuracy$Metric = 'Accuracy' 
patient_model_data_kappa$Metric = 'Kappa' 
patient_model_data_brier$Metric = 'Brier Score'

patient_model_data<-grep("patient_model_data",names(.GlobalEnv),value=TRUE)
patient_model_data<-do.call("list",mget(patient_model_data))
tcga_model_metrics = do.call(rbind, patient_model_data)

ggplot(tcga_model_metrics, aes(x=reorder(Model,-Value), y=Value, fill=Metric)) + 
    geom_bar(position=position_dodge(), stat="identity", colour= "black") +
    geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd),
                  width=.2,                  
                  position=position_dodge(.9)) + 
  scale_fill_manual("Metric", values = c("Accuracy" = "skyblue3", "Kappa" = "seagreen3", "Brier Score" = "purple")) + 
  scale_y_continuous(limit = c(0, 1)) +
  ggtitle("Tumour Characteristics") + 
  ylab("Value") +
  theme_classic()  + 
  theme(axis.text.x = element_text(colour="black", size = 12,angle = 45, hjust=1)) +
  theme(axis.text.y = element_text(colour="black",size = 12)) + 
  theme(plot.title = element_text(colour="black", size=12,hjust = 0)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_text(colour="black", size=12)) +
  theme(legend.position = "none" ) +
  facet_wrap(~Metric)

  geom_bar(aes(y = median), stat = "unique", width= 0.3) +


fun.args = list(mult = 1)

ggplot(compile_tme_models_long, aes(x=Model, y=value)) +
  facet_grid(.~variable) +
  stat_summary(mapping=aes(fill=variable), fun=mean, geom='bar', alpha=0.5, color='black') +
  stat_summary(fun.data = mean_sdl,fun.args = list(mult = 1), geom='errorbar', color='black') +
  geom_jitter(aes(color=variable), 
              position=position_jitter(width=0.2), alpha=0.8) +
  theme(axis.text.x = element_text(angle=45))


ggplot(compile_tme_models, aes(x=Model, y=Accuracy)) +
  stat_summary(mapping=aes(fill=Model), fun=mean, geom='bar', alpha=0.5, color='black') +
  stat_summary(fun.data = mean_sdl,fun.args = list(mult = 1), geom='errorbar', color='black') +
  geom_jitter(aes(color=Model), 
              position=position_jitter(width=0.2), alpha=0.8) +
  theme(axis.text.x = element_text(angle=45))



ggplot(compile_tme_model_svm, aes(x=reorder(Model, -Accuracy), y=Accuracy)) +
        stat_summary(mapping=aes(fill=FS), fun=mean, geom='bar', alpha=0.5, color='black') +
        stat_summary(fun.data = mean_sdl,fun.args = list(mult = 1), geom='errorbar', color='black') +
        geom_jitter(aes(color=FS), position=position_jitter(width=0.2), alpha=0.8) +
      scale_fill_manual("FS", values = c("Elastic Net" = "#4DBBD5FF", "Full" = "#00A087FF", "GBM" = "#3C5488FF", "SVM" = "#F39B7FFF" )) + 
  scale_colour_manual("FS", values = c("Elastic Net" = "#4DBBD5FF", "Full" = "#00A087FF", "GBM" = "#3C5488FF", "SVM" = "#F39B7FFF" )) +
        theme(axis.text.x = element_text(angle=45)) +
  theme_classic() + geom_hline(yintercept = 0.8878378, linetype = 2, colour = "red")


```
#Export data dataframe
```{r}
write.csv(compile_acrg_model,file = "compile_acrg_model.csv")
write.csv(compile_acrg_model_long,file = "compile_acrg_model_long.csv")
```




#Compile per type Model Metrics
#Lasso compile
```{r}
#Full lasso
total_list <- lapply(mget(ls(pattern = 'full.tme.lasso\\d+')), function(x) {
         data <- x$byClass})
tme_class1 = melt(total_list)
metric_name = names(total_list$full.tme.lasso1)
tme_class1$Var2 = rep(metric_name,10)
tme_class1$Var1 = "TME"
tme_class1 = summarySE(tme_class1, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class1 = dplyr::select(tme_class1, -c("N","se", "ci"))
tme_class1 = reshape(tme_class1,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class1$Model = "Full Elastic Net"
remove(total_list)



#Lasso lasso
total_list <- lapply(mget(ls(pattern = 'lasso.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class2 = melt(total_list)
tme_class2$Var2 = rep(metric_name,10)
tme_class2$Var1 = "TME"
tme_class2 = summarySE(tme_class2, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class2 = dplyr::select(tme_class2, -c("N","se", "ci"))
tme_class2 = reshape(tme_class2,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class2$Model = "Elastic Net Elastic Net"
remove(total_list)

#NB lasso
total_list <- lapply(mget(ls(pattern = 'nb.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class3 = melt(total_list)
tme_class3$Var2 = rep(metric_name,10)
tme_class3$Var1 = "TME"
tme_class3 = summarySE(tme_class3, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class3 = dplyr::select(tme_class3, -c("N","se", "ci"))
tme_class3 = reshape(tme_class3,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class3$Model = "NB Elastic Net"
remove(total_list)


#RF lasso
total_list <- lapply(mget(ls(pattern = 'rf.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class4 = melt(total_list)
tme_class4$Var2 = rep(metric_name,10)
tme_class4$Var1 = "TME"
tme_class4 = summarySE(tme_class4, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class4 = dplyr::select(tme_class4, -c("N","se", "ci"))
tme_class4 = reshape(tme_class4,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class4$Model = "RF Elastic Net"
remove(total_list)

#GBM lasso
total_list <- lapply(mget(ls(pattern = 'gbm.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class5 = melt(total_list)
tme_class5$Var2 = rep(metric_name,10)
tme_class5$Var1 = "TME"
tme_class5 = summarySE(tme_class5, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class5 = dplyr::select(tme_class5, -c("N","se", "ci"))
tme_class5 = reshape(tme_class5,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class5$Model = "GBM Elastic Net"
remove(total_list)

#KNN lasso
total_list <- lapply(mget(ls(pattern = 'knn.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class6 = melt(total_list)
tme_class6$Var2 = rep(metric_name,10)
tme_class6$Var1 = "TME"
tme_class6 = summarySE(tme_class6, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class6 = dplyr::select(tme_class6, -c("N","se", "ci"))
tme_class6 = reshape(tme_class6,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class6$Model = "KNN Elastic Net"
remove(total_list)

#SVM lasso
total_list <- lapply(mget(ls(pattern = 'svm.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class7 = melt(total_list)
tme_class7$Var2 = rep(metric_name,10)
tme_class7$Var1 = "TME"
tme_class7 = summarySE(tme_class7, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class7 = dplyr::select(tme_class7, -c("N","se", "ci"))
tme_class7 = reshape(tme_class7,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class7$Model = "KNN Elastic Net"
remove(total_list)

#NNET lasso
total_list <- lapply(mget(ls(pattern = 'nnet.lasso.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class8 = melt(total_list)
tme_class8$Var2 = rep(metric_name,10)
tme_class8$Var1 = "TME"
tme_class8 = summarySE(tme_class8, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class8 = dplyr::select(tme_class8, -c("N","se", "ci"))
tme_class8 = reshape(tme_class8,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class8$Model = "NNET Elastic Net"
remove(total_list)
```

#GBM compile
```{r}
#GBM feature selection
total_list <- lapply(mget(ls(pattern = 'full.gbm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class9 = melt(total_list)
metric_name = names(total_list$full.gbm.tme1)
tme_class9$Var2 = rep(metric_name,10)
tme_class9$Var1 = "TME"
tme_class9 = summarySE(tme_class9, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class9 = dplyr::select(tme_class9, -c("N","se", "ci"))
tme_class9 = reshape(tme_class9,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class9$Model = "Full GBM"
remove(total_list)

#Lasso GBM selection
total_list <- mget(ls(pattern = 'lasso.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class10 = melt(total_list)
tme_class10$Var2 = rep(metric_name,10)
tme_class10$Var1 = "TME"
tme_class10 = summarySE(tme_class10, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class10 = dplyr::select(tme_class10, -c("N","se", "ci"))
tme_class10 = reshape(tme_class10,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class10$Model = "Elastic Net GBM"
remove(total_list)

#NB GBM
total_list <- mget(ls(pattern = 'nb.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class11 = melt(total_list)
tme_class11$Var2 = rep(metric_name,10)
tme_class11$Var1 = "TME"
tme_class11 = summarySE(tme_class11, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class11 = dplyr::select(tme_class11, -c("N","se", "ci"))
tme_class11 = reshape(tme_class11,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class11$Model = "NB GBM"
remove(total_list)

#RF GBM
total_list <- mget(ls(pattern = 'rf.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class12 = melt(total_list)
tme_class12$Var2 = rep(metric_name,10)
tme_class12$Var1 = "TME"
tme_class12 = summarySE(tme_class12, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class12 = dplyr::select(tme_class12, -c("N","se", "ci"))
tme_class12 = reshape(tme_class12,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class12$Model = "RF GBM"
remove(total_list)

#GBM GBM
total_list <- mget(ls(pattern = 'gbm.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class13 = melt(total_list)
tme_class13$Var2 = rep(metric_name,10)
tme_class13$Var1 = "TME"
tme_class13 = summarySE(tme_class13, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class13 = dplyr::select(tme_class13, -c("N","se", "ci"))
tme_class13 = reshape(tme_class13,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class13$Model = "GBM GBM"
remove(total_list)

#KNN GBM
total_list <- mget(ls(pattern = 'knn.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class14 = melt(total_list)
tme_class14$Var2 = rep(metric_name,10)
tme_class14$Var1 = "TME"
tme_class14 = summarySE(tme_class14, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class14 = dplyr::select(tme_class14, -c("N","se", "ci"))
tme_class14 = reshape(tme_class14,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class14$Model = "KNN GBM"
remove(total_list)

#SVM GBM
total_list <- mget(ls(pattern = 'svm.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class15 = melt(total_list)
tme_class15$Var2 = rep(metric_name,10)
tme_class15$Var1 = "TME"
tme_class15 = summarySE(tme_class15, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class15 = dplyr::select(tme_class15, -c("N","se", "ci"))
tme_class15 = reshape(tme_class15,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class15$Model = "SVM GBM"
remove(total_list)

#NNET GBM
total_list <- mget(ls(pattern = 'nnet.gbm.tme\\d+'))
total_list <- lapply(total_list, '[','byClass')
total_list = total_list[-c(1:10)]
tme_class16 = melt(total_list)
tme_class16$Var2 = rep(metric_name,10)
tme_class16$Var1 = "TME"
tme_class16 = summarySE(tme_class16, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class16 = dplyr::select(tme_class16, -c("N","se", "ci"))
tme_class16 = reshape(tme_class16,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class16$Model = "NNET GBM"
remove(total_list)

```
#SVM compile
```{r}
#SVM feature selection
total_list <- lapply(mget(ls(pattern = 'full.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class17 = melt(total_list)
metric_name = names(total_list$full.svm.tme1)
tme_class17$Var2 = rep(metric_name,10)
tme_class17$Var1 = "TME"
tme_class17 = summarySE(tme_class17, measurevar=c("value") , groupvars=c("Var1","Var2"))
tme_class17 = dplyr::select(tme_class17, -c("N","se", "ci"))
tme_class17 = reshape(tme_class17,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class17$Model = "Full SVM"
remove(total_list)

#Lasso SVM selection
total_list <- lapply(mget(ls(pattern = 'lasso.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class18 = melt(total_list)
tme_class18$Var2 = rep(metric_name,10)
tme_class18$Var1 = "TME"
tme_class18 = summarySE(tme_class18, measurevar=c("value") , groupvars=c("Var1","Var2"))
tme_class18 = dplyr::select(tme_class18, -c("N","se", "ci"))
tme_class18 = reshape(tme_class18,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class18$Model = "Elastic Net SVM"
remove(total_list)


#NB SVM
total_list <- lapply(mget(ls(pattern = 'nb.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class19 = melt(total_list)
tme_class19$Var2 = rep(metric_name,10)
tme_class19$Var1 = "TME"
tme_class19 = summarySE(tme_class19, measurevar=c("value") , groupvars=c("Var1","Var2"))
tme_class19 = dplyr::select(tme_class19, -c("N","se", "ci"))
tme_class19 = reshape(tme_class19,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class19$Model = "NB SVM"
remove(total_list)

#RF SVM
total_list <- lapply(mget(ls(pattern = 'rf.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class20 = melt(total_list)
tme_class20$Var2 = rep(metric_name,10)
tme_class20$Var1 = "TME"
tme_class20 = summarySE(tme_class20, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class20 = dplyr::select(tme_class20, -c("N","se", "ci"))
tme_class20 = reshape(tme_class20,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class20$Model = "RF SVM"
remove(total_list)


#GBM SVM
total_list <- lapply(mget(ls(pattern = 'gbm.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class21 = melt(total_list)
tme_class21$Var2 = rep(metric_name,10)
tme_class21$Var1 = "TME"
tme_class21 = summarySE(tme_class21, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class21 = dplyr::select(tme_class21, -c("N","se", "ci"))
tme_class21 = reshape(tme_class21,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class21$Model = "GBM SVM"
remove(total_list)

#KNN SVM
total_list <- lapply(mget(ls(pattern = 'knn.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class22 = melt(total_list)
tme_class22$Var2 = rep(metric_name,10)
tme_class22$Var1 = "TME"
tme_class22 = summarySE(tme_class22, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class22 = dplyr::select(tme_class22, -c("N","se", "ci"))
tme_class22 = reshape(tme_class22,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class22$Model = "KNN SVM"
remove(total_list)

#SVM SVM
total_list <- lapply(mget(ls(pattern = 'svm.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class23 = melt(total_list)
tme_class23$Var2 = rep(metric_name,10)
tme_class23$Var1 = "TME"
tme_class23 = summarySE(tme_class23, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class23 = dplyr::select(tme_class23, -c("N","se", "ci"))
tme_class23 = reshape(tme_class23,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class23$Model = "SVM SVM"
remove(total_list)

#NNET GBM
total_list <- lapply(mget(ls(pattern = 'nnet.svm.tme\\d+')), function(x) {
         data <- x$byClass})
tme_class24 = melt(total_list)
tme_class24$Var2 = rep(metric_name,10)
tme_class24$Var1 = "TME"
tme_class24 = summarySE(tme_class24, measurevar=c("value") , groupvars=c("Var1", "Var2"))
tme_class24 = dplyr::select(tme_class24, -c("N","se", "ci"))
tme_class24 = reshape(tme_class24,
           idvar = "Var1",
           timevar = "Var2",
           direction = "wide")
tme_class24$Model = "NNET SVM"
remove(total_list)
```

```{r}
total_list <- mget(ls(pattern = 'tme_class\\d+'))
compile_tme_class_svm = do.call(rbind, total_list)
```

#Export data dataframe
```{r}
write.csv(compile_tme_class_svm,file = "compile_tme_class_svm.csv")
```


```{r}
total_list <- mget(ls(pattern = 'tme_class\\d+'))
compile_tme_class = do.call(rbind, total_list)
```

#Export data dataframe elastic net and gbm
```{r}
write.csv(compile_tme_class,file = "compile_tme_class.csv")
```





